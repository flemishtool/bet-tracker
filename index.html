<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bet Tracker">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="description" content="21-Day Betting Challenge Tracker">
    <title>21-Day Betting Challenge</title>
    
    <link rel="manifest" id="pwa-manifest">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent-green: #00d4aa;
            --accent-orange: #ff9f43;
            --accent-red: #ff6b6b;
            --accent-blue: #54a0ff;
            --accent-purple: #a55eea;
            --accent-yellow: #feca57;
            --accent-cyan: #00cec9;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-muted: #6c6c8a;
            --border-color: #2d2d4a;
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8ecf1;
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a7a;
            --text-muted: #8a8aa8;
            --border-color: #d0d5dd;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 12px;
            padding-bottom: 80px;
            overflow-x: hidden;
        }

        .betslip-sidebar {
            width: 340px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            padding: 12px;
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 50;
            display: none;
        }

        @media (min-width: 1200px) {
            .main-content {
                margin-right: 340px;
                padding-bottom: 20px;
            }
            .betslip-sidebar {
                display: block;
            }
            .betslip-mobile-toggle,
            .betslip-mobile-panel {
                display: none !important;
            }
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.online {
            background: var(--accent-green);
        }

        .status-dot.connecting {
            background: var(--accent-orange);
            animation: pulse 1s infinite;
        }

        .status-dot.offline {
            background: var(--accent-red);
        }

        .theme-toggle,
        .install-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .theme-toggle:hover,
        .install-btn:hover {
            border-color: var(--accent-blue);
        }

        .header-stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header-stat {
            text-align: center;
        }

        .header-stat-value {
            font-size: 1rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .header-stat-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Quick Stats */
        .quick-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .quick-stats::-webkit-scrollbar {
            height: 4px;
        }

        .quick-stats::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 2px;
        }

        .quick-stat {
            background: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 90px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .quick-stat:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }

        .quick-stat-value {
            font-size: 1rem;
            font-weight: bold;
        }

        .quick-stat-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 3px;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 12px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 8px;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .card.full-width {
            grid-column: 1 / -1;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .filter-input,
        .filter-select,
        .date-input {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.75rem;
        }

        .filter-input:focus,
        .filter-select:focus,
        .date-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        [data-theme="light"] .date-input::-webkit-calendar-picker-indicator {
            filter: none;
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 12px;
        }

        .tabs {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
        }

        .tabs::-webkit-scrollbar {
            height: 3px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 2px;
        }

        .tab {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.7rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-green);
            color: var(--bg-primary);
            border-color: var(--accent-green);
        }

        /* Fixtures */
        .fixtures-container {
            max-height: 550px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .fixture-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .fixture-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .fixture-card.has-selection {
            border-color: var(--accent-orange);
            background: rgba(255, 159, 67, 0.08);
        }

        .fixture-card.live {
            border-color: var(--accent-red);
            animation: livePulse 2s infinite;
        }

        @keyframes livePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(255, 107, 107, 0); }
        }

        .fixture-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .fixture-league {
            font-size: 0.65rem;
            color: var(--accent-blue);
            font-weight: 600;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .fixture-time {
            font-size: 0.7rem;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .fixture-time.live {
            background: var(--accent-red);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .fixture-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .fixture-team {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .fixture-team.away {
            flex-direction: row-reverse;
            text-align: right;
        }

        .team-logo {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            object-fit: contain;
            background: var(--bg-secondary);
            padding: 2px;
            flex-shrink: 0;
        }

        .team-name {
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fixture-score {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 0 15px;
            color: var(--accent-green);
        }

        .fixture-vs {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 0 15px;
            flex-shrink: 0;
        }

        /* Odds */
        .odds-section {
            margin-top: 8px;
        }

        .odds-section-title {
            font-size: 0.55rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .odds-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
        }

        .odds-grid.grid-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        .odds-grid.grid-4 {
            grid-template-columns: repeat(4, 1fr);
        }

        .odds-grid.grid-5 {
    grid-template-columns: repeat(5, 1fr);
}

.odds-grid.grid-6 {
    grid-template-columns: repeat(6, 1fr);
}

@media (max-width: 500px) {
    .odds-grid.grid-5 {
        grid-template-columns: repeat(3, 1fr);
    }
    .odds-grid.grid-6 {
        grid-template-columns: repeat(3, 1fr);
    }
}

        .odd-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .odd-btn:hover {
            border-color: var(--accent-green);
            background: rgba(0, 212, 170, 0.1);
        }

        .odd-btn.selected {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: var(--bg-primary);
        }

        .odd-label {
            font-size: 0.5rem;
            color: var(--text-secondary);
            margin-bottom: 1px;
        }

        .odd-btn.selected .odd-label {
            color: var(--bg-primary);
        }

        .odd-value {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .bookmaker-tag {
            font-size: 0.5rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 6px;
        }

        .load-odds-btn {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .load-odds-btn:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }
    </style>
</head>
<body>
    <style>
        /* Betslip Styles */
        .betslip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--accent-green);
        }

        .betslip-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .betslip-count-badge {
            background: var(--accent-green);
            color: var(--bg-primary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .betslip-clear {
            color: var(--accent-red);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .betslip-clear:hover {
            opacity: 0.7;
        }

        .betslip-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .betslip-empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .betslip-legs {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .betslip-leg {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .betslip-leg-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent-red);
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            color: white;
            cursor: pointer;
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .betslip-leg-match {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
            padding-right: 20px;
        }

        .betslip-leg-selection {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .betslip-leg-odds-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .betslip-leg-odds-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .betslip-leg-odds-input {
            width: 60px;
            padding: 3px 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--accent-green);
            font-weight: bold;
            font-size: 0.8rem;
            text-align: center;
        }

        .betslip-leg-league {
            font-size: 0.55rem;
            color: var(--text-muted);
            margin-top: 3px;
        }

        .betslip-summary {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
        }

        .betslip-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.8rem;
        }

        .betslip-row:last-child {
            margin-bottom: 0;
        }

        .betslip-row.total {
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .betslip-stake-input {
            width: 90px;
            padding: 6px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            text-align: right;
        }

        .stake-presets {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .stake-preset {
            flex: 1;
            padding: 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.6rem;
            cursor: pointer;
            text-align: center;
        }

        .stake-preset:hover {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .confidence-selector {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .confidence-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .confidence-options {
            display: flex;
            gap: 5px;
        }

        .confidence-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.65rem;
            cursor: pointer;
            text-align: center;
        }

        .confidence-btn.active.low {
            border-color: var(--accent-red);
            color: var(--accent-red);
            background: rgba(255, 107, 107, 0.1);
        }

        .confidence-btn.active.medium {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
            background: rgba(255, 159, 67, 0.1);
        }

        .confidence-btn.active.high {
            border-color: var(--accent-green);
            color: var(--accent-green);
            background: rgba(0, 212, 170, 0.1);
        }

        .betslip-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 10px;
        }

        .betslip-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .betslip-mobile-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white;
            border: none;
            border-radius: 30px;
            padding: 12px 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.4);
            font-size: 0.85rem;
        }

        .betslip-mobile-toggle .count {
            background: white;
            color: var(--bg-primary);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .betslip-mobile-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--accent-green);
            padding: 15px;
            z-index: 99;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 75vh;
            overflow-y: auto;
            border-radius: 20px 20px 0 0;
        }

        .betslip-mobile-panel.open {
            transform: translateY(0);
        }

        /* Progress */
        .progress-container {
            margin-bottom: 15px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .progress-value {
            font-size: 0.85rem;
            font-weight: bold;
            color: var(--accent-green);
        }

        .progress-bar {
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 45px;
            transition: width 0.5s;
        }

        /* Streak */
        .streak-container {
            margin: 15px 0;
        }

        .streak-grid {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .streak-day {
            width: 26px;
            height: 26px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .streak-day:hover {
            transform: scale(1.15);
        }

        .streak-won {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .streak-lost {
            background: var(--accent-red);
            color: white;
        }

        .streak-void {
            background: var(--text-muted);
            color: var(--bg-primary);
        }

        .streak-pending {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border: 1px dashed var(--border-color);
        }

        .streak-current {
            border: 2px solid white !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metric-box {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .metric-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Strategy */
        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .strategy-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .strategy-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .strategy-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 3px;
        }

        .strategy-recommendation {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(84, 160, 255, 0.1));
            border: 1px solid var(--accent-green);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .strategy-recommendation-title {
            font-size: 0.7rem;
            color: var(--accent-green);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .strategy-recommendation-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Milestones */
        .milestones-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .milestone-item.reached {
            background: rgba(0, 212, 170, 0.15);
            border: 1px solid var(--accent-green);
        }

        .milestone-item.next {
            border: 1px dashed var(--accent-orange);
        }

        .milestone-check {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .milestone-check.pending {
            background: var(--bg-secondary);
            color: var(--text-muted);
            border: 1px dashed var(--border-color);
        }

        .milestone-check.reached {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .milestone-info {
            flex: 1;
        }

        .milestone-amount {
            font-weight: bold;
            font-size: 0.85rem;
        }

        .milestone-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        .milestone-progress {
            font-size: 0.55rem;
            color: var(--accent-orange);
        }

        /* Targets */
        .targets-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 200px;
            overflow-y: auto;
        }

        .target-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        .target-row.current {
            border: 1px solid var(--accent-orange);
            background: rgba(255, 159, 67, 0.1);
        }

        .target-row.achieved {
            opacity: 0.6;
        }

        .target-day {
            font-weight: 600;
        }

        .target-amount {
            color: var(--accent-green);
            font-weight: bold;
        }

        .target-status {
            font-size: 0.65rem;
        }

        /* Probability */
        .probability-display {
            text-align: center;
            padding: 15px;
        }

        .probability-value {
            font-size: 2.2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .probability-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .probability-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .probability-stat {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .probability-stat-value {
            font-size: 0.95rem;
            font-weight: bold;
        }

        .probability-stat-label {
            font-size: 0.5rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        /* Risk */
        .risk-container {
            margin-top: 12px;
        }

        .risk-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .risk-bar {
            height: 8px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-yellow), var(--accent-orange), var(--accent-red));
            border-radius: 4px;
            position: relative;
        }

        .risk-indicator {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
            transform: translateX(-50%);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            transition: left 0.3s;
        }

        .risk-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.5rem;
            color: var(--text-muted);
        }

        /* Analytics */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .analytics-item {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 8px;
        }

        .analytics-label {
            font-size: 0.55rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 3px;
        }

        .analytics-value {
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Market Stats */
        .market-stats {
            margin-top: 12px;
        }

        .market-stat-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.65rem;
        }

        .market-stat-row:last-child {
            border-bottom: none;
        }

        .market-stat-name {
            flex: 1;
        }

        .market-stat-bar {
            flex: 2;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
        }

        .market-stat-fill {
            height: 100%;
            border-radius: 3px;
        }

        .market-stat-value {
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        /* Day Performance */
        .day-performance {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 70px;
            gap: 3px;
            margin-top: 12px;
        }

        .day-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .day-bar {
            width: 100%;
            background: var(--bg-secondary);
            border-radius: 2px;
            position: relative;
            min-height: 3px;
        }

        .day-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            border-radius: 2px;
            transition: height 0.3s;
        }

        .day-bar-label {
            font-size: 0.4rem;
            color: var(--text-muted);
        }

        /* Pending Bets */
        .pending-bet {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .pending-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .pending-legs {
            margin-bottom: 8px;
        }

        .pending-leg {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.7rem;
        }

        .pending-leg:last-child {
            border-bottom: none;
        }

        .pending-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        /* Smart Recommendations */
        .smart-bet {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-green);
            transition: all 0.3s;
        }
        
        .smart-bet:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .smart-bet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .smart-bet-odds {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--accent-green);
        }
        
        .smart-bet-confidence {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .smart-bet-confidence.high { 
            background: rgba(0,212,170,0.2); 
            color: var(--accent-green); 
        }
        
        .smart-bet-confidence.medium { 
            background: rgba(255,159,67,0.2); 
            color: var(--accent-orange); 
        }
        
        .smart-bet-confidence.low { 
            background: rgba(255,107,107,0.2); 
            color: var(--accent-red); 
        }
        
        .smart-bet-legs {
            font-size: 0.8rem;
            margin: 8px 0;
        }
        
        .smart-bet-leg {
            padding: 4px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .smart-bet-leg:last-child {
            border-bottom: none;
        }
        
        .smart-bet-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* Buttons */
        .btn {
            padding: 7px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-success {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .btn-danger {
            background: var(--accent-red);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.7rem;
        }

        .btn-group {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            max-height: 350px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px 6px;
            text-align: left;
            font-size: 0.65rem;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-size: 0.55rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        tr:hover {
            background: rgba(84, 160, 255, 0.05);
        }

        /* Badges */
        .badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.55rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pending {
            background: rgba(255, 159, 67, 0.2);
            color: var(--accent-orange);
        }

        .badge-won {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-green);
        }

        .badge-lost {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
        }

        .badge-void {
            background: rgba(160, 160, 184, 0.2);
            color: var(--text-secondary);
        }

        .badge-confidence {
            font-size: 0.5rem;
            padding: 2px 6px;
        }

        .badge-confidence.low {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-red);
        }

        .badge-confidence.medium {
            background: rgba(255, 159, 67, 0.2);
            color: var(--accent-orange);
        }

        .badge-confidence.high {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent-green);
        }

        /* Chart */
        .chart-container {
            height: 180px;
            position: relative;
        }

        /* Colors */
        .green { color: var(--accent-green); }
        .red { color: var(--accent-red); }
        .orange { color: var(--accent-orange); }
        .blue { color: var(--accent-blue); }
        .purple { color: var(--accent-purple); }
        .yellow { color: var(--accent-yellow); }
        .cyan { color: var(--accent-cyan); }
        .text-muted { color: var(--text-muted); }
        .mt-1 { margin-top: 8px; }
        .mb-1 { margin-bottom: 8px; }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 25px 15px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 0.8rem;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            padding: 12px 16px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 300;
            font-size: 0.8rem;
            text-align: center;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .notification-success { background: linear-gradient(135deg, var(--accent-green), #00b894); color: var(--bg-primary); }
        .notification-error { background: linear-gradient(135deg, var(--accent-red), #e84343); }
        .notification-warning { background: linear-gradient(135deg, var(--accent-orange), #e67e22); color: var(--bg-primary); }
        .notification-info { background: linear-gradient(135deg, var(--accent-blue), #3498db); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .header-left { flex-direction: column; }
            .filters-bar { flex-direction: column; align-items: stretch; }
            .filter-group { justify-content: space-between; }
            .grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 500px) {
            .odds-grid.grid-4 { grid-template-columns: repeat(3, 1fr); }
            .odds-grid.grid-6 { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
	<div class="app-container">
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>ðŸŽ¯ 21-Day Betting Challenge</h1>
                <div class="header-controls">
                    <div class="status-badge" onclick="showApiStatus()" title="Click for API status">
                        <div class="status-dot connecting" id="firebaseDot"></div>
                        <span id="firebaseText">Connecting...</span>
                    </div>
                    <div class="status-badge">
                        <div class="status-dot" id="apiDot"></div>
                        <span id="apiText">API</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">ðŸŒ™</button>
                    <button class="install-btn" onclick="installPWA()" id="installBtn" style="display:none" title="Install app">ðŸ“²</button>
                </div>
            </div>
            <div class="header-stats">
                <div class="header-stat"><div class="header-stat-value" id="hDay">Day 3</div><div class="header-stat-label">Current Day</div></div>
                <div class="header-stat"><div class="header-stat-value" id="hBalance">Â£384.42</div><div class="header-stat-label">Balance</div></div>
                <div class="header-stat"><div class="header-stat-value green" id="hWinRate">100%</div><div class="header-stat-label">Win Rate</div></div>
                <div class="header-stat"><div class="header-stat-value" id="hStatus">ðŸŸ¢</div><div class="header-stat-label">Status</div></div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="quick-stat"><div class="quick-stat-value green" id="qProfit">Â£184.42</div><div class="quick-stat-label">Profit</div></div>
            <div class="quick-stat"><div class="quick-stat-value blue" id="qTarget">Â£345.60</div><div class="quick-stat-label">Day 3 Target</div></div>
            <div class="quick-stat"><div class="quick-stat-value orange" id="qVsTarget">+Â£38.82</div><div class="quick-stat-label">vs Target</div></div>
            <div class="quick-stat"><div class="quick-stat-value purple" id="qAvgOdds">1.39</div><div class="quick-stat-label">Avg Odds</div></div>
            <div class="quick-stat"><div class="quick-stat-value" id="qDaysLeft">19</div><div class="quick-stat-label">Days Left</div></div>
            <div class="quick-stat"><div class="quick-stat-value yellow" id="qROI">92.2%</div><div class="quick-stat-label">ROI</div></div>
            <div class="quick-stat"><div class="quick-stat-value cyan" id="qNextTarget">Â£461.30</div><div class="quick-stat-label">Next Target</div></div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Fixtures Card -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">âš½ Fixtures</span>
                    <div class="card-actions">
                        <span class="text-muted" id="fixtureCount">0 fixtures</span>
                        <button class="btn btn-sm btn-secondary" onclick="refreshFixtures()">ðŸ”„ Refresh</button>
                    </div>
                </div>
                
                <div class="filters-bar">
                    <div class="filter-group">
                        <span class="filter-label">Date:</span>
                        <input type="date" class="date-input" id="dateFilter">
                        <button class="btn btn-sm btn-primary" onclick="loadFixturesForDate()">Go</button>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Status:</span>
                        <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                            <option value="all">All</option>
                            <option value="upcoming" selected>Upcoming</option>
                            <option value="live">Live</option>
                            <option value="finished">Finished</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Odds:</span>
                        <input type="number" class="filter-input" id="minOddsFilter" placeholder="Min" step="0.1" min="1" style="width:55px" onchange="applyFilters()">
                        <span>-</span>
                        <input type="number" class="filter-input" id="maxOddsFilter" placeholder="Max" step="0.1" min="1" style="width:55px" onchange="applyFilters()">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Sort:</span>
                        <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                            <option value="time">Kick-off</option>
                            <option value="oddsLow">Odds â†‘</option>
                            <option value="oddsHigh">Odds â†“</option>
                            <option value="league">League</option>
                        </select>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="clearFilters()">Clear</button>
                </div>

                <div class="tabs-container"><div class="tabs" id="leagueTabs"></div></div>
                <div class="fixtures-container" id="fixturesContainer"><div class="loading"><div class="spinner"></div></div></div>
            </div>

            <!-- Challenge Progress -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸ“ˆ Challenge Progress</span></div>
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-label">Progress to Â£9,201.82</span>
                        <span class="progress-value" id="progressPercent">4.2%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 4.2%">4.2%</div></div>
                </div>
                <div class="streak-container"><div class="streak-grid" id="streakDisplay"></div></div>
                <div class="metrics-grid">
                    <div class="metric-box"><div class="metric-value green" id="mWins">2</div><div class="metric-label">Wins</div></div>
                    <div class="metric-box"><div class="metric-value red" id="mLosses">0</div><div class="metric-label">Losses</div></div>
                    <div class="metric-box"><div class="metric-value blue" id="mBestDay">Day 2</div><div class="metric-label">Best Day</div></div>
                    <div class="metric-box"><div class="metric-value orange" id="mStreak">2</div><div class="metric-label">Streak</div></div>
		            <div class="card">
						<div class="card-header">
						<span class="card-title">ðŸ¤– Smart Recommendations</span>
						<button class="btn btn-sm btn-primary" onclick="generateSmartBets()">ðŸ”„ Generate</button>
                </div>
                <div class="smart-bets-container" id="smartBetsContainer">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Challenge Progress -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸ“ˆ Challenge Progress</span></div>
                <div class="progress-container">
                    <div class="progress-header">
                        <span class="progress-label">Progress to Â£9,201.82</span>
                        <span class="progress-value" id="progressPercent">4.2%</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 4.2%">4.2%</div></div>
                </div>
                <div class="streak-container"><div class="streak-grid" id="streakDisplay"></div></div>
                <div class="metrics-grid">
                    <div class="metric-box"><div class="metric-value green" id="mWins">2</div><div class="metric-label">Wins</div></div>
                    <div class="metric-box"><div class="metric-value red" id="mLosses">0</div><div class="metric-label">Losses</div></div>
                    <div class="metric-box"><div class="metric-value blue" id="mBestDay">Day 2</div><div class="metric-label">Best Day</div></div>
                    <div class="metric-box"><div class="metric-value orange" id="mStreak">2</div><div class="metric-label">Win Streak</div></div>
                </div>
            </div>

            <!-- Pending Bets -->
            <div class="card">
                <div class="card-header"><span class="card-title">â³ Pending Bets</span></div>
                <div id="pendingBetsContainer"><div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><p>No pending bets</p></div></div>
            </div>

            <!-- Strategy Card -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸŽ¯ Today's Strategy</span></div>
                <div class="strategy-grid">
                    <div class="strategy-item"><div class="strategy-value green" id="stratStake">Â£384.42</div><div class="strategy-label">Stake Today</div></div>
                    <div class="strategy-item"><div class="strategy-value blue" id="stratMinOdds">1.20</div><div class="strategy-label">Min Odds Needed</div></div>
                    <div class="strategy-item"><div class="strategy-value orange" id="stratTarget">Â£461.30</div><div class="strategy-label">Target Balance</div></div>
                    <div class="strategy-item"><div class="strategy-value purple" id="stratMinProfit">Â£76.88</div><div class="strategy-label">Min Profit Needed</div></div>
                </div>
                <div class="strategy-recommendation">
                    <div class="strategy-recommendation-title">ðŸ’¡ Recommended Approach</div>
                    <div class="strategy-recommendation-text" id="strategyText">Look for safe picks around 1.25-1.35 odds. Focus on home wins for strong teams or Over 1.5 goals.</div>
                </div>
            </div>

            <!-- Milestones -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸ† Milestones</span></div>
                <div class="milestones-list" id="milestonesList"></div>
            </div>

            <!-- Targets Card -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸŽ¯ Daily Targets</span></div>
                <div class="targets-list" id="targetsList"></div>
            </div>

            <!-- Success Probability -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸ“Š Success Probability</span></div>
                <div class="probability-display">
                    <div class="probability-value" id="successProb">2.8%</div>
                    <div class="probability-label">Estimated chance of completing challenge</div>
                </div>
                <div class="probability-stats">
                    <div class="probability-stat"><div class="probability-stat-value" id="betsRemaining">19</div><div class="probability-stat-label">Bets Left</div></div>
                    <div class="probability-stat"><div class="probability-stat-value" id="requiredWinRate">100%</div><div class="probability-stat-label">Wins Needed</div></div>
                    <div class="probability-stat"><div class="probability-stat-value" id="impliedProb">83.3%</div><div class="probability-stat-label">Implied @ 1.20</div></div>
                    <div class="probability-stat"><div class="probability-stat-value" id="kellyStake">Full</div><div class="probability-stat-label">Kelly Suggest</div></div>
                </div>
                <div class="risk-container">
                    <div class="risk-label">Risk Level</div>
                    <div class="risk-bar"><div class="risk-indicator" id="riskIndicator" style="left: 70%"></div></div>
                    <div class="risk-labels"><span>Low</span><span>Medium</span><span>High</span><span>Extreme</span></div>
                </div>
            </div>

            <!-- Enhanced Analytics -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸ“Š Advanced Analytics</span></div>
                <div class="analytics-grid">
                    <div class="analytics-item"><div class="analytics-label">Total ROI</div><div class="analytics-value green" id="analyticsROI">92.2%</div></div>
                    <div class="analytics-item"><div class="analytics-label">Avg Stake</div><div class="analytics-value" id="analyticsAvgStake">Â£228.57</div></div>
                    <div class="analytics-item"><div class="analytics-label">Sharpe Ratio</div><div class="analytics-value" id="sharpeRatio">0.00</div></div>
                    <div class="analytics-item"><div class="analytics-label">Kelly Fraction</div><div class="analytics-value" id="kellyFraction">25%</div></div>
                    <div class="analytics-item"><div class="analytics-label">Value Index</div><div class="analytics-value" id="valueIndex">0.00</div></div>
                    <div class="analytics-item"><div class="analytics-label">Optimal Odds</div><div class="analytics-value" id="analyticsOptOdds">1.20-1.50</div></div>
                </div>
                <div class="market-stats" id="marketStats"></div>
                <div class="day-performance" id="dayPerformance"></div>
            </div>

            <!-- Balance Chart -->
            <div class="card">
                <div class="card-header"><span class="card-title">ðŸ“ˆ Balance Chart</span></div>
                <div class="chart-container"><canvas id="balanceChart"></canvas></div>
            </div>

            <!-- Bet History -->
            <div class="card full-width">
                <div class="card-header">
                    <span class="card-title">ðŸ“œ Bet History</span>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" onclick="exportData()">ðŸ“¤ Export</button>
                        <button class="btn btn-sm btn-secondary" onclick="document.getElementById('importFile').click()">ðŸ“¥ Import</button>
                        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                        <button class="btn btn-sm btn-danger" onclick="resetData()">ðŸ—‘ï¸ Reset</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Day</th><th>Date</th><th>Selection</th><th>Type</th><th>Conf</th><th>Odds</th><th>Stake</th><th>Result</th><th>Returns</th><th>Balance</th><th>vs Target</th></tr></thead>
                        <tbody id="historyTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Betslip Sidebar -->
    <div class="betslip-sidebar">
        <div class="betslip-header">
            <span class="betslip-title">ðŸŽ« Betslip <span class="betslip-count-badge" id="desktopSlipCount">0</span></span>
            <span class="betslip-clear" onclick="clearBetslip()">Clear All</span>
        </div>
        <div id="desktopBetslipContent"></div>
    </div>
</div>

<!-- Mobile Betslip Toggle -->
<button class="betslip-mobile-toggle" onclick="toggleMobileBetslip()">ðŸŽ« Betslip <span class="count" id="mobileSlipCount">0</span></button>

<!-- Mobile Betslip Panel -->
<div class="betslip-mobile-panel" id="mobileBetslipPanel">
    <div class="betslip-header">
        <span class="betslip-title">ðŸŽ« Betslip <span class="betslip-count-badge" id="mobileSlipCountInner">0</span></span>
        <span class="betslip-clear" onclick="clearBetslip()">Clear All</span>
    </div>
    <div id="mobileBetslipContent"></div>
</div>

<!-- Result Modal -->
<div class="modal-overlay" id="resultModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">Record Result</span>
            <button class="modal-close" onclick="closeResultModal()">&times;</button>
        </div>
        <div id="modalBetDetails"></div>
        <div class="form-group">
            <label class="form-label">Final Score(s)</label>
            <input type="text" class="form-input" id="modalFinalScore" placeholder="e.g., 2-1 or 3-0, 2-1">
        </div>
        <div class="btn-group">
            <button class="btn btn-success" onclick="recordResult('won')">âœ… Won</button>
            <button class="btn btn-danger" onclick="recordResult('lost')">âŒ Lost</button>
        </div>
        <button class="btn btn-secondary mt-1" onclick="recordResult('void')" style="width:100%">âšª Void (Stake Returned)</button>
    </div>
</div>

<!-- API Status Modal -->
<div class="modal-overlay" id="apiModal">
    <div class="modal">
        <div class="modal-header">
            <span class="modal-title">ðŸ“¡ API & Sync Status</span>
            <button class="modal-close" onclick="closeApiStatus()">&times;</button>
        </div>
        <div style="padding: 10px 0;">
            <div style="margin-bottom: 15px;">
                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 5px;">FIREBASE SYNC</div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                    <span>Status</span>
                    <span id="apiModalFirebase">Checking...</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 4px;">
                    <span>User ID</span>
                    <span id="apiModalUserId" style="font-size: 0.65rem;">-</span>
                </div>
            </div>
            <div>
                <div style="font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 5px;">API-FOOTBALL</div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                    <span>Fixtures Loaded</span>
                    <span id="apiModalFixtures">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-top: 4px;">
                    <span>Odds Cached</span>
                    <span id="apiModalOdds">0</span>
                </div>
            </div>
        </div>
        <button class="btn btn-primary mt-1" onclick="testApiConnection()" style="width:100%">ðŸ”„ Test API Connection</button>
    </div>
</div>
<script>
// ============================================================
// PWA MANIFEST (Inline)
// ============================================================
const pwaManifest = {
    name: "21-Day Betting Challenge",
    short_name: "Bet Tracker",
    description: "Track your 21-day compound betting challenge",
    start_url: ".",
    display: "standalone",
    background_color: "#0f0f1a",
    theme_color: "#00d4aa",
    icons: [{ src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>", sizes: "any", type: "image/svg+xml" }]
};
const manifestBlob = new Blob([JSON.stringify(pwaManifest)], { type: 'application/json' });
document.getElementById('pwa-manifest').href = URL.createObjectURL(manifestBlob);

// ============================================================
// CONFIGURATION
// ============================================================
const firebaseConfig = {
    apiKey: "AIzaSyD-MH_oSRLM53UHe2sPB4bXRjsEcXEm9IM",
    authDomain: "bet-tracker-d819b.firebaseapp.com",
    databaseURL: "https://bet-tracker-d819b-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "bet-tracker-d819b",
    storageBucket: "bet-tracker-d819b.firebasestorage.app",
    messagingSenderId: "556598232550",
    appId: "1:556598232550:web:2921e82966b16bf7520227"
};

const API_KEY = '89d2f65b7dc64f8d0fce8468e2a8af2b';
const API_BASE = 'https://v3.football.api-sports.io';
const INITIAL_BALANCE = 200;
const DAILY_MULTIPLIER = 1.20;
const TARGET_DAYS = 21;
const FINAL_TARGET = INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, TARGET_DAYS);

const MILESTONES = [
    { amount: 250, label: 'First Profit', emoji: 'ðŸŒ±' },
    { amount: 500, label: 'Half Way to 1K', emoji: 'ðŸ’«' },
    { amount: 1000, label: '1K Club', emoji: 'ðŸŽ¯' },
    { amount: 2000, label: 'Double Grand', emoji: 'ðŸ”¥' },
    { amount: 3000, label: 'Triple Threat', emoji: 'âš¡' },
    { amount: 5000, label: '5K Milestone', emoji: 'ðŸš€' },
    { amount: 7500, label: 'Almost There', emoji: 'ðŸŒŸ' },
    { amount: 9201.82, label: 'Challenge Complete!', emoji: 'ðŸ†' }
];

const LEAGUES = {
    39: { name: 'Premier League', short: 'EPL', flag: 'ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿', priority: 1 },
    40: { name: 'Championship', short: 'Champ', flag: 'ðŸ´ó §ó ¢ó ¥ó ®ó §ó ¿', priority: 6 },
    45: { name: 'FA Cup', short: 'FA Cup', flag: 'ðŸ†', priority: 25 },
    48: { name: 'EFL Cup', short: 'EFL', flag: 'ðŸ†', priority: 26 },
    140: { name: 'La Liga', short: 'LaLiga', flag: 'ðŸ‡ªðŸ‡¸', priority: 2 },
    143: { name: 'Copa del Rey', short: 'Copa', flag: 'ðŸ†', priority: 27 },
    78: { name: 'Bundesliga', short: 'Bund', flag: 'ðŸ‡©ðŸ‡ª', priority: 3 },
    81: { name: 'DFB Pokal', short: 'DFB', flag: 'ðŸ†', priority: 28 },
    135: { name: 'Serie A', short: 'SerieA', flag: 'ðŸ‡®ðŸ‡¹', priority: 4 },
    137: { name: 'Coppa Italia', short: 'CoppaIT', flag: 'ðŸ†', priority: 29 },
    61: { name: 'Ligue 1', short: 'Ligue1', flag: 'ðŸ‡«ðŸ‡·', priority: 5 },
    66: { name: 'Coupe de France', short: 'CdF', flag: 'ðŸ†', priority: 30 },
    94: { name: 'Primeira Liga', short: 'Portugal', flag: 'ðŸ‡µðŸ‡¹', priority: 11 },
    88: { name: 'Eredivisie', short: 'Erediv', flag: 'ðŸ‡³ðŸ‡±', priority: 12 },
    144: { name: 'Jupiler Pro', short: 'Belgium', flag: 'ðŸ‡§ðŸ‡ª', priority: 13 },
    203: { name: 'SÃ¼per Lig', short: 'Turkey', flag: 'ðŸ‡¹ðŸ‡·', priority: 14 },
    179: { name: 'Premiership', short: 'Scotland', flag: 'ðŸ´ó §ó ¢ó ³ó £ó ´ó ¿', priority: 15 },
    307: { name: 'Saudi Pro', short: 'Saudi', flag: 'ðŸ‡¸ðŸ‡¦', priority: 22 },
    2: { name: 'Champions League', short: 'UCL', flag: 'ðŸ†', priority: 40 },
    3: { name: 'Europa League', short: 'UEL', flag: 'ðŸ†', priority: 41 },
    848: { name: 'Conference League', short: 'UECL', flag: 'ðŸ†', priority: 42 }
};

const FETCH_LEAGUES = [39, 140, 78, 135, 61, 48, 45, 143, 81, 137, 2, 3, 848, 40, 94, 88, 144, 203, 179, 307, 66];

const MARKET_TYPES = {
    // Match Result
    home: 'Home Win',
    draw: 'Draw',
    away: 'Away Win',
    
    // Double Chance
    homeOrDraw: '1X',
    awayOrDraw: 'X2',
    homeOrAway: '12',
    
    // Draw No Bet
    dnbHome: 'DNB Home',
    dnbAway: 'DNB Away',
    
    // Goals Over/Under (Full Time)
    over05: 'Over 0.5',
    over15: 'Over 1.5',
    over25: 'Over 2.5',
    over35: 'Over 3.5',
    over45: 'Over 4.5',
    over55: 'Over 5.5',
    under05: 'Under 0.5',
    under15: 'Under 1.5',
    under25: 'Under 2.5',
    under35: 'Under 3.5',
    under45: 'Under 4.5',
    under55: 'Under 5.5',
    
    // Goals Over/Under (First Half)
    over05FH: 'O0.5 1H',
    over15FH: 'O1.5 1H',
    over25FH: 'O2.5 1H',
    under05FH: 'U0.5 1H',
    under15FH: 'U1.5 1H',
    under25FH: 'U2.5 1H',
    
    // Goals Over/Under (Second Half)
    over05SH: 'O0.5 2H',
    over15SH: 'O1.5 2H',
    over25SH: 'O2.5 2H',
    under05SH: 'U0.5 2H',
    under15SH: 'U1.5 2H',
    under25SH: 'U2.5 2H',
    
    // Both Teams to Score
    bttsYes: 'BTTS Yes',
    bttsNo: 'BTTS No',
    bttsFHYes: 'BTTS 1H Yes',
    bttsFHNo: 'BTTS 1H No',
    bttsSHYes: 'BTTS 2H Yes',
    bttsSHNo: 'BTTS 2H No',
    
    // Half Time Result
    htHome: 'HT Home',
    htDraw: 'HT Draw',
    htAway: 'HT Away',
    
    // Second Half Winner
    shHome: '2H Home',
    shDraw: '2H Draw',
    shAway: '2H Away',
    
    // Asian Handicap
    ahHome_minus05: 'AH Home -0.5',
    ahHome_minus1: 'AH Home -1',
    ahHome_minus15: 'AH Home -1.5',
    ahHome_minus2: 'AH Home -2',
    ahHome_minus25: 'AH Home -2.5',
    ahHome_plus05: 'AH Home +0.5',
    ahHome_plus1: 'AH Home +1',
    ahHome_plus15: 'AH Home +1.5',
    ahHome_plus2: 'AH Home +2',
    ahAway_minus05: 'AH Away -0.5',
    ahAway_minus1: 'AH Away -1',
    ahAway_minus15: 'AH Away -1.5',
    ahAway_minus2: 'AH Away -2',
    ahAway_minus25: 'AH Away -2.5',
    ahAway_plus05: 'AH Away +0.5',
    ahAway_plus1: 'AH Away +1',
    ahAway_plus15: 'AH Away +1.5',
    ahAway_plus2: 'AH Away +2',
    
    // Goal Line (Asian Total)
    gl_over15: 'GL O1.5',
    gl_under15: 'GL U1.5',
    gl_over25: 'GL O2.5',
    gl_under25: 'GL U2.5',
    gl_over35: 'GL O3.5',
    gl_under35: 'GL U3.5',
    
    // Odd/Even
    goalsOdd: 'Goals Odd',
    goalsEven: 'Goals Even',
    
    // Home Team Goals
    homeOver05: 'Home O0.5',
    homeOver15: 'Home O1.5',
    homeOver25: 'Home O2.5',
    homeUnder05: 'Home U0.5',
    homeUnder15: 'Home U1.5',
    homeUnder25: 'Home U2.5',
    
    // Away Team Goals
    awayOver05: 'Away O0.5',
    awayOver15: 'Away O1.5',
    awayOver25: 'Away O2.5',
    awayUnder05: 'Away U0.5',
    awayUnder15: 'Away U1.5',
    awayUnder25: 'Away U2.5',
    
    // Clean Sheet
    csHome: 'Home CS',
    csAway: 'Away CS',
    noCSHome: 'Home No CS',
    noCSAway: 'Away No CS',
    
    // Win to Nil
    wtnHome: 'Home WTN',
    wtnAway: 'Away WTN',
    
    // Score in Both Halves
    homeScoreBoth: 'Home Score Both',
    awayScoreBoth: 'Away Score Both',
    
    // Win Either Half
    homeWinEither: 'Home Win Either',
    awayWinEither: 'Away Win Either',
    
    // Corners Over/Under
    cornersOver75: 'Corners O7.5',
    cornersOver85: 'Corners O8.5',
    cornersOver95: 'Corners O9.5',
    cornersOver105: 'Corners O10.5',
    cornersUnder75: 'Corners U7.5',
    cornersUnder85: 'Corners U8.5',
    cornersUnder95: 'Corners U9.5',
    cornersUnder105: 'Corners U10.5',
    
    // Cards
    cardsOver25: 'Cards O2.5',
    cardsOver35: 'Cards O3.5',
    cardsOver45: 'Cards O4.5',
    cardsUnder25: 'Cards U2.5',
    cardsUnder35: 'Cards U3.5',
    cardsUnder45: 'Cards U4.5',
    
    // HT/FT
    htft_1_1: 'HT/FT 1/1',
    htft_1_X: 'HT/FT 1/X',
    htft_1_2: 'HT/FT 1/2',
    htft_X_1: 'HT/FT X/1',
    htft_X_X: 'HT/FT X/X',
    htft_X_2: 'HT/FT X/2',
    htft_2_1: 'HT/FT 2/1',
    htft_2_X: 'HT/FT 2/X',
    htft_2_2: 'HT/FT 2/2',
    
    // Exact Goals
    exactGoals0: 'Exact 0 Goals',
    exactGoals1: 'Exact 1 Goal',
    exactGoals2: 'Exact 2 Goals',
    exactGoals3: 'Exact 3 Goals',
    exactGoals4plus: 'Exact 4+ Goals',
    
    // Result & BTTS
    homeAndBttsYes: 'Home & BTTS Yes',
    homeAndBttsNo: 'Home & BTTS No',
    drawAndBttsYes: 'Draw & BTTS Yes',
    awayAndBttsYes: 'Away & BTTS Yes',
    awayAndBttsNo: 'Away & BTTS No',
    
    // Result & Over/Under
    homeAndOver15: 'Home & O1.5',
    homeAndOver25: 'Home & O2.5',
    drawAndOver15: 'Draw & O1.5',
    drawAndOver25: 'Draw & O2.5',
    awayAndOver15: 'Away & O1.5',
    awayAndOver25: 'Away & O2.5'
};

const PREFERRED_BOOKMAKERS = ['Coral', 'Bet365', 'Ladbrokes', 'William Hill', 'Paddy Power', 'Betfair', 'Pinnacle', '1xBet'];

// ============================================================
// ENHANCED CONFIGURATION
// ============================================================
const MARKET_SUCCESS_RATES = {
    'homeOrDraw': 0.82,
    'awayOrDraw': 0.81,
    'over05': 0.89,
    'over15': 0.68,
    'dnbHome': 0.73,
    'dnbAway': 0.72,
    'over05FH': 0.78,
    'bttsNo': 0.65,
    'home': 0.52,
    'away': 0.26,
    'draw': 0.22,
    'over25': 0.54,
    'bttsYes': 0.52
};

const TEAM_STRENGTH = {
    'Manchester City': 95, 'Liverpool': 92, 'Arsenal': 90, 'Chelsea': 88,
    'Real Madrid': 96, 'Barcelona': 93, 'Bayern Munich': 94, 'PSG': 91,
    'Manchester United': 85, 'Tottenham': 84, 'Aston Villa': 83, 'Newcastle': 82,
    'Borussia Dortmund': 86, 'RB Leipzig': 85, 'Bayer Leverkusen': 87, 'Atletico Madrid': 89,
    'Inter Milan': 88, 'AC Milan': 86, 'Juventus': 85, 'Napoli': 84,
    'Fenerbahce': 82, 'Galatasaray': 81, 'Besiktas': 80, 'Trabzonspor': 79
};

// ============================================================
// STATE
// ============================================================
let db = null;
let userId = null;
let isOnline = false;
let deferredPrompt = null;
let fixturesLoading = false;

let allFixtures = [];
let filteredFixtures = [];
let oddsCache = {};
let betslip = [];
let currentLeagueFilter = 'all';
let selectedBetId = null;
let selectedConfidence = 'medium';

let challengeData = {
    startDate: "2025-12-15",
    currentBalance: 503.59020000000004,
    bets: [
        {
            id: 1734291600001,
            date: "2025-12-15",
            type: "single",
            legs: [{ match: "Fenerbahce vs Konyaspor", selection: "Home Win", odds: 1.2857, league: "Turkish Super Lig", market: "home" }],
            selection: "Fenerbahce Win",
            competition: "Turkish Super Lig",
            odds: 1.2857,
            stake: 200,
            confidence: "high",
            status: "won",
            finalScore: "4-0",
            day: 1,
            returns: 257.14,
            balanceAfter: 257.14,
            targetForDay: 240,
            vsTarget: 17.14
        },
        {
            id: 1734378000002,
            date: "2025-12-16",
            type: "double",
            legs: [
                { match: "Cardiff City vs Chelsea", selection: "Away Win", odds: 1.30, league: "EFL Cup", market: "away" },
                { match: "CD Guadalajara vs Barcelona", selection: "Away Win", odds: 1.15, league: "Copa del Rey", market: "away" }
            ],
            selection: "Chelsea Win + Barcelona Win",
            competition: "EFL Cup / Copa del Rey",
            odds: 1.495,
            stake: 257.14,
            confidence: "high",
            status: "won",
            finalScore: "1-5, 0-4",
            day: 2,
            returns: 384.42,
            balanceAfter: 384.42,
            targetForDay: 288,
            vsTarget: 96.42
        },
        {
            id: 1765947790264,
            date: "2025-12-17",
            type: "double",
            legs: [
                { match: "Manchester City vs Brentford", selection: "Over 1.5", odds: 1.18, league: "EFL Cup", market: "over15" },
                { match: "CF Talavera vs Real Madrid", selection: "Over 0.5", odds: 1.11, league: "Copa del Rey", market: "over05" }
            ],
            selection: "Over 1.5 + Over 0.5",
            competition: "EFL Cup / Copa del Rey",
            odds: 1.31,
            stake: 384.42,
            confidence: "medium",
            status: "won",
            finalScore: "",
            day: 3,
            returns: 503.59020000000004,
            balanceAfter: 503.59020000000004,
            targetForDay: 345.59999999999997,
            vsTarget: 157.99020000000007
        }
    ],
    pendingBets: [],
    settings: { theme: 'dark' },
    lastUpdated: Date.now()
};

// ============================================================
// UTILITIES
// ============================================================
const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
const getToday = () => new Date().toISOString().split('T')[0];
const formatCurrency = amount => `Â£${amount.toFixed(2)}`;
const getTarget = day => INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, day);

function notify(message, type = 'info') {
    document.querySelectorAll('.notification').forEach(n => n.remove());
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 4000);
}

function escapeHtml(str) {
    return String(str).replace(/'/g, "\\'").replace(/"/g, '\\"');
}

// ============================================================
// ENHANCED UTILITIES
// ============================================================
function getTeamStrength(teamName) {
    return TEAM_STRENGTH[teamName] || 
           Object.keys(TEAM_STRENGTH).find(key => 
               teamName.toLowerCase().includes(key.toLowerCase()))?.value || 70;
}

function calculateAdjustedProbability(odds, market, league, homeTeamName, awayTeamName) {
    const baseProb = 1 / odds;
    const marketFactor = MARKET_SUCCESS_RATES[market] || 0.65;
    const homeStrength = getTeamStrength(homeTeamName);
    const awayStrength = getTeamStrength(awayTeamName);
    const strengthDiff = homeStrength - awayStrength;
    const strengthFactor = 1 + (strengthDiff * 0.1); // 10% adjustment per strength unit
    
    return Math.min(0.95, baseProb * marketFactor * strengthFactor);
}

function calculateOptimalStake(balance, confidence, kellyFraction = 0.25) {
    const baseStake = balance;
    const confidenceMultipliers = {
        'high': 1.0,
        'medium': 0.75,
        'low': 0.5
    };
    
    return Math.min(balance, baseStake * confidenceMultipliers[confidence] * kellyFraction);
}

function getProgressiveStrategy(currentDay, currentBalance, target) {
    const daysRemaining = TARGET_DAYS - currentDay;
    const requiredGrowth = target / currentBalance;
    const dailyGrowthNeeded = Math.pow(requiredGrowth, 1/daysRemaining);
    
    return {
        minOdds: dailyGrowthNeeded,
        maxRisk: Math.min(0.5, 0.8 / daysRemaining),
        suggestedMarkets: daysRemaining > 10 ? ['over15', 'homeOrDraw', 'awayOrDraw'] : ['over05', 'homeOrDraw', 'dnbHome']
    };
}

function analyzePatterns() {
    const patterns = {
        leaguePerformance: {},
        marketPerformance: {},
        timeOfDay: {},
        oddsRangePerformance: {}
    };
    
    challengeData.bets.forEach(bet => {
        // League patterns
        const league = bet.competition.split('/')[0].trim();
        patterns.leaguePerformance[league] = patterns.leaguePerformance[league] || { wins: 0, total: 0 };
        patterns.leaguePerformance[league].total++;
        if (bet.status === 'won') patterns.leaguePerformance[league].wins++;
        
        // Market patterns
        bet.legs?.forEach(leg => {
            patterns.marketPerformance[leg.market] = patterns.marketPerformance[leg.market] || { wins: 0, total: 0 };
            patterns.marketPerformance[leg.market].total++;
            if (bet.status === 'won') patterns.marketPerformance[leg.market].wins++;
        });
        
        // Odds range patterns
        const range = bet.odds < 1.3 ? '1.20-1.30' : bet.odds < 1.5 ? '1.30-1.50' : '1.50+';
        patterns.oddsRangePerformance[range] = patterns.oddsRangePerformance[range] || { wins: 0, total: 0 };
        patterns.oddsRangePerformance[range].total++;
        if (bet.status === 'won') patterns.oddsRangePerformance[range].wins++;
    });
    
    return patterns;
}

function findOptimalBets(targetOdds = [1.20, 1.30], maxAccumulatorSize = 3) {
    const optimalBets = [];
    const todayFixtures = allFixtures.filter(f => {
        const date = new Date(f.fixture.date).toISOString().split('T')[0];
        return date === getToday();
    });
    
    // Single bets in target range
    todayFixtures.forEach(fixture => {
        const odds = oddsCache[fixture.fixture.id];
        if (!odds) return;
        
        const safeMarkets = [
            { key: 'homeOrDraw', label: '1X', minProb: 0.75 },
            { key: 'awayOrDraw', label: 'X2', minProb: 0.75 },
            { key: 'over05', label: 'Over 0.5', minProb: 0.85 },
            { key: 'over15', label: 'Over 1.5', minProb: 0.65 },
            { key: 'dnbHome', label: 'DNB Home', minProb: 0.70 },
            { key: 'dnbAway', label: 'DNB Away', minProb: 0.70 }
        ];
        
        safeMarkets.forEach(market => {
            if (odds[market.key] && 
                odds[market.key] >= targetOdds[0] && 
                odds[market.key] <= targetOdds[1]) {
                
                const impliedProb = 1 / odds[market.key];
                const adjustedProb = calculateAdjustedProbability(
                    odds[market.key], 
                    market.key, 
                    fixture.league.name,
                    fixture.teams.home.name,
                    fixture.teams.away.name
                );
                
                if (adjustedProb >= market.minProb) {
                    optimalBets.push({
                        fixtureId: fixture.fixture.id,
                        match: `${fixture.teams.home.name} vs ${fixture.teams.away.name}`,
                        market: market.key,
                        selection: MARKET_TYPES[market.key],
                        odds: odds[market.key],
                        impliedProbability: impliedProb,
                        adjustedProbability: adjustedProb,
                        league: LEAGUES[fixture.league.id]?.name || 'Unknown',
                        confidence: adjustedProb > 0.8 ? 'high' : adjustedProb > 0.7 ? 'medium' : 'low',
                        type: 'single'
                    });
                }
            }
        });
    });
    
    // Generate accumulator combinations
    if (optimalBets.length >= 2) {
        const singles = optimalBets.filter(b => b.adjustedProbability > 0.75);
        for (let i = 0; i < singles.length; i++) {
            for (let j = i + 1; j < singles.length && j < i + maxAccumulatorSize; j++) {
                const combinedOdds = singles[i].odds * singles[j].odds;
                const combinedProb = singles[i].adjustedProbability * singles[j].adjustedProbability;
                if (combinedOdds >= 1.20 && combinedOdds <= 1.50 && combinedProb > 0.65) {
                    optimalBets.push({
                        legs: [singles[i], singles[j]],
                        combinedOdds: combinedOdds,
                        impliedProbability: (singles[i].impliedProbability * singles[j].impliedProbability),
                        adjustedProbability: combinedProb,
                        type: 'double',
                        confidence: singles[i].confidence === 'high' && singles[j].confidence === 'high' ? 'high' : 'medium'
                    });
                }
            }
        }
    }
    
    return optimalBets.sort((a, b) => b.adjustedProbability - a.adjustedProbability);
}

function updateEnhancedAnalytics() {
    const bets = challengeData.bets;
    const wonBets = bets.filter(b => b.status === 'won');
    
    // Sharpe Ratio (risk-adjusted returns)
    const returns = wonBets.map(b => (b.returns - b.stake) / b.stake);
    const avgReturn = returns.length > 0 ? returns.reduce((a, b) => a + b, 0) / returns.length : 0;
    const stdDev = returns.length > 1 ? Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length) : 0;
    const sharpeRatio = stdDev > 0 ? avgReturn / stdDev : 0;
    
    // Kelly Criterion optimal stake
    const winRate = bets.length > 0 ? wonBets.length / bets.length : 0;
    const avgOdds = wonBets.length > 0 ? wonBets.reduce((a, b) => a + b.odds, 0) / wonBets.length : DAILY_MULTIPLIER;
    const kellyFraction = winRate > 0 ? winRate - ((1 - winRate) / (avgOdds - 1)) : 0;
    
    // Value Index
    const valueIndex = winRate * avgOdds;
    
    // Update UI
    document.getElementById('sharpeRatio').textContent = sharpeRatio.toFixed(2);
    document.getElementById('kellyFraction').textContent = `${Math.max(0, Math.min(kellyFraction * 100, 100)).toFixed(0)}%`;
    document.getElementById('valueIndex').textContent = valueIndex.toFixed(2);
}

function generateSmartBets() {
    const container = document.getElementById('smartBetsContainer');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    setTimeout(() => {
        const optimalBets = findOptimalBets([1.20, 1.35], 3);
        
        if (optimalBets.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ”</div><p>No optimal bets found. Try adjusting filters.</p></div>';
            return;
        }
        
        const html = optimalBets.slice(0, 5).map(bet => {
            if (bet.type === 'single') {
                return `
                    <div class="smart-bet">
                        <div class="smart-bet-header">
                            <span class="smart-bet-type">${bet.type.toUpperCase()}</span>
                            <span class="smart-bet-odds">${bet.odds.toFixed(2)}</span>
                            <span class="smart-bet-confidence ${bet.confidence}">${bet.confidence.toUpperCase()}</span>
                        </div>
                        <div class="smart-bet-legs">
                            <div class="smart-bet-leg">
                                <strong>${bet.selection}</strong><br>
                                <small>${bet.match}</small><br>
                                <small class="text-muted">${bet.league}</small>
                            </div>
                        </div>
                        <div class="smart-bet-actions">
                            <button class="btn btn-sm btn-primary" onclick="addSmartBetToSlip(${bet.fixtureId}, '${bet.market}', '${escapeHtml(bet.match.split(' vs ')[0])}', '${escapeHtml(bet.match.split(' vs ')[1])}', ${bet.odds}, '${escapeHtml(bet.league)}')">Add to Betslip</button>
                            <button class="btn btn-sm btn-secondary" onclick="analyzeBet(${bet.fixtureId}, '${bet.market}')">Analyze</button>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="smart-bet">
                        <div class="smart-bet-header">
                            <span class="smart-bet-type">${bet.type.toUpperCase()}</span>
                            <span class="smart-bet-odds">${bet.combinedOdds.toFixed(2)}</span>
                            <span class="smart-bet-confidence ${bet.confidence}">${bet.confidence.toUpperCase()}</span>
                        </div>
                        <div class="smart-bet-legs">
                            ${bet.legs.map(leg => `
                                <div class="smart-bet-leg">
                                    <strong>${leg.selection}</strong><br>
                                    <small>${leg.match}</small>
                                </div>
                            `).join('')}
                        </div>
                        <div class="smart-bet-actions">
                            <button class="btn btn-sm btn-primary" onclick="addSmartAccumulator(${JSON.stringify(bet.legs).replace(/'/g, "\\'")})">Add All</button>
                            <button class="btn btn-sm btn-secondary" onclick="analyzeAccumulator(${JSON.stringify(bet.legs).replace(/'/g, "\\'")})">Analyze</button>
                        </div>
                    </div>
                `;
            }
        }).join('');
        
        container.innerHTML = html;
    }, 500);
}

function addSmartBetToSlip(fixtureId, market, home, away, odds, league) {
    toggleSelection(fixtureId, market, home, away, odds, league);
    notify('Added to betslip!', 'success');
}

function addSmartAccumulator(legs) {
    legs.forEach(leg => {
        if (!betslip.some(s => s.fixtureId === leg.fixtureId && s.market === leg.market)) {
            betslip.push({
                fixtureId: leg.fixtureId,
                market: leg.market,
                home: leg.match.split(' vs ')[0],
                away: leg.match.split(' vs ')[1],
                league: leg.league,
                selection: MARKET_TYPES[leg.market] || leg.market,
                odds: leg.odds,
                match: leg.match
            });
        }
    });
    applyFilters();
    renderBetslip();
    notify('Accumulator added to betslip!', 'success');
}

function analyzeBet(fixtureId, market) {
    const fixture = allFixtures.find(f => f.fixture.id === fixtureId);
    if (!fixture) return;
    
    const odds = oddsCache[fixtureId];
    if (!odds) return;
    
    const oddValue = odds[market];
    const impliedProb = 1 / oddValue;
    const adjustedProb = calculateAdjustedProbability(oddValue, market, fixture.league.name, fixture.teams.home.name, fixture.teams.away.name);
    const marketSuccessRate = MARKET_SUCCESS_RATES[market] || 0.65;
    
    alert(`Bet Analysis:\n\n` +
          `Market: ${MARKET_TYPES[market]}\n` +
          `Odds: ${oddValue.toFixed(2)}\n` +
          `Implied Probability: ${(impliedProb * 100).toFixed(1)}%\n` +
          `Market Success Rate: ${(marketSuccessRate * 100).toFixed(1)}%\n` +
          `Adjusted Probability: ${(adjustedProb * 100).toFixed(1)}%\n` +
          `Value: ${(adjustedProb - impliedProb > 0 ? '+' : '') + ((adjustedProb - impliedProb) * 100).toFixed(1)}%\n\n` +
          `Recommendation: ${adjustedProb > 0.75 ? 'âœ… Strong Bet' : adjustedProb > 0.65 ? 'ðŸŸ¡ Consider' : 'ðŸ”´ Avoid'}`);
}

function analyzeAccumulator(legs) {
    let totalImpliedProb = 1;
    let totalAdjustedProb = 1;
    let analysis = 'Accumulator Analysis:\n\n';
    
    legs.forEach((leg, index) => {
        const fixture = allFixtures.find(f => f.fixture.id === leg.fixtureId);
        const odds = oddsCache[leg.fixtureId];
        const impliedProb = 1 / leg.odds;
        const adjustedProb = calculateAdjustedProbability(leg.odds, leg.market, leg.league, leg.match.split(' vs ')[0], leg.match.split(' vs ')[1]);
        
        totalImpliedProb *= impliedProb;
        totalAdjustedProb *= adjustedProb;
        
        analysis += `Leg ${index + 1}: ${leg.selection}\n` +
                   `Odds: ${leg.odds.toFixed(2)} (${(impliedProb * 100).toFixed(1)}%)\n` +
                   `Adjusted: ${(adjustedProb * 100).toFixed(1)}%\n\n`;
    });
    
    const combinedOdds = legs.reduce((acc, leg) => acc * leg.odds, 1);
    const value = totalAdjustedProb - totalImpliedProb;
    
    analysis += `Combined Odds: ${combinedOdds.toFixed(2)}\n` +
                `Combined Implied Probability: ${(totalImpliedProb * 100).toFixed(1)}%\n` +
                `Combined Adjusted Probability: ${(totalAdjustedProb * 100).toFixed(1)}%\n` +
                `Value: ${(value * 100).toFixed(1)}%\n\n` +
                `Recommendation: ${totalAdjustedProb > 0.65 ? 'âœ… Good Value' : 'âš ï¸ Risky'}`;
    
    alert(analysis);
}

// ============================================================
// THEME
// ============================================================
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'â˜€ï¸' : 'ðŸŒ™';
    challengeData.settings.theme = newTheme;
    localStorage.setItem('theme', newTheme);
    saveData();
}

function loadTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeToggle').textContent = savedTheme === 'light' ? 'â˜€ï¸' : 'ðŸŒ™';
}

// ============================================================
// PWA INSTALL
// ============================================================
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('installBtn').style.display = 'inline-flex';
});

function installPWA() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choice) => {
            if (choice.outcome === 'accepted') notify('App installed!', 'success');
            deferredPrompt = null;
            document.getElementById('installBtn').style.display = 'none';
        });
    }
}

// ============================================================
// API STATUS
// ============================================================
function showApiStatus() {
    document.getElementById('apiModal').classList.add('open');
    document.getElementById('apiModalFirebase').textContent = isOnline ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Offline';
    document.getElementById('apiModalFirebase').style.color = isOnline ? 'var(--accent-green)' : 'var(--accent-red)';
    document.getElementById('apiModalUserId').textContent = userId || '-';
    document.getElementById('apiModalFixtures').textContent = allFixtures.length;
    document.getElementById('apiModalOdds').textContent = Object.keys(oddsCache).length;
}

function closeApiStatus() {
    document.getElementById('apiModal').classList.remove('open');
}

async function testApiConnection() {
    notify('Testing API connection...', 'info');
    try {
        const response = await fetch(`${API_BASE}/status`, { headers: { 'x-apisports-key': API_KEY }});
        if (response.ok) {
            const data = await response.json();
            notify(`API OK - ${data.response?.requests?.current || 0}/${data.response?.requests?.limit_day || 100} requests today`, 'success');
        } else {
            notify('API connection failed', 'error');
        }
    } catch (e) {
        notify('API test failed: ' + e.message, 'error');
    }
}

// ============================================================
// FIREBASE
// ============================================================
function initFirebase() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        
        userId = localStorage.getItem('bet_userId');
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('bet_userId', userId);
        }
        
        db.ref(`challenges/${userId}`).on('value', (snapshot) => {
            const cloudData = snapshot.val();
            if (cloudData && cloudData.lastUpdated > (challengeData.lastUpdated || 0)) {
                challengeData = cloudData;
                updateAllUI();
            }
            isOnline = true;
            document.getElementById('firebaseDot').className = 'status-dot online';
            document.getElementById('firebaseText').textContent = 'Synced';
        }, (error) => {
            isOnline = false;
            document.getElementById('firebaseDot').className = 'status-dot offline';
            document.getElementById('firebaseText').textContent = 'Offline';
        });
        
        db.ref('.info/connected').on('value', (snap) => {
            isOnline = snap.val() === true;
            document.getElementById('firebaseDot').className = `status-dot ${isOnline ? 'online' : 'offline'}`;
            document.getElementById('firebaseText').textContent = isOnline ? 'Synced' : 'Offline';
        });
        
    } catch (e) {
        console.error('Firebase init error:', e);
        document.getElementById('firebaseDot').className = 'status-dot offline';
        document.getElementById('firebaseText').textContent = 'Error';
    }
}

function saveData() {
    challengeData.lastUpdated = Date.now();
    localStorage.setItem('betChallenge_v8', JSON.stringify(challengeData));
    if (db && userId && isOnline) {
        db.ref(`challenges/${userId}`).set(challengeData).catch(() => {});
    }
}

function loadData() {
    const saved = localStorage.getItem('betChallenge_v8');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            if (parsed.bets) challengeData = parsed;
        } catch(e) {}
    }
    loadTheme();
    updateAllUI();
}

function exportData() {
    const blob = new Blob([JSON.stringify(challengeData, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `bet-tracker-${getToday()}.json`;
    a.click();
    notify('Data exported!', 'success');
}

function importData(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
            try {
                challengeData = JSON.parse(ev.target.result);
                saveData();
                updateAllUI();
                notify('Data imported successfully!', 'success');
            } catch(err) {
                notify('Import failed - invalid file', 'error');
            }
        };
        reader.readAsText(file);
    }
    e.target.value = '';
}

function resetData() {
    if (confirm('âš ï¸ Reset ALL data? This cannot be undone!')) {
        challengeData = {
            startDate: getToday(),
            currentBalance: INITIAL_BALANCE,
            bets: [],
            pendingBets: [],
            settings: { theme: 'dark' },
            lastUpdated: Date.now()
        };
        saveData();
        updateAllUI();
        notify('All data reset', 'success');
    }
}

// ============================================================
// API CALLS
// ============================================================
async function apiCall(endpoint) {
    try {
        const res = await fetch(`${API_BASE}${endpoint}`, { headers: { 'x-apisports-key': API_KEY } });
        if (res.ok) {
            const json = await res.json();
            if (json.errors && Object.keys(json.errors).length > 0) return null;
            return json.response || [];
        }
        return null;
    } catch(e) {
        return null;
    }
}

async function loadFixtures() {
    if (fixturesLoading) return;
    fixturesLoading = true;
    
    const apiDot = document.getElementById('apiDot');
    const apiText = document.getElementById('apiText');
    const container = document.getElementById('fixturesContainer');

    apiDot.className = 'status-dot connecting';
    apiText.textContent = 'Loading...';
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    allFixtures = [];

    try {
        for (const leagueId of FETCH_LEAGUES) {
            try {
                const response = await apiCall(`/fixtures?league=${leagueId}&next=10`);
                if (response && response.length > 0) {
                    allFixtures.push(...response);
                }
            } catch (e) {}
            await sleep(120);
        }

        if (allFixtures.length > 0) {
            apiText.textContent = `${allFixtures.length} - odds...`;
            await loadAllOdds();
        }

        apiDot.className = 'status-dot online';
        apiText.textContent = `${allFixtures.length}`;
        document.getElementById('fixtureCount').textContent = `${allFixtures.length} fixtures`;

        applyFilters();

        if (allFixtures.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“…</div><p>No fixtures found</p></div>';
        }

    } catch (e) {
        apiDot.className = 'status-dot offline';
        apiText.textContent = 'Error';
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><p>Failed to load fixtures</p><button class="btn btn-success mt-1" onclick="refreshFixtures()">Retry</button></div>';
    }

    fixturesLoading = false;
}

async function loadFixturesForDate() {
    const date = document.getElementById('dateFilter').value;
    if (!date) {
        notify('Please select a date', 'warning');
        return;
    }
    
    if (fixturesLoading) return;
    fixturesLoading = true;

    const apiDot = document.getElementById('apiDot');
    const apiText = document.getElementById('apiText');
    const container = document.getElementById('fixturesContainer');

    apiDot.className = 'status-dot connecting';
    apiText.textContent = 'Loading...';
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    allFixtures = [];

    try {
        for (const leagueId of FETCH_LEAGUES) {
            try {
                const response = await apiCall(`/fixtures?league=${leagueId}&date=${date}`);
                if (response && response.length > 0) {
                    allFixtures.push(...response);
                }
            } catch (e) {}
            await sleep(120);
        }

        if (allFixtures.length > 0) {
            apiText.textContent = `${allFixtures.length} - odds...`;
            await loadAllOdds();
        }

        apiDot.className = 'status-dot online';
        apiText.textContent = `${allFixtures.length}`;
        document.getElementById('fixtureCount').textContent = `${allFixtures.length} fixtures`;

        applyFilters();

        if (allFixtures.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“…</div><p>No fixtures on this date</p></div>';
        }

    } catch (e) {
        apiDot.className = 'status-dot offline';
        apiText.textContent = 'Error';
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><p>Failed to load</p></div>';
    }

    fixturesLoading = false;
}

function refreshFixtures() {
    document.getElementById('dateFilter').value = '';
    loadFixtures();
}

async function loadAllOdds() {
    const grouped = {};
    
    allFixtures.forEach(f => {
        const date = f.fixture.date.split('T')[0];
        const league = f.league.id;
        const key = `${league}_${date}`;
        if (!grouped[key]) grouped[key] = { league, date };
    });

    for (const key of Object.keys(grouped)) {
        const { league, date } = grouped[key];
        try {
            const response = await apiCall(`/odds?league=${league}&date=${date}`);
            if (response && response.length > 0) {
                response.forEach(oddsData => {
                    oddsCache[oddsData.fixture.id] = parseOdds(oddsData);
                });
            }
        } catch (e) {}
        await sleep(120);
    }
}

function parseOdds(oddsData) {
    const result = {
        // Match Result
        home: null, draw: null, away: null,
        
        // Double Chance
        homeOrDraw: null, awayOrDraw: null, homeOrAway: null,
        
        // Draw No Bet
        dnbHome: null, dnbAway: null,
        
        // Goals Over/Under Full Time
        over05: null, over15: null, over25: null, over35: null, over45: null, over55: null,
        under05: null, under15: null, under25: null, under35: null, under45: null, under55: null,
        
        // Goals Over/Under First Half
        over05FH: null, over15FH: null, over25FH: null,
        under05FH: null, under15FH: null, under25FH: null,
        
        // Goals Over/Under Second Half
        over05SH: null, over15SH: null, over25SH: null,
        under05SH: null, under15SH: null, under25SH: null,
        
        // BTTS
        bttsYes: null, bttsNo: null,
        bttsFHYes: null, bttsFHNo: null,
        bttsSHYes: null, bttsSHNo: null,
        
        // Half Time Result
        htHome: null, htDraw: null, htAway: null,
        
        // Second Half Winner
        shHome: null, shDraw: null, shAway: null,
        
        // Asian Handicap
        ahHome_minus05: null, ahHome_minus1: null, ahHome_minus15: null, ahHome_minus2: null, ahHome_minus25: null,
        ahHome_plus05: null, ahHome_plus1: null, ahHome_plus15: null, ahHome_plus2: null,
        ahAway_minus05: null, ahAway_minus1: null, ahAway_minus15: null, ahAway_minus2: null, ahAway_minus25: null,
        ahAway_plus05: null, ahAway_plus1: null, ahAway_plus15: null, ahAway_plus2: null,
        
        // Goal Line
        gl_over15: null, gl_under15: null, gl_over25: null, gl_under25: null, gl_over35: null, gl_under35: null,
        
        // Odd/Even
        goalsOdd: null, goalsEven: null,
        
        // Home Team Goals
        homeOver05: null, homeOver15: null, homeOver25: null,
        homeUnder05: null, homeUnder15: null, homeUnder25: null,
        
        // Away Team Goals
        awayOver05: null, awayOver15: null, awayOver25: null,
        awayUnder05: null, awayUnder15: null, awayUnder25: null,
        
        // Clean Sheet
        csHome: null, csAway: null, noCSHome: null, noCSAway: null,
        
        // Win to Nil
        wtnHome: null, wtnAway: null,
        
        // Score Both Halves
        homeScoreBoth: null, awayScoreBoth: null,
        
        // Win Either Half
        homeWinEither: null, awayWinEither: null,
        
        // Corners
        cornersOver75: null, cornersOver85: null, cornersOver95: null, cornersOver105: null,
        cornersUnder75: null, cornersUnder85: null, cornersUnder95: null, cornersUnder105: null,
        
        // Cards
        cardsOver25: null, cardsOver35: null, cardsOver45: null,
        cardsUnder25: null, cardsUnder35: null, cardsUnder45: null,
        
        // HT/FT
        htft_1_1: null, htft_1_X: null, htft_1_2: null,
        htft_X_1: null, htft_X_X: null, htft_X_2: null,
        htft_2_1: null, htft_2_X: null, htft_2_2: null,
        
        // Exact Goals
        exactGoals0: null, exactGoals1: null, exactGoals2: null, exactGoals3: null, exactGoals4plus: null,
        
        // Result & BTTS
        homeAndBttsYes: null, homeAndBttsNo: null,
        drawAndBttsYes: null,
        awayAndBttsYes: null, awayAndBttsNo: null,
        
        // Result & Over/Under
        homeAndOver15: null, homeAndOver25: null,
        drawAndOver15: null, drawAndOver25: null,
        awayAndOver15: null, awayAndOver25: null,
        
        bookmaker: null
    };

    if (!oddsData || !oddsData.bookmakers || oddsData.bookmakers.length === 0) return result;

    // Find preferred bookmaker
    let bookmaker = null;
    for (const pref of PREFERRED_BOOKMAKERS) {
        bookmaker = oddsData.bookmakers.find(b => b.name.toLowerCase().includes(pref.toLowerCase()));
        if (bookmaker) break;
    }
    if (!bookmaker) bookmaker = oddsData.bookmakers[0];
    result.bookmaker = bookmaker.name;

    // Parse all bets from bookmaker
    for (const bet of bookmaker.bets) {
        const name = bet.name;
        const values = bet.values;

        // Match Winner (1X2)
        if (name === 'Match Winner') {
            values.forEach(v => {
                if (v.value === 'Home') result.home = parseFloat(v.odd);
                if (v.value === 'Draw') result.draw = parseFloat(v.odd);
                if (v.value === 'Away') result.away = parseFloat(v.odd);
            });
        }

        // Double Chance
        if (name === 'Double Chance') {
            values.forEach(v => {
                if (v.value === 'Home/Draw') result.homeOrDraw = parseFloat(v.odd);
                if (v.value === 'Away/Draw') result.awayOrDraw = parseFloat(v.odd);
                if (v.value === 'Home/Away') result.homeOrAway = parseFloat(v.odd);
            });
        }

        // Draw No Bet
        if (name === 'Draw No Bet') {
            values.forEach(v => {
                if (v.value === 'Home') result.dnbHome = parseFloat(v.odd);
                if (v.value === 'Away') result.dnbAway = parseFloat(v.odd);
            });
        }

        // Goals Over/Under (Full Time)
        if (name === 'Goals Over/Under') {
            values.forEach(v => {
                if (v.value === 'Over 0.5') result.over05 = parseFloat(v.odd);
                if (v.value === 'Over 1.5') result.over15 = parseFloat(v.odd);
                if (v.value === 'Over 2.5') result.over25 = parseFloat(v.odd);
                if (v.value === 'Over 3.5') result.over35 = parseFloat(v.odd);
                if (v.value === 'Over 4.5') result.over45 = parseFloat(v.odd);
                if (v.value === 'Over 5.5') result.over55 = parseFloat(v.odd);
                if (v.value === 'Under 0.5') result.under05 = parseFloat(v.odd);
                if (v.value === 'Under 1.5') result.under15 = parseFloat(v.odd);
                if (v.value === 'Under 2.5') result.under25 = parseFloat(v.odd);
                if (v.value === 'Under 3.5') result.under35 = parseFloat(v.odd);
                if (v.value === 'Under 4.5') result.under45 = parseFloat(v.odd);
                if (v.value === 'Under 5.5') result.under55 = parseFloat(v.odd);
            });
        }

        // Goals Over/Under First Half
        if (name === 'Goals Over/Under First Half') {
            values.forEach(v => {
                if (v.value === 'Over 0.5') result.over05FH = parseFloat(v.odd);
                if (v.value === 'Over 1.5') result.over15FH = parseFloat(v.odd);
                if (v.value === 'Over 2.5') result.over25FH = parseFloat(v.odd);
                if (v.value === 'Under 0.5') result.under05FH = parseFloat(v.odd);
                if (v.value === 'Under 1.5') result.under15FH = parseFloat(v.odd);
                if (v.value === 'Under 2.5') result.under25FH = parseFloat(v.odd);
            });
        }

        // Goals Over/Under Second Half
        if (name === 'Goals Over/Under - Second Half') {
            values.forEach(v => {
                if (v.value === 'Over 0.5') result.over05SH = parseFloat(v.odd);
                if (v.value === 'Over 1.5') result.over15SH = parseFloat(v.odd);
                if (v.value === 'Over 2.5') result.over25SH = parseFloat(v.odd);
                if (v.value === 'Under 0.5') result.under05SH = parseFloat(v.odd);
                if (v.value === 'Under 1.5') result.under15SH = parseFloat(v.odd);
		        if (v.value === 'Under 2.5') result.under25SH = parseFloat(v.odd);
            });
        }

        // Both Teams Score
        if (name === 'Both Teams Score') {
            values.forEach(v => {
                if (v.value === 'Yes') result.bttsYes = parseFloat(v.odd);
                if (v.value === 'No') result.bttsNo = parseFloat(v.odd);
            });
        }

        // BTTS First Half
        if (name === 'Both Teams Score - First Half') {
            values.forEach(v => {
                if (v.value === 'Yes') result.bttsFHYes = parseFloat(v.odd);
                if (v.value === 'No') result.bttsFHNo = parseFloat(v.odd);
            });
        }

        // BTTS Second Half
        if (name === 'Both Teams Score - Second Half') {
            values.forEach(v => {
                if (v.value === 'Yes') result.bttsSHYes = parseFloat(v.odd);
                if (v.value === 'No') result.bttsSHNo = parseFloat(v.odd);
            });
        }

        // First Half Winner
        if (name === 'First Half Winner') {
            values.forEach(v => {
                if (v.value === 'Home') result.htHome = parseFloat(v.odd);
                if (v.value === 'Draw') result.htDraw = parseFloat(v.odd);
                if (v.value === 'Away') result.htAway = parseFloat(v.odd);
            });
        }

        // Second Half Winner
        if (name === 'Second Half Winner') {
            values.forEach(v => {
                if (v.value === 'Home') result.shHome = parseFloat(v.odd);
                if (v.value === 'Draw') result.shDraw = parseFloat(v.odd);
                if (v.value === 'Away') result.shAway = parseFloat(v.odd);
            });
        }

        // Asian Handicap
        if (name === 'Asian Handicap') {
            values.forEach(v => {
                const val = v.value;
                const odd = parseFloat(v.odd);
                
                // Home handicaps
                if (val === 'Home -0.5') result.ahHome_minus05 = odd;
                if (val === 'Home -1') result.ahHome_minus1 = odd;
                if (val === 'Home -1.5') result.ahHome_minus15 = odd;
                if (val === 'Home -2') result.ahHome_minus2 = odd;
                if (val === 'Home -2.5') result.ahHome_minus25 = odd;
                if (val === 'Home +0.5') result.ahHome_plus05 = odd;
                if (val === 'Home +1') result.ahHome_plus1 = odd;
                if (val === 'Home +1.5') result.ahHome_plus15 = odd;
                if (val === 'Home +2') result.ahHome_plus2 = odd;
                
                // Away handicaps
                if (val === 'Away -0.5') result.ahAway_minus05 = odd;
                if (val === 'Away -1') result.ahAway_minus1 = odd;
                if (val === 'Away -1.5') result.ahAway_minus15 = odd;
                if (val === 'Away -2') result.ahAway_minus2 = odd;
                if (val === 'Away -2.5') result.ahAway_minus25 = odd;
                if (val === 'Away +0.5') result.ahAway_plus05 = odd;
                if (val === 'Away +1') result.ahAway_plus1 = odd;
                if (val === 'Away +1.5') result.ahAway_plus15 = odd;
                if (val === 'Away +2') result.ahAway_plus2 = odd;
            });
        }

        // Goal Line (Asian Total)
        if (name === 'Goal Line') {
            values.forEach(v => {
                if (v.value === 'Over 1.5') result.gl_over15 = parseFloat(v.odd);
                if (v.value === 'Under 1.5') result.gl_under15 = parseFloat(v.odd);
                if (v.value === 'Over 2.5') result.gl_over25 = parseFloat(v.odd);
                if (v.value === 'Under 2.5') result.gl_under25 = parseFloat(v.odd);
                if (v.value === 'Over 3.5') result.gl_over35 = parseFloat(v.odd);
                if (v.value === 'Under 3.5') result.gl_under35 = parseFloat(v.odd);
            });
        }

        // Odd/Even
        if (name === 'Odd/Even') {
            values.forEach(v => {
                if (v.value === 'Odd') result.goalsOdd = parseFloat(v.odd);
                if (v.value === 'Even') result.goalsEven = parseFloat(v.odd);
            });
        }

        // Total - Home
        if (name === 'Total - Home') {
            values.forEach(v => {
                if (v.value === 'Over 0.5') result.homeOver05 = parseFloat(v.odd);
                if (v.value === 'Over 1.5') result.homeOver15 = parseFloat(v.odd);
                if (v.value === 'Over 2.5') result.homeOver25 = parseFloat(v.odd);
                if (v.value === 'Under 0.5') result.homeUnder05 = parseFloat(v.odd);
                if (v.value === 'Under 1.5') result.homeUnder15 = parseFloat(v.odd);
                if (v.value === 'Under 2.5') result.homeUnder25 = parseFloat(v.odd);
            });
        }

        // Total - Away
        if (name === 'Total - Away') {
            values.forEach(v => {
                if (v.value === 'Over 0.5') result.awayOver05 = parseFloat(v.odd);
                if (v.value === 'Over 1.5') result.awayOver15 = parseFloat(v.odd);
                if (v.value === 'Over 2.5') result.awayOver25 = parseFloat(v.odd);
                if (v.value === 'Under 0.5') result.awayUnder05 = parseFloat(v.odd);
                if (v.value === 'Under 1.5') result.awayUnder15 = parseFloat(v.odd);
                if (v.value === 'Under 2.5') result.awayUnder25 = parseFloat(v.odd);
            });
        }

        // Clean Sheet - Home
        if (name === 'Clean Sheet - Home') {
            values.forEach(v => {
                if (v.value === 'Yes') result.csHome = parseFloat(v.odd);
                if (v.value === 'No') result.noCSHome = parseFloat(v.odd);
            });
        }

        // Clean Sheet - Away
        if (name === 'Clean Sheet - Away') {
            values.forEach(v => {
                if (v.value === 'Yes') result.csAway = parseFloat(v.odd);
                if (v.value === 'No') result.noCSAway = parseFloat(v.odd);
            });
        }

        // Win to Nil - Home
        if (name === 'Win to Nil - Home') {
            values.forEach(v => {
                if (v.value === 'Yes') result.wtnHome = parseFloat(v.odd);
            });
        }

        // Win to Nil - Away
        if (name === 'Win to Nil - Away') {
            values.forEach(v => {
                if (v.value === 'Yes') result.wtnAway = parseFloat(v.odd);
            });
        }

        // To Score In Both Halves - Home
        if (name === 'Home Team Score a Goal in Both Halves') {
            values.forEach(v => {
                if (v.value === 'Yes') result.homeScoreBoth = parseFloat(v.odd);
            });
        }

        // To Score In Both Halves - Away
        if (name === 'Away Team Score a Goal in Both Halves') {
            values.forEach(v => {
                if (v.value === 'Yes') result.awayScoreBoth = parseFloat(v.odd);
            });
        }

        // To Win Either Half - Home
        if (name === 'To Win Either Half - Home') {
            values.forEach(v => {
                if (v.value === 'Yes') result.homeWinEither = parseFloat(v.odd);
            });
        }

        // To Win Either Half - Away
        if (name === 'To Win Either Half - Away') {
            values.forEach(v => {
                if (v.value === 'Yes') result.awayWinEither = parseFloat(v.odd);
            });
        }

        // Corners Over/Under
        if (name === 'Corners Over Under') {
            values.forEach(v => {
                if (v.value === 'Over 7.5') result.cornersOver75 = parseFloat(v.odd);
                if (v.value === 'Over 8.5') result.cornersOver85 = parseFloat(v.odd);
                if (v.value === 'Over 9.5') result.cornersOver95 = parseFloat(v.odd);
                if (v.value === 'Over 10.5') result.cornersOver105 = parseFloat(v.odd);
                if (v.value === 'Under 7.5') result.cornersUnder75 = parseFloat(v.odd);
                if (v.value === 'Under 8.5') result.cornersUnder85 = parseFloat(v.odd);
                if (v.value === 'Under 9.5') result.cornersUnder95 = parseFloat(v.odd);
                if (v.value === 'Under 10.5') result.cornersUnder105 = parseFloat(v.odd);
            });
        }

        // Total Cards
        if (name === 'Total Cards') {
            values.forEach(v => {
                if (v.value === 'Over 2.5') result.cardsOver25 = parseFloat(v.odd);
                if (v.value === 'Over 3.5') result.cardsOver35 = parseFloat(v.odd);
                if (v.value === 'Over 4.5') result.cardsOver45 = parseFloat(v.odd);
                if (v.value === 'Under 2.5') result.cardsUnder25 = parseFloat(v.odd);
                if (v.value === 'Under 3.5') result.cardsUnder35 = parseFloat(v.odd);
                if (v.value === 'Under 4.5') result.cardsUnder45 = parseFloat(v.odd);
            });
        }

        // HT/FT
        if (name === 'HT/FT Double') {
            values.forEach(v => {
                if (v.value === '1/1' || v.value === 'Home/Home') result.htft_1_1 = parseFloat(v.odd);
                if (v.value === '1/X' || v.value === 'Home/Draw') result.htft_1_X = parseFloat(v.odd);
                if (v.value === '1/2' || v.value === 'Home/Away') result.htft_1_2 = parseFloat(v.odd);
                if (v.value === 'X/1' || v.value === 'Draw/Home') result.htft_X_1 = parseFloat(v.odd);
                if (v.value === 'X/X' || v.value === 'Draw/Draw') result.htft_X_X = parseFloat(v.odd);
                if (v.value === 'X/2' || v.value === 'Draw/Away') result.htft_X_2 = parseFloat(v.odd);
                if (v.value === '2/1' || v.value === 'Away/Home') result.htft_2_1 = parseFloat(v.odd);
                if (v.value === '2/X' || v.value === 'Away/Draw') result.htft_2_X = parseFloat(v.odd);
                if (v.value === '2/2' || v.value === 'Away/Away') result.htft_2_2 = parseFloat(v.odd);
            });
        }

        // Exact Goals
        if (name === 'Exact Goals Number') {
            values.forEach(v => {
                if (v.value === '0') result.exactGoals0 = parseFloat(v.odd);
                if (v.value === '1') result.exactGoals1 = parseFloat(v.odd);
                if (v.value === '2') result.exactGoals2 = parseFloat(v.odd);
                if (v.value === '3') result.exactGoals3 = parseFloat(v.odd);
                if (v.value === '4+' || v.value === '4 or more') result.exactGoals4plus = parseFloat(v.odd);
            });
        }

        // Results/Both Teams Score
        if (name === 'Results/Both Teams Score' || name === 'Result/Both Teams to Score') {
            values.forEach(v => {
                if (v.value === 'Home/Yes') result.homeAndBttsYes = parseFloat(v.odd);
                if (v.value === 'Home/No') result.homeAndBttsNo = parseFloat(v.odd);
                if (v.value === 'Draw/Yes') result.drawAndBttsYes = parseFloat(v.odd);
                if (v.value === 'Away/Yes') result.awayAndBttsYes = parseFloat(v.odd);
                if (v.value === 'Away/No') result.awayAndBttsNo = parseFloat(v.odd);
            });
        }

        // Result/Total Goals
        if (name === 'Results/Total Goals' || name === 'Result/Total Goals') {
            values.forEach(v => {
                if (v.value === 'Home/Over 1.5') result.homeAndOver15 = parseFloat(v.odd);
                if (v.value === 'Home/Over 2.5') result.homeAndOver25 = parseFloat(v.odd);
                if (v.value === 'Draw/Over 1.5') result.drawAndOver15 = parseFloat(v.odd);
                if (v.value === 'Draw/Over 2.5') result.drawAndOver25 = parseFloat(v.odd);
                if (v.value === 'Away/Over 1.5') result.awayAndOver15 = parseFloat(v.odd);
                if (v.value === 'Away/Over 2.5') result.awayAndOver25 = parseFloat(v.odd);
            });
        }
    }

    return result;
}

async function loadSingleFixtureOdds(fixtureId) {
    notify('Loading odds...', 'info');
    try {
        const response = await apiCall(`/odds?fixture=${fixtureId}`);
        if (response && response.length > 0) {
            oddsCache[fixtureId] = parseOdds(response[0]);
            applyFilters();
            notify(`Odds loaded (${oddsCache[fixtureId].bookmaker || 'Unknown'})`, 'success');
        } else {
            notify('No odds available', 'warning');
        }
    } catch(e) {
        notify('Failed to load odds', 'error');
    }
}

// ============================================================
// FILTERING & SORTING
// ============================================================
function applyFilters() {
    let fixtures = [...allFixtures];

    // Status filter
    const statusFilter = document.getElementById('statusFilter').value;
    if (statusFilter === 'upcoming') {
        fixtures = fixtures.filter(f => ['NS', 'TBD', 'PST'].includes(f.fixture.status.short));
    } else if (statusFilter === 'live') {
        fixtures = fixtures.filter(f => ['1H', '2H', 'HT', 'ET', 'P', 'BT', 'LIVE'].includes(f.fixture.status.short));
    } else if (statusFilter === 'finished') {
        fixtures = fixtures.filter(f => ['FT', 'AET', 'PEN'].includes(f.fixture.status.short));
    }

    // Odds filter
    const minOdds = parseFloat(document.getElementById('minOddsFilter').value) || 0;
    const maxOdds = parseFloat(document.getElementById('maxOddsFilter').value) || 999;
    if (minOdds > 0 || maxOdds < 999) {
        fixtures = fixtures.filter(f => {
            const odds = oddsCache[f.fixture.id];
            if (!odds || !odds.home) return true;
            const lowestOdd = Math.min(odds.home || 99, odds.away || 99, odds.homeOrDraw || 99, odds.awayOrDraw || 99);
            return lowestOdd >= minOdds && lowestOdd <= maxOdds;
        });
    }

    // League filter
    if (currentLeagueFilter !== 'all') {
        fixtures = fixtures.filter(f => f.league.id == currentLeagueFilter);
    }

    // Sort
    const sortFilter = document.getElementById('sortFilter').value;
    if (sortFilter === 'time') {
        fixtures.sort((a, b) => new Date(a.fixture.date) - new Date(b.fixture.date));
    } else if (sortFilter === 'oddsLow') {
        fixtures.sort((a, b) => {
            const oA = oddsCache[a.fixture.id], oB = oddsCache[b.fixture.id];
            const minA = oA ? Math.min(oA.home || 99, oA.away || 99) : 99;
            const minB = oB ? Math.min(oB.home || 99, oB.away || 99) : 99;
            return minA - minB;
        });
    } else if (sortFilter === 'oddsHigh') {
        fixtures.sort((a, b) => {
            const oA = oddsCache[a.fixture.id], oB = oddsCache[b.fixture.id];
            const minA = oA ? Math.min(oA.home || 99, oA.away || 99) : 0;
            const minB = oB ? Math.min(oB.home || 99, oB.away || 99) : 0;
            return minB - minA;
        });
    } else if (sortFilter === 'league') {
        fixtures.sort((a, b) => (LEAGUES[a.league.id]?.priority || 999) - (LEAGUES[b.league.id]?.priority || 999));
    }

    filteredFixtures = fixtures;
    buildLeagueTabs();
    renderFixtures();
}

function clearFilters() {
    document.getElementById('dateFilter').value = '';
    document.getElementById('statusFilter').value = 'upcoming';
    document.getElementById('minOddsFilter').value = '';
    document.getElementById('maxOddsFilter').value = '';
    document.getElementById('sortFilter').value = 'time';
    currentLeagueFilter = 'all';
    applyFilters();
}

function setLeagueFilter(leagueId) {
    currentLeagueFilter = leagueId;
    applyFilters();
}

// ============================================================
// FIXTURES UI
// ============================================================
function buildLeagueTabs() {
    const container = document.getElementById('leagueTabs');
    const leaguesInFixtures = [...new Set(allFixtures.map(f => f.league.id))];
    leaguesInFixtures.sort((a, b) => (LEAGUES[a]?.priority || 999) - (LEAGUES[b]?.priority || 999));
    
    let html = `<div class="tab ${currentLeagueFilter === 'all' ? 'active' : ''}" onclick="setLeagueFilter('all')">All (${filteredFixtures.length})</div>`;
    
    leaguesInFixtures.forEach(lid => {
        const league = LEAGUES[lid] || { short: 'Other', flag: 'âš½' };
        const count = allFixtures.filter(f => f.league.id === lid).length;
        html += `<div class="tab ${currentLeagueFilter == lid ? 'active' : ''}" onclick="setLeagueFilter(${lid})">${league.flag} ${league.short} (${count})</div>`;
    });
    
    container.innerHTML = html;
}

function renderFixtures() {
    const container = document.getElementById('fixturesContainer');
    
    if (!filteredFixtures.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“…</div><p>No fixtures match your filters</p></div>';
        return;
    }

    container.innerHTML = filteredFixtures.map(f => {
        const fix = f.fixture;
        const teams = f.teams;
        const league = LEAGUES[f.league.id] || { short: f.league.name?.substring(0, 10) || 'Other', flag: 'âš½', name: f.league.name };
        const dt = new Date(fix.date);
        const time = dt.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const date = dt.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        const hasSel = betslip.some(s => s.fixtureId === fix.id);
        const odds = oddsCache[fix.id];
        const isLive = ['1H', '2H', 'HT', 'ET', 'LIVE'].includes(fix.status.short);
        const isFin = ['FT', 'AET', 'PEN'].includes(fix.status.short);

        let middle = '<span class="fixture-vs">vs</span>';
        if (isLive || isFin) middle = `<span class="fixture-score">${f.goals?.home ?? 0} - ${f.goals?.away ?? 0}</span>`;

        let timeEl = `<span class="fixture-time">${date} ${time}</span>`;
        if (isLive) timeEl = `<span class="fixture-time live">ðŸ”´ ${fix.status.elapsed || ''}'</span>`;
        else if (isFin) timeEl = `<span class="fixture-time">FT</span>`;

        const home = escapeHtml(teams.home.name);
        const away = escapeHtml(teams.away.name);
        const leagueName = escapeHtml(league.name || '');

        return `
            <div class="fixture-card ${hasSel ? 'has-selection' : ''} ${isLive ? 'live' : ''}">
                <div class="fixture-header">
                    <span class="fixture-league">${league.flag} ${league.short}</span>
                    ${timeEl}
                </div>
                <div class="fixture-teams">
                    <div class="fixture-team">
                        ${teams.home.logo ? `<img src="${teams.home.logo}" class="team-logo" onerror="this.style.display='none'">` : ''}
                        <span class="team-name">${teams.home.name}</span>
                    </div>
                    ${middle}
                    <div class="fixture-team away">
                        ${teams.away.logo ? `<img src="${teams.away.logo}" class="team-logo" onerror="this.style.display='none'">` : ''}
                        <span class="team-name">${teams.away.name}</span>
                    </div>
                </div>
                ${odds ? renderOddsButtons(fix.id, odds, home, away, leagueName) : `<button class="load-odds-btn" onclick="loadSingleFixtureOdds(${fix.id})">ðŸ“Š Load Odds</button>`}
            </div>
        `;
    }).join('');
}

function renderOddsButtons(fixtureId, odds, home, away, league) {
    const isSelected = (market) => betslip.some(s => s.fixtureId === fixtureId && s.market === market);
    
    const oddBtn = (market, label, value) => {
        if (!value) return '';
        const selected = isSelected(market) ? 'selected' : '';
        return `<div class="odd-btn ${selected}" onclick="toggleSelection(${fixtureId}, '${market}', '${home}', '${away}', ${value}, '${league}')"><div class="odd-label">${label}</div><div class="odd-value">${value.toFixed(2)}</div></div>`;
    };

    let html = '';

    // ===== MATCH RESULT =====
    if (odds.home || odds.draw || odds.away) {
        html += `<div class="odds-section"><div class="odds-section-title">Match Result</div><div class="odds-grid">${oddBtn('home', '1', odds.home)}${oddBtn('draw', 'X', odds.draw)}${oddBtn('away', '2', odds.away)}</div></div>`;
    }

    // ===== DOUBLE CHANCE =====
    if (odds.homeOrDraw || odds.awayOrDraw || odds.homeOrAway) {
        html += `<div class="odds-section"><div class="odds-section-title">Double Chance</div><div class="odds-grid">${oddBtn('homeOrDraw', '1X', odds.homeOrDraw)}${oddBtn('homeOrAway', '12', odds.homeOrAway)}${oddBtn('awayOrDraw', 'X2', odds.awayOrDraw)}</div></div>`;
    }

    // ===== DRAW NO BET =====
    if (odds.dnbHome || odds.dnbAway) {
        html += `<div class="odds-section"><div class="odds-section-title">Draw No Bet</div><div class="odds-grid grid-2">${oddBtn('dnbHome', 'Home', odds.dnbHome)}${oddBtn('dnbAway', 'Away', odds.dnbAway)}</div></div>`;
    }

    // ===== ASIAN HANDICAP =====
    let ahHtml = '';
    if (odds.ahHome_minus25) ahHtml += oddBtn('ahHome_minus25', 'H -2.5', odds.ahHome_minus25);
    if (odds.ahHome_minus2) ahHtml += oddBtn('ahHome_minus2', 'H -2', odds.ahHome_minus2);
    if (odds.ahHome_minus15) ahHtml += oddBtn('ahHome_minus15', 'H -1.5', odds.ahHome_minus15);
    if (odds.ahHome_minus1) ahHtml += oddBtn('ahHome_minus1', 'H -1', odds.ahHome_minus1);
    if (odds.ahHome_minus05) ahHtml += oddBtn('ahHome_minus05', 'H -0.5', odds.ahHome_minus05);
    if (odds.ahHome_plus05) ahHtml += oddBtn('ahHome_plus05', 'H +0.5', odds.ahHome_plus05);
    if (odds.ahHome_plus1) ahHtml += oddBtn('ahHome_plus1', 'H +1', odds.ahHome_plus1);
    if (odds.ahHome_plus15) ahHtml += oddBtn('ahHome_plus15', 'H +1.5', odds.ahHome_plus15);
    if (odds.ahHome_plus2) ahHtml += oddBtn('ahHome_plus2', 'H +2', odds.ahHome_plus2);
    if (odds.ahAway_minus25) ahHtml += oddBtn('ahAway_minus25', 'A -2.5', odds.ahAway_minus25);
    if (odds.ahAway_minus2) ahHtml += oddBtn('ahAway_minus2', 'A -2', odds.ahAway_minus2);
    if (odds.ahAway_minus15) ahHtml += oddBtn('ahAway_minus15', 'A -1.5', odds.ahAway_minus15);
    if (odds.ahAway_minus1) ahHtml += oddBtn('ahAway_minus1', 'A -1', odds.ahAway_minus1);
    if (odds.ahAway_minus05) ahHtml += oddBtn('ahAway_minus05', 'A -0.5', odds.ahAway_minus05);
    if (odds.ahAway_plus05) ahHtml += oddBtn('ahAway_plus05', 'A +0.5', odds.ahAway_plus05);
    if (odds.ahAway_plus1) ahHtml += oddBtn('ahAway_plus1', 'A +1', odds.ahAway_plus1);
    if (odds.ahAway_plus15) ahHtml += oddBtn('ahAway_plus15', 'A +1.5', odds.ahAway_plus15);
    if (odds.ahAway_plus2) ahHtml += oddBtn('ahAway_plus2', 'A +2', odds.ahAway_plus2);
    if (ahHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Asian Handicap</div><div class="odds-grid grid-4">${ahHtml}</div></div>`;
    }

    // ===== GOALS OVER/UNDER (FULL TIME) =====
    let goalsHtml = '';
    if (odds.over05) goalsHtml += oddBtn('over05', 'O0.5', odds.over05);
    if (odds.over15) goalsHtml += oddBtn('over15', 'O1.5', odds.over15);
    if (odds.over25) goalsHtml += oddBtn('over25', 'O2.5', odds.over25);
    if (odds.over35) goalsHtml += oddBtn('over35', 'O3.5', odds.over35);
    if (odds.over45) goalsHtml += oddBtn('over45', 'O4.5', odds.over45);
    if (odds.over55) goalsHtml += oddBtn('over55', 'O5.5', odds.over55);
    if (odds.under05) goalsHtml += oddBtn('under05', 'U0.5', odds.under05);
    if (odds.under15) goalsHtml += oddBtn('under15', 'U1.5', odds.under15);
    if (odds.under25) goalsHtml += oddBtn('under25', 'U2.5', odds.under25);
    if (odds.under35) goalsHtml += oddBtn('under35', 'U3.5', odds.under35);
    if (odds.under45) goalsHtml += oddBtn('under45', 'U4.5', odds.under45);
    if (odds.under55) goalsHtml += oddBtn('under55', 'U5.5', odds.under55);
    if (goalsHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Goals Over/Under</div><div class="odds-grid grid-6">${goalsHtml}</div></div>`;
    }

    // ===== GOALS OVER/UNDER (FIRST HALF) =====
    let goalsFHHtml = '';
    if (odds.over05FH) goalsFHHtml += oddBtn('over05FH', 'O0.5', odds.over05FH);
    if (odds.over15FH) goalsFHHtml += oddBtn('over15FH', 'O1.5', odds.over15FH);
    if (odds.over25FH) goalsFHHtml += oddBtn('over25FH', 'O2.5', odds.over25FH);
    if (odds.under05FH) goalsFHHtml += oddBtn('under05FH', 'U0.5', odds.under05FH);
    if (odds.under15FH) goalsFHHtml += oddBtn('under15FH', 'U1.5', odds.under15FH);
    if (odds.under25FH) goalsFHHtml += oddBtn('under25FH', 'U2.5', odds.under25FH);
    if (goalsFHHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Goals - First Half</div><div class="odds-grid grid-6">${goalsFHHtml}</div></div>`;
    }

    // ===== GOALS OVER/UNDER (SECOND HALF) =====
    let goalsSHHtml = '';
    if (odds.over05SH) goalsSHHtml += oddBtn('over05SH', 'O0.5', odds.over05SH);
    if (odds.over15SH) goalsSHHtml += oddBtn('over15SH', 'O1.5', odds.over15SH);
    if (odds.over25SH) goalsSHHtml += oddBtn('over25SH', 'O2.5', odds.over25SH);
    if (odds.under05SH) goalsSHHtml += oddBtn('under05SH', 'U0.5', odds.under05SH);
    if (odds.under15SH) goalsSHHtml += oddBtn('under15SH', 'U1.5', odds.under15SH);
    if (odds.under25SH) goalsSHHtml += oddBtn('under25SH', 'U2.5', odds.under25SH);
    if (goalsSHHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Goals - Second Half</div><div class="odds-grid grid-6">${goalsSHHtml}</div></div>`;
    }

    // ===== BOTH TEAMS TO SCORE =====
    let bttsHtml = '';
    if (odds.bttsYes) bttsHtml += oddBtn('bttsYes', 'Yes', odds.bttsYes);
    if (odds.bttsNo) bttsHtml += oddBtn('bttsNo', 'No', odds.bttsNo);
    if (bttsHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Both Teams to Score</div><div class="odds-grid grid-2">${bttsHtml}</div></div>`;
    }

    // ===== BTTS - FIRST HALF =====
    let bttsFHHtml = '';
    if (odds.bttsFHYes) bttsFHHtml += oddBtn('bttsFHYes', 'Yes', odds.bttsFHYes);
    if (odds.bttsFHNo) bttsFHHtml += oddBtn('bttsFHNo', 'No', odds.bttsFHNo);
    if (bttsFHHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">BTTS - First Half</div><div class="odds-grid grid-2">${bttsFHHtml}</div></div>`;
    }

    // ===== BTTS - SECOND HALF =====
    let bttsSHHtml = '';
    if (odds.bttsSHYes) bttsSHHtml += oddBtn('bttsSHYes', 'Yes', odds.bttsSHYes);
    if (odds.bttsSHNo) bttsSHHtml += oddBtn('bttsSHNo', 'No', odds.bttsSHNo);
    if (bttsSHHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">BTTS - Second Half</div><div class="odds-grid grid-2">${bttsSHHtml}</div></div>`;
    }

    // ===== HALF TIME RESULT =====
    if (odds.htHome || odds.htDraw || odds.htAway) {
        html += `<div class="odds-section"><div class="odds-section-title">Half Time Result</div><div class="odds-grid">${oddBtn('htHome', '1', odds.htHome)}${oddBtn('htDraw', 'X', odds.htDraw)}${oddBtn('htAway', '2', odds.htAway)}</div></div>`;
    }

    // ===== SECOND HALF WINNER =====
    if (odds.shHome || odds.shDraw || odds.shAway) {
        html += `<div class="odds-section"><div class="odds-section-title">Second Half Winner</div><div class="odds-grid">${oddBtn('shHome', '1', odds.shHome)}${oddBtn('shDraw', 'X', odds.shDraw)}${oddBtn('shAway', '2', odds.shAway)}</div></div>`;
    }

    // ===== HOME TEAM GOALS =====
    let homeGoalsHtml = '';
    if (odds.homeOver05) homeGoalsHtml += oddBtn('homeOver05', 'O0.5', odds.homeOver05);
    if (odds.homeOver15) homeGoalsHtml += oddBtn('homeOver15', 'O1.5', odds.homeOver15);
    if (odds.homeOver25) homeGoalsHtml += oddBtn('homeOver25', 'O2.5', odds.homeOver25);
    if (odds.homeUnder05) homeGoalsHtml += oddBtn('homeUnder05', 'U0.5', odds.homeUnder05);
    if (odds.homeUnder15) homeGoalsHtml += oddBtn('homeUnder15', 'U1.5', odds.homeUnder15);
    if (odds.homeUnder25) homeGoalsHtml += oddBtn('homeUnder25', 'U2.5', odds.homeUnder25);
    if (homeGoalsHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Home Team Goals</div><div class="odds-grid grid-6">${homeGoalsHtml}</div></div>`;
    }

    // ===== AWAY TEAM GOALS =====
    let awayGoalsHtml = '';
    if (odds.awayOver05) awayGoalsHtml += oddBtn('awayOver05', 'O0.5', odds.awayOver05);
    if (odds.awayOver15) awayGoalsHtml += oddBtn('awayOver15', 'O1.5', odds.awayOver15);
    if (odds.awayOver25) awayGoalsHtml += oddBtn('awayOver25', 'O2.5', odds.awayOver25);
    if (odds.awayUnder05) awayGoalsHtml += oddBtn('awayUnder05', 'U0.5', odds.awayUnder05);
    if (odds.awayUnder15) awayGoalsHtml += oddBtn('awayUnder15', 'U1.5', odds.awayUnder15);
    if (odds.awayUnder25) awayGoalsHtml += oddBtn('awayUnder25', 'U2.5', odds.awayUnder25);
    if (awayGoalsHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Away Team Goals</div><div class="odds-grid grid-6">${awayGoalsHtml}</div></div>`;
    }

    // ===== CLEAN SHEET =====
    let csHtml = '';
    if (odds.csHome) csHtml += oddBtn('csHome', 'Home Yes', odds.csHome);
    if (odds.noCSHome) csHtml += oddBtn('noCSHome', 'Home No', odds.noCSHome);
    if (odds.csAway) csHtml += oddBtn('csAway', 'Away Yes', odds.csAway);
    if (odds.noCSAway) csHtml += oddBtn('noCSAway', 'Away No', odds.noCSAway);
    if (csHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Clean Sheet</div><div class="odds-grid grid-4">${csHtml}</div></div>`;
    }

    // ===== WIN TO NIL =====
    let wtnHtml = '';
    if (odds.wtnHome) wtnHtml += oddBtn('wtnHome', 'Home', odds.wtnHome);
    if (odds.wtnAway) wtnHtml += oddBtn('wtnAway', 'Away', odds.wtnAway);
    if (wtnHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Win to Nil</div><div class="odds-grid grid-2">${wtnHtml}</div></div>`;
    }

    // ===== SCORE BOTH HALVES =====
    let scoreBothHtml = '';
    if (odds.homeScoreBoth) scoreBothHtml += oddBtn('homeScoreBoth', 'Home', odds.homeScoreBoth);
    if (odds.awayScoreBoth) scoreBothHtml += oddBtn('awayScoreBoth', 'Away', odds.awayScoreBoth);
    if (scoreBothHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Score Both Halves</div><div class="odds-grid grid-2">${scoreBothHtml}</div></div>`;
    }

    // ===== WIN EITHER HALF =====
    let winEitherHtml = '';
    if (odds.homeWinEither) winEitherHtml += oddBtn('homeWinEither', 'Home', odds.homeWinEither);
    if (odds.awayWinEither) winEitherHtml += oddBtn('awayWinEither', 'Away', odds.awayWinEither);
    if (winEitherHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Win Either Half</div><div class="odds-grid grid-2">${winEitherHtml}</div></div>`;
    }

    // ===== ODD/EVEN =====
    if (odds.goalsOdd || odds.goalsEven) {
        html += `<div class="odds-section"><div class="odds-section-title">Odd/Even Goals</div><div class="odds-grid grid-2">${oddBtn('goalsOdd', 'Odd', odds.goalsOdd)}${oddBtn('goalsEven', 'Even', odds.goalsEven)}</div></div>`;
    }

    // ===== EXACT GOALS =====
    let exactHtml = '';
    if (odds.exactGoals0) exactHtml += oddBtn('exactGoals0', '0', odds.exactGoals0);
    if (odds.exactGoals1) exactHtml += oddBtn('exactGoals1', '1', odds.exactGoals1);
    if (odds.exactGoals2) exactHtml += oddBtn('exactGoals2', '2', odds.exactGoals2);
    if (odds.exactGoals3) exactHtml += oddBtn('exactGoals3', '3', odds.exactGoals3);
    if (odds.exactGoals4plus) exactHtml += oddBtn('exactGoals4plus', '4+', odds.exactGoals4plus);
    if (exactHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Exact Goals</div><div class="odds-grid grid-5">${exactHtml}</div></div>`;
    }

    // ===== HT/FT =====
    let htftHtml = '';
    if (odds.htft_1_1) htftHtml += oddBtn('htft_1_1', '1/1', odds.htft_1_1);
    if (odds.htft_1_X) htftHtml += oddBtn('htft_1_X', '1/X', odds.htft_1_X);
    if (odds.htft_1_2) htftHtml += oddBtn('htft_1_2', '1/2', odds.htft_1_2);
    if (odds.htft_X_1) htftHtml += oddBtn('htft_X_1', 'X/1', odds.htft_X_1);
    if (odds.htft_X_X) htftHtml += oddBtn('htft_X_X', 'X/X', odds.htft_X_X);
    if (odds.htft_X_2) htftHtml += oddBtn('htft_X_2', 'X/2', odds.htft_X_2);
    if (odds.htft_2_1) htftHtml += oddBtn('htft_2_1', '2/1', odds.htft_2_1);
    if (odds.htft_2_X) htftHtml += oddBtn('htft_2_X', '2/X', odds.htft_2_X);
    if (odds.htft_2_2) htftHtml += oddBtn('htft_2_2', '2/2', odds.htft_2_2);
    if (htftHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Half Time / Full Time</div><div class="odds-grid">${htftHtml}</div></div>`;
    }

    // ===== RESULT & BTTS =====
    let resBttsHtml = '';
    if (odds.homeAndBttsYes) resBttsHtml += oddBtn('homeAndBttsYes', 'H+Yes', odds.homeAndBttsYes);
    if (odds.homeAndBttsNo) resBttsHtml += oddBtn('homeAndBttsNo', 'H+No', odds.homeAndBttsNo);
    if (odds.drawAndBttsYes) resBttsHtml += oddBtn('drawAndBttsYes', 'D+Yes', odds.drawAndBttsYes);
    if (odds.awayAndBttsYes) resBttsHtml += oddBtn('awayAndBttsYes', 'A+Yes', odds.awayAndBttsYes);
    if (odds.awayAndBttsNo) resBttsHtml += oddBtn('awayAndBttsNo', 'A+No', odds.awayAndBttsNo);
    if (resBttsHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Result & BTTS</div><div class="odds-grid grid-5">${resBttsHtml}</div></div>`;
    }

    // ===== RESULT & OVER =====
    let resOverHtml = '';
    if (odds.homeAndOver15) resOverHtml += oddBtn('homeAndOver15', 'H+O1.5', odds.homeAndOver15);
    if (odds.homeAndOver25) resOverHtml += oddBtn('homeAndOver25', 'H+O2.5', odds.homeAndOver25);
    if (odds.drawAndOver15) resOverHtml += oddBtn('drawAndOver15', 'D+O1.5', odds.drawAndOver15);
    if (odds.drawAndOver25) resOverHtml += oddBtn('drawAndOver25', 'D+O2.5', odds.drawAndOver25);
    if (odds.awayAndOver15) resOverHtml += oddBtn('awayAndOver15', 'A+O1.5', odds.awayAndOver15);
    if (odds.awayAndOver25) resOverHtml += oddBtn('awayAndOver25', 'A+O2.5', odds.awayAndOver25);
    if (resOverHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Result & Over</div><div class="odds-grid grid-6">${resOverHtml}</div></div>`;
    }

    // ===== CORNERS =====
    let cornersHtml = '';
    if (odds.cornersOver75) cornersHtml += oddBtn('cornersOver75', 'O7.5', odds.cornersOver75);
    if (odds.cornersOver85) cornersHtml += oddBtn('cornersOver85', 'O8.5', odds.cornersOver85);
    if (odds.cornersOver95) cornersHtml += oddBtn('cornersOver95', 'O9.5', odds.cornersOver95);
    if (odds.cornersOver105) cornersHtml += oddBtn('cornersOver105', 'O10.5', odds.cornersOver105);
    if (odds.cornersUnder75) cornersHtml += oddBtn('cornersUnder75', 'U7.5', odds.cornersUnder75);
    if (odds.cornersUnder85) cornersHtml += oddBtn('cornersUnder85', 'U8.5', odds.cornersUnder85);
    if (odds.cornersUnder95) cornersHtml += oddBtn('cornersUnder95', 'U9.5', odds.cornersUnder95);
    if (odds.cornersUnder105) cornersHtml += oddBtn('cornersUnder105', 'U10.5', odds.cornersUnder105);
    if (cornersHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Corners</div><div class="odds-grid grid-4">${cornersHtml}</div></div>`;
    }

    // ===== CARDS =====
    let cardsHtml = '';
    if (odds.cardsOver25) cardsHtml += oddBtn('cardsOver25', 'O2.5', odds.cardsOver25);
    if (odds.cardsOver35) cardsHtml += oddBtn('cardsOver35', 'O3.5', odds.cardsOver35);
    if (odds.cardsOver45) cardsHtml += oddBtn('cardsOver45', 'O4.5', odds.cardsOver45);
    if (odds.cardsUnder25) cardsHtml += oddBtn('cardsUnder25', 'U2.5', odds.cardsUnder25);
    if (odds.cardsUnder35) cardsHtml += oddBtn('cardsUnder35', 'U3.5', odds.cardsUnder35);
    if (odds.cardsUnder45) cardsHtml += oddBtn('cardsUnder45', 'U4.5', odds.cardsUnder45);
    if (cardsHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Cards</div><div class="odds-grid grid-6">${cardsHtml}</div></div>`;
    }

    // ===== GOAL LINE (Asian Total) =====
    let glHtml = '';
    if (odds.gl_over15) glHtml += oddBtn('gl_over15', 'O1.5', odds.gl_over15);
    if (odds.gl_under15) glHtml += oddBtn('gl_under15', 'U1.5', odds.gl_under15);
    if (odds.gl_over25) glHtml += oddBtn('gl_over25', 'O2.5', odds.gl_over25);
    if (odds.gl_under25) glHtml += oddBtn('gl_under25', 'U2.5', odds.gl_under25);
    if (odds.gl_over35) glHtml += oddBtn('gl_over35', 'O3.5', odds.gl_over35);
    if (odds.gl_under35) glHtml += oddBtn('gl_under35', 'U3.5', odds.gl_under35);
    if (glHtml) {
        html += `<div class="odds-section"><div class="odds-section-title">Goal Line (Asian)</div><div class="odds-grid grid-6">${glHtml}</div></div>`;
    }

    // Bookmaker tag
    if (odds.bookmaker) {
        html += `<div class="bookmaker-tag">via ${odds.bookmaker}</div>`;
    }

    return html || '<div class="text-muted" style="font-size:0.7rem;text-align:center;padding:10px;">No odds available</div>';
}

// ============================================================
// BETSLIP
// ============================================================
function toggleSelection(fixtureId, market, home, away, odds, league) {
    const idx = betslip.findIndex(s => s.fixtureId === fixtureId && s.market === market);
    if (idx >= 0) {
        betslip.splice(idx, 1);
    } else {
        betslip.push({
            fixtureId,
            market,
            home,
            away,
            league,
            selection: MARKET_TYPES[market] || market,
            odds: parseFloat(odds.toFixed(2)),
            match: `${home} vs ${away}`
        });
    }
    applyFilters();
    renderBetslip();
}

function updateSlipLegOdds(index, newOdds) {
    const oddsValue = parseFloat(newOdds);
    if (oddsValue && oddsValue > 1) {
        betslip[index].odds = oddsValue;
        renderBetslip();
    }
}

function removeSlipLeg(index) {
    betslip.splice(index, 1);
    applyFilters();
    renderBetslip();
}

function clearBetslip() {
    betslip = [];
    applyFilters();
    renderBetslip();
}

function setConfidence(level) {
    selectedConfidence = level;
    renderBetslip();
}

function setStake(percentage) {
    const stake = challengeData.currentBalance * percentage;
    document.querySelectorAll('.betslip-stake-input').forEach(input => {
        input.value = stake.toFixed(2);
    });
    updateBetslipReturns();
}

function toggleMobileBetslip() {
    document.getElementById('mobileBetslipPanel').classList.toggle('open');
}

function renderBetslip() {
    const html = generateBetslipHTML();
    document.getElementById('desktopBetslipContent').innerHTML = html;
    document.getElementById('mobileBetslipContent').innerHTML = html;
    document.getElementById('desktopSlipCount').textContent = betslip.length;
    document.getElementById('mobileSlipCount').textContent = betslip.length;
    document.getElementById('mobileSlipCountInner').textContent = betslip.length;
    
    document.querySelectorAll('.betslip-stake-input').forEach(input => {
        if (!input.value || input.value === '0') {
            input.value = challengeData.currentBalance.toFixed(2);
        }
    });
}

function generateBetslipHTML() {
    if (betslip.length === 0) {
        return `<div class="betslip-empty"><div class="betslip-empty-icon">ðŸ“</div><p>Click on odds to add selections</p></div>`;
    }

    const combinedOdds = betslip.reduce((acc, s) => acc * s.odds, 1);
    const types = ['-', 'Single', 'Double', 'Treble', '4-Fold', '5-Fold', '6-Fold', '7-Fold', '8-Fold'];
    const betType = types[Math.min(betslip.length, 8)] || `${betslip.length}-Fold`;
    
    let legsHtml = betslip.map((s, i) => `
        <div class="betslip-leg">
            <button class="betslip-leg-remove" onclick="removeSlipLeg(${i})">Ã—</button>
            <div class="betslip-leg-match">${s.match}</div>
            <div class="betslip-leg-selection">${s.selection}</div>
            <div class="betslip-leg-odds-row">
                <span class="betslip-leg-odds-label">Odds:</span>
                <input type="number" class="betslip-leg-odds-input" value="${s.odds.toFixed(2)}" step="0.01" min="1.01" onchange="updateSlipLegOdds(${i}, this.value)">
            </div>
            <div class="betslip-leg-league">${s.league}</div>
        </div>
    `).join('');

    return `
        <div class="betslip-legs">${legsHtml}</div>
        <div class="betslip-summary">
            <div class="betslip-row"><span>Bet Type</span><span>${betType}</span></div>
            <div class="betslip-row"><span>Selections</span><span>${betslip.length}</span></div>
            <div class="betslip-row"><span>Combined Odds</span><span class="green" id="combinedOddsDisplay">${combinedOdds.toFixed(2)}</span></div>
            <div class="betslip-row"><span>Stake</span><input type="number" class="betslip-stake-input" step="0.01" min="0" oninput="updateBetslipReturns()"></div>
            <div class="stake-presets">
                <div class="stake-preset" onclick="setStake(0.25)">25%</div>
                <div class="stake-preset" onclick="setStake(0.5)">50%</div>
                <div class="stake-preset" onclick="setStake(0.75)">75%</div>
                <div class="stake-preset" onclick="setStake(1)">100%</div>
            </div>
            <div class="betslip-row total"><span>Potential Returns</span><span class="green" id="betslipReturns">Â£0.00</span></div>
            <div class="confidence-selector">
                <div class="confidence-label">Confidence Level</div>
                <div class="confidence-options">
                    <button class="confidence-btn low ${selectedConfidence === 'low' ? 'active' : ''}" onclick="setConfidence('low')">ðŸ”´ Low</button>
                    <button class="confidence-btn medium ${selectedConfidence === 'medium' ? 'active' : ''}" onclick="setConfidence('medium')">ðŸŸ  Med</button>
                    <button class="confidence-btn high ${selectedConfidence === 'high' ? 'active' : ''}" onclick="setConfidence('high')">ðŸŸ¢ High</button>
                </div>
            </div>
        </div>
        <button class="betslip-submit" onclick="placeBet()">ðŸ“ Place Bet</button>
    `;
}

function updateBetslipReturns() {
    const combinedOdds = betslip.reduce((acc, s) => acc * s.odds, 1);
    document.querySelectorAll('.betslip-stake-input').forEach(input => {
        const stake = parseFloat(input.value) || 0;
        const returns = stake * combinedOdds;
        document.querySelectorAll('#betslipReturns').forEach(el => el.textContent = formatCurrency(returns));
    });
    document.querySelectorAll('#combinedOddsDisplay').forEach(el => el.textContent = combinedOdds.toFixed(2));
}

function placeBet() {
    if (betslip.length === 0) return;
    const stakeInput = document.querySelector('.betslip-stake-input');
    const stake = parseFloat(stakeInput?.value) || 0;
    
    if (!stake || stake <= 0) { notify('Enter a valid stake', 'error'); return; }
    if (stake > challengeData.currentBalance) { notify('Stake exceeds balance!', 'error'); return; }

    const combinedOdds = betslip.reduce((acc, s) => acc * s.odds, 1);
    const types = ['', 'single', 'double', 'treble', 'accumulator'];
    const bet = {
        id: Date.now(),
        date: getToday(),
        type: types[Math.min(betslip.length, 4)] || 'accumulator',
        legs: betslip.map(s => ({ match: s.match, selection: s.selection, odds: s.odds, league: s.league, market: s.market })),
        selection: betslip.map(s => s.selection).join(' + '),
        competition: [...new Set(betslip.map(s => s.league))].join(' / '),
        odds: parseFloat(combinedOdds.toFixed(2)),
        stake,
        confidence: selectedConfidence,
        status: 'pending'
    };

    challengeData.pendingBets.push(bet);
    saveData();
    betslip = [];
    selectedConfidence = 'medium';
    applyFilters();
    renderBetslip();
    updateAllUI();
    document.getElementById('mobileBetslipPanel').classList.remove('open');
    notify(`${bet.type.charAt(0).toUpperCase() + bet.type.slice(1)} placed @ ${bet.odds.toFixed(2)}!`, 'success');
}

// ============================================================
// RESULT RECORDING
// ============================================================
function openResultModal(betId) {
    selectedBetId = betId;
    const bet = challengeData.pendingBets.find(b => b.id === betId);
    if (!bet) return;

    const legsHtml = bet.legs?.map(l => `<div style="padding:8px 0;border-bottom:1px solid var(--border-color);"><div style="font-size:0.75rem;color:var(--text-secondary);">${l.match}</div><div style="font-size:0.9rem;font-weight:600;">${l.selection}</div><div style="font-size:0.8rem;color:var(--accent-green);">@ ${l.odds.toFixed(2)}</div></div>`).join('') || `<div style="padding:10px 0;">${bet.selection}</div>`;

    document.getElementById('modalBetDetails').innerHTML = `
        <div style="margin-bottom:15px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                <span class="badge badge-pending">${bet.type}</span>
                <span class="badge badge-confidence ${bet.confidence}">${bet.confidence}</span>
            </div>
            ${legsHtml}
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border-color);">
                <div style="display:flex;justify-content:space-between;font-size:0.85rem;">
                    <span>Odds: <strong class="green">${bet.odds.toFixed(2)}</strong></span>
                    <span>Stake: <strong>${formatCurrency(bet.stake)}</strong></span>
                </div>
                <div style="text-align:right;font-size:1rem;margin-top:8px;">Returns: <strong class="green">${formatCurrency(bet.stake * bet.odds)}</strong></div>
            </div>
        </div>
    `;
    document.getElementById('modalFinalScore').value = '';
    document.getElementById('resultModal').classList.add('open');
}

function closeResultModal() {
    document.getElementById('resultModal').classList.remove('open');
    selectedBetId = null;
}

function recordResult(result) {
    const idx = challengeData.pendingBets.findIndex(b => b.id === selectedBetId);
    if (idx === -1) return;

    const bet = challengeData.pendingBets[idx];
    bet.status = result;
    bet.finalScore = document.getElementById('modalFinalScore').value;
    bet.day = challengeData.bets.length + 1;

    const dayTarget = getTarget(bet.day);

    if (result === 'won') {
        bet.returns = bet.stake * bet.odds;
        challengeData.currentBalance = bet.returns;
    } else if (result === 'void') {
        bet.returns = bet.stake;
    } else {
        bet.returns = 0;
        challengeData.currentBalance = 0;
    }

    bet.balanceAfter = challengeData.currentBalance;
    bet.targetForDay = dayTarget;
    bet.vsTarget = bet.balanceAfter - dayTarget;

    challengeData.bets.push(bet);
    challengeData.pendingBets.splice(idx, 1);
    saveData();
    closeResultModal();
    updateAllUI();

    if (result === 'won') {
        notify(`ðŸŽ‰ Won! Balance: ${formatCurrency(challengeData.currentBalance)}`, 'success');
        if (challengeData.currentBalance >= FINAL_TARGET) {
            setTimeout(() => notify('ðŸ† CHALLENGE COMPLETE! AMAZING!', 'success'), 1000);
        }
    } else if (result === 'void') {
        notify('Bet voided - stake returned', 'info');
    } else {
        notify('âŒ Challenge ended - good effort!', 'error');
    }
}

function cancelPendingBet(betId) {
    if (confirm('Cancel this bet?')) {
        challengeData.pendingBets = challengeData.pendingBets.filter(b => b.id !== betId);
        saveData();
        updateAllUI();
        notify('Bet cancelled', 'info');
    }
}

// ============================================================
// UI UPDATES
// ============================================================
function updateAllUI() {
    updateHeader();
    updateQuickStats();
    updateProgress();
    updateStrategy();
    updateMilestones();
    updateTargets();
    updateProbability();
    updateEnhancedAnalytics();
    updatePendingBets();
    updateHistory();
    updateChart();
    renderBetslip();
    generateSmartBets();
}

function updateHeader() {
    const day = Math.min(challengeData.bets.length + 1, TARGET_DAYS);
    document.getElementById('hDay').textContent = `Day ${day}`;
    document.getElementById('hBalance').textContent = formatCurrency(challengeData.currentBalance);
    
    const wins = challengeData.bets.filter(b => b.status === 'won').length;
    const total = challengeData.bets.filter(b => b.status !== 'void').length;
    const winRate = total > 0 ? Math.round(wins / total * 100) : 0;
    document.getElementById('hWinRate').textContent = `${winRate}%`;
    
    const isComplete = challengeData.currentBalance >= FINAL_TARGET;
    const isActive = challengeData.currentBalance > 0 && challengeData.bets.length < TARGET_DAYS;
    document.getElementById('hStatus').textContent = isComplete ? 'ðŸ†' : isActive ? 'ðŸŸ¢' : 'ðŸ”´';
}

function updateQuickStats() {
    const currentDay = challengeData.bets.length + 1;
    const dayTarget = getTarget(currentDay - 1);
    const nextTarget = getTarget(currentDay);
    const profit = challengeData.currentBalance - INITIAL_BALANCE;
    const vsTarget = challengeData.currentBalance - dayTarget;
    
    document.getElementById('qProfit').textContent = formatCurrency(profit);
    document.getElementById('qProfit').className = `quick-stat-value ${profit >= 0 ? 'green' : 'red'}`;
    
    document.getElementById('qTarget').textContent = formatCurrency(dayTarget);
    
    document.getElementById('qVsTarget').textContent = (vsTarget >= 0 ? '+' : '') + formatCurrency(vsTarget);
    document.getElementById('qVsTarget').className = `quick-stat-value ${vsTarget >= 0 ? 'green' : 'red'}`;
    
    const avgOdds = challengeData.bets.length > 0 
        ? challengeData.bets.reduce((a, b) => a + b.odds, 0) / challengeData.bets.length 
        : DAILY_MULTIPLIER;
    document.getElementById('qAvgOdds').textContent = avgOdds.toFixed(2);
    
    document.getElementById('qDaysLeft').textContent = Math.max(0, TARGET_DAYS - challengeData.bets.length);
    
    const roi = (profit / INITIAL_BALANCE * 100);
    document.getElementById('qROI').textContent = `${roi.toFixed(1)}%`;
    
    document.getElementById('qNextTarget').textContent = formatCurrency(nextTarget);
}

function updateProgress() {
    const pct = Math.min((challengeData.currentBalance / FINAL_TARGET) * 100, 100);
    document.getElementById('progressFill').style.width = `${Math.max(pct, 2)}%`;
    document.getElementById('progressFill').textContent = `${pct.toFixed(1)}%`;
    document.getElementById('progressPercent').textContent = `${pct.toFixed(1)}%`;

    let streakHtml = '';
    for (let i = 1; i <= TARGET_DAYS; i++) {
        const bet = challengeData.bets.find(b => b.day === i);
        let cls = 'streak-day streak-pending';
        let title = `Day ${i}: Pending`;
        
        if (bet) {
            if (bet.status === 'won') { cls = 'streak-day streak-won'; title = `Day ${i}: Won @ ${bet.odds.toFixed(2)}`; }
            else if (bet.status === 'lost') { cls = 'streak-day streak-lost'; title = `Day ${i}: Lost`; }
            else { cls = 'streak-day streak-void'; title = `Day ${i}: Void`; }
        }
        if (i === challengeData.bets.length + 1) cls += ' streak-current';
        
        streakHtml += `<div class="${cls}" title="${title}">${i}</div>`;
    }
    document.getElementById('streakDisplay').innerHTML = streakHtml;

    document.getElementById('mWins').textContent = challengeData.bets.filter(b => b.status === 'won').length;
    document.getElementById('mLosses').textContent = challengeData.bets.filter(b => b.status === 'lost').length;
    
    const wonBets = challengeData.bets.filter(b => b.status === 'won');
    if (wonBets.length > 0) {
        const best = wonBets.reduce((a, b) => (b.returns - b.stake) > (a.returns - a.stake) ? b : a);
        document.getElementById('mBestDay').textContent = `Day ${best.day}`;
    } else {
        document.getElementById('mBestDay').textContent = '-';
    }
    
    let streak = 0;
    for (let i = challengeData.bets.length - 1; i >= 0 && challengeData.bets[i].status === 'won'; i--) streak++;
    document.getElementById('mStreak').textContent = streak;
}

function updateStrategy() {
    const stake = challengeData.currentBalance;
    const currentDay = challengeData.bets.length + 1;
    const target = getTarget(currentDay);
    const minOdds = stake > 0 ? target / stake : DAILY_MULTIPLIER;
    const minProfit = target - stake;

    document.getElementById('stratStake').textContent = formatCurrency(stake);
    document.getElementById('stratMinOdds').textContent = minOdds.toFixed(2);
    document.getElementById('stratTarget').textContent = formatCurrency(target);
    document.getElementById('stratMinProfit').textContent = formatCurrency(minProfit);

    // Progressive strategy
    const progressive = getProgressiveStrategy(currentDay, stake, target);
    
    let recommendation = '';
    if (stake <= 0) {
        recommendation = 'Challenge ended. Consider starting fresh with the Reset button.';
    } else if (minOdds < 1.15) {
        recommendation = `You're ahead of target! You can afford safer picks at 1.10-1.20 odds. Consider double chance or heavy favorites.`;
    } else if (minOdds <= 1.25) {
        recommendation = `On track! Look for strong home wins around 1.20-1.30 odds, or Over 1.5 goals in attacking matchups.`;
    } else if (minOdds <= 1.40) {
        recommendation = `Need to catch up slightly. Consider combining a safe pick with Over 1.5 goals for better odds.`;
    } else if (minOdds <= 1.60) {
        recommendation = `Behind target. Look for value in away wins for strong teams or Over 2.5 in high-scoring leagues.`;
    } else {
        recommendation = `Significantly behind. May need to take calculated risks with doubles or higher odds singles.`;
    }
    
    // Add progressive strategy insights
    recommendation += `\n\nProgressive Strategy:\nâ€¢ Min Odds Needed: ${progressive.minOdds.toFixed(2)}\nâ€¢ Max Risk: ${(progressive.maxRisk * 100).toFixed(0)}%\nâ€¢ Suggested Markets: ${progressive.suggestedMarkets.join(', ')}`;
    
    document.getElementById('strategyText').textContent = recommendation;
}

function updateMilestones() {
    const balance = challengeData.currentBalance;
    let nextMilestone = MILESTONES.find(m => m.amount > balance);
    
    document.getElementById('milestonesList').innerHTML = MILESTONES.map(m => {
        const reached = balance >= m.amount;
        const isNext = m === nextMilestone;
        let progress = '';
        
        if (isNext && balance > 0) {
            const prevAmount = MILESTONES[MILESTONES.indexOf(m) - 1]?.amount || INITIAL_BALANCE;
            const pct = ((balance - prevAmount) / (m.amount - prevAmount) * 100);
            progress = `<div class="milestone-progress">${Math.max(0, pct).toFixed(0)}% there</div>`;
        }
        
        return `
            <div class="milestone-item ${reached ? 'reached' : ''} ${isNext ? 'next' : ''}">
                <div class="milestone-check ${reached ? 'reached' : 'pending'}">${reached ? 'âœ“' : m.emoji}</div>
                <div class="milestone-info">
                    <div class="milestone-amount">${formatCurrency(m.amount)}</div>
                    <div class="milestone-label">${m.label}</div>
                    ${progress}
                </div>
            </div>
        `;
    }).join('');
}

function updateTargets() {
    const currentDay = challengeData.bets.length + 1;
    let html = '';
    
    const startDay = Math.max(1, currentDay - 2);
    const endDay = Math.min(TARGET_DAYS, currentDay + 4);
    
    for (let d = startDay; d <= endDay; d++) {
        const target = getTarget(d);
        const bet = challengeData.bets.find(b => b.day === d);
        const isCurrent = d === currentDay;
        const isAchieved = bet && bet.status === 'won';
        const isFailed = bet && bet.status === 'lost';
        
        let status = '';
        let statusClass = '';
        if (isAchieved) {
            status = `âœ… ${formatCurrency(bet.balanceAfter)}`;
            statusClass = 'green';
        } else if (isFailed) {
            status = 'âŒ Failed';
            statusClass = 'red';
        } else if (isCurrent) {
            status = 'â³ Today';
            statusClass = 'orange';
        } else if (d > currentDay) {
            status = 'Upcoming';
            statusClass = 'text-muted';
        }
        
        html += `
            <div class="target-row ${isCurrent ? 'current' : ''} ${d < currentDay ? 'achieved' : ''}">
                <span class="target-day">Day ${d}</span>
                <span class="target-amount">${formatCurrency(target)}</span>
                <span class="target-status ${statusClass}">${status}</span>
            </div>
        `;
    }
    
    document.getElementById('targetsList').innerHTML = html;
}

function updateProbability() {
    const betsLeft = TARGET_DAYS - challengeData.bets.length;
    const wins = challengeData.bets.filter(b => b.status === 'won').length;
    const total = challengeData.bets.filter(b => b.status !== 'void').length;
    const currentWinRate = total > 0 ? wins / total : 0.833;
    
    const impliedProbPerBet = 1 / DAILY_MULTIPLIER;
    const successProb = Math.pow(currentWinRate > 0 ? Math.min(currentWinRate, 0.95) : impliedProbPerBet, betsLeft) * 100;
    
    document.getElementById('successProb').textContent = `${Math.min(successProb, 99.9).toFixed(1)}%`;
    document.getElementById('betsRemaining').textContent = betsLeft;
    document.getElementById('requiredWinRate').textContent = `${betsLeft}/${betsLeft}`;
    document.getElementById('impliedProb').textContent = `${(impliedProbPerBet * 100).toFixed(1)}%`;
    
    const edge = currentWinRate - impliedProbPerBet;
    if (edge > 0 && challengeData.currentBalance > 0) {
        const kelly = (edge / (DAILY_MULTIPLIER - 1)) * 100;
        document.getElementById('kellyStake').textContent = kelly > 100 ? 'Full' : `${kelly.toFixed(0)}%`;
    } else {
        document.getElementById('kellyStake').textContent = challengeData.currentBalance > 0 ? 'Full' : '-';
    }
    
    const riskLevel = Math.min(100, Math.max(0, 100 - successProb));
    document.getElementById('riskIndicator').style.left = `${riskLevel}%`;
}

function updatePendingBets() {
    const container = document.getElementById('pendingBetsContainer');
    
    if (!challengeData.pendingBets.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ðŸ“­</div><p>No pending bets</p></div>';
        return;
    }
    
    container.innerHTML = challengeData.pendingBets.map(b => `
        <div class="pending-bet">
            <div class="pending-header">
                <span class="badge badge-pending">${b.type}</span>
                <span class="badge badge-confidence ${b.confidence}">${b.confidence}</span>
            </div>
            <div class="pending-legs">
                ${b.legs.map(l => `
                    <div class="pending-leg">
                        <strong>${l.selection}</strong> @ <span class="green">${l.odds.toFixed(2)}</span>
                        <br><span class="text-muted">${l.match}</span>
                    </div>
                `).join('')}
            </div>
            <div class="pending-summary">
                <span>Combined: <strong class="green">${b.odds.toFixed(2)}</strong></span>
                <span>${formatCurrency(b.stake)} â†’ <strong class="green">${formatCurrency(b.stake * b.odds)}</strong></span>
            </div>
            <div class="btn-group">
                <button class="btn btn-sm btn-success" onclick="openResultModal(${b.id})">âœ… Record Result</button>
                <button class="btn btn-sm btn-secondary" onclick="cancelPendingBet(${b.id})">âŒ Cancel</button>
            </div>
        </div>
    `).join('');
}

function updateHistory() {
    const tbody = document.getElementById('historyTableBody');
    
    if (!challengeData.bets.length) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-muted" style="text-align:center;padding:20px;">No bets recorded yet</td></tr>';
        return;
    }
    
    tbody.innerHTML = challengeData.bets.map(b => {
        const vsTargetClass = b.vsTarget >= 0 ? 'green' : 'red';
        const vsTargetSign = b.vsTarget >= 0 ? '+' : '';
        const returnsClass = b.returns > b.stake ? 'green' : 'red';
        
        return `
            <tr>
                <td><strong>${b.day}</strong></td>
                <td>${b.date}</td>
                <td title="${b.selection}">${b.selection.length > 20 ? b.selection.substring(0, 20) + '...' : b.selection}</td>
                <td>${b.type}</td>
                <td><span class="badge badge-confidence ${b.confidence}">${(b.confidence || 'med').charAt(0).toUpperCase()}</span></td>
                <td><strong>${b.odds.toFixed(2)}</strong></td>
                <td>${formatCurrency(b.stake)}</td>
                <td><span class="badge badge-${b.status}">${b.status}</span></td>
                <td class="${returnsClass}">${formatCurrency(b.returns)}</td>
                <td><strong>${formatCurrency(b.balanceAfter)}</strong></td>
                <td class="${vsTargetClass}">${vsTargetSign}${formatCurrency(b.vsTarget)}</td>
            </tr>
        `;
    }).join('');
}

function updateChart() {
    const ctx = document.getElementById('balanceChart');
    if (!ctx) return;
    
    if (window.balanceChartInstance) {
        window.balanceChartInstance.destroy();
    }

    // Actual balance data
    const actualData = [{ x: 0, y: INITIAL_BALANCE }];
    challengeData.bets.forEach(b => {
        actualData.push({ x: b.day, y: b.balanceAfter });
    });

    // Target line data
    const targetData = [];
    for (let i = 0; i <= TARGET_DAYS; i++) {
        targetData.push({ x: i, y: getTarget(i) });
    }

    const isDarkMode = document.documentElement.getAttribute('data-theme') !== 'light';
    const gridColor = isDarkMode ? '#2d2d4a' : '#e0e0e0';
    const textColor = isDarkMode ? '#b0b0c0' : '#666';

    window.balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Your Balance',
                    data: actualData,
                    borderColor: '#00d4aa',
                    backgroundColor: 'rgba(0, 212, 170, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointBackgroundColor: '#00d4aa',
                    borderWidth: 3
                },
                {
                    label: 'Target',
                    data: targetData,
                    borderColor: '#54a0ff',
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    labels: {
                        color: textColor,
                        font: { size: 10 }
                    }
                },
                tooltip: {
                    backgroundColor: isDarkMode ? '#1a1a2e' : '#fff',
                    titleColor: isDarkMode ? '#fff' : '#333',
                    bodyColor: textColor,
                    borderColor: gridColor,
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: Â£${context.parsed.y.toFixed(0)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    min: 0,
                    max: TARGET_DAYS,
                    ticks: {
                        color: textColor,
                        font: { size: 9 },
                        stepSize: 3
                    },
                    grid: { color: gridColor },
                    title: {
                        display: true,
                        text: 'Day',
                        color: textColor,
                        font: { size: 9 }
                    }
                },
                y: {
                    ticks: {
                        color: textColor,
                        font: { size: 9 },
                        callback: v => v >= 1000 ? `${(v / 1000).toFixed(1)}k` : v
                    },
                    grid: { color: gridColor },
                    min: 0,
                    title: {
                        display: true,
                        text: 'Balance (Â£)',
                        color: textColor,
                        font: { size: 9 }
                    }
                }
            }
        }
    });
}

// ============================================================
// INITIALIZATION
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    console.log('ðŸŽ¯ 21-Day Betting Challenge starting...');
    
    // Load saved data
    loadData();
    
    // Initialize Firebase
    initFirebase();
    
    // Set default date
    document.getElementById('dateFilter').value = getToday();
    
    // Load fixtures
    loadFixtures();
    
    // Update all UI
    updateAllUI();
    
    console.log(`âœ… App initialized. Day ${challengeData.bets.length + 1} | Balance: ${formatCurrency(challengeData.currentBalance)}`);
});

// ============================================================
// AUTO-REFRESH (Every 30 minutes)
// ============================================================
setInterval(() => {
    if (!document.hidden && !fixturesLoading) {
        console.log('Auto-refreshing fixtures...');
        loadFixtures();
    }
}, 30 * 60 * 1000);

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
    // Escape to close modals
    if (e.key === 'Escape') {
        closeResultModal();
        closeApiStatus();
        document.getElementById('mobileBetslipPanel').classList.remove('open');
    }
    // Ctrl/Cmd + R to refresh fixtures
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
        e.preventDefault();
        refreshFixtures();
    }
});

// ============================================================
// VISIBILITY CHANGE (Refresh when tab becomes visible)
// ============================================================
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        updateAllUI();
    }
});
</script>
</body>
</html>
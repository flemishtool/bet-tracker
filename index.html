<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bet Tracker">
    <meta name="theme-color" content="#0f0f1a">
    <title>21-Day Betting Challenge</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent-green: #00d4aa;
            --accent-orange: #ff9f43;
            --accent-red: #ff6b6b;
            --accent-blue: #54a0ff;
            --accent-purple: #a55eea;
            --accent-yellow: #feca57;
            --text-primary: #ffffff;
            --text-secondary: #b0b0c0;
            --border-color: #333355;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 12px;
            padding-bottom: 80px;
            line-height: 1.4;
        }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 12px;
        }

        .dashboard-header h1 {
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-stats { display: flex; gap: 12px; flex-wrap: wrap; }
        .header-stat { text-align: center; min-width: 60px; }
        .header-stat-value { font-size: 1rem; font-weight: bold; color: var(--accent-green); }
        .header-stat-label { font-size: 0.6rem; color: var(--text-secondary); text-transform: uppercase; }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border-radius: 15px;
        }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; }
        .sync-dot.synced { background: var(--accent-green); }
        .sync-dot.syncing { background: var(--accent-orange); animation: pulse 1s infinite; }
        .sync-dot.offline { background: var(--accent-red); }

        /* Quick Stats */
        .quick-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .quick-stat {
            background: var(--bg-secondary);
            padding: 10px 14px;
            border-radius: 8px;
            text-align: center;
            min-width: 85px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }

        .quick-stat-value { font-size: 1rem; font-weight: bold; }
        .quick-stat-label { font-size: 0.55rem; color: var(--text-secondary); margin-top: 2px; text-transform: uppercase; }

        /* Grid */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title { font-size: 0.9rem; font-weight: 600; }
        .card-actions { display: flex; gap: 6px; align-items: center; }

        /* Filters */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 0.6rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .filter-select, .filter-input {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.75rem;
            min-width: 100px;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        /* League Tabs - Scrollable */
        .tabs-container {
            position: relative;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 6px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .tabs::-webkit-scrollbar { display: none; }

        .tab {
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 5px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.7rem;
            white-space: nowrap;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .tab:hover { background: var(--border-color); }
        .tab.active { background: var(--accent-green); color: var(--bg-primary); }

        /* Match Cards */
        .fixtures-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .match-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }

        .match-card:hover { border-color: var(--accent-blue); }
        .match-card.selected { border-color: var(--accent-green); background: rgba(0, 212, 170, 0.1); }
        .match-card.in-betslip { border-color: var(--accent-orange); }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .match-league {
            font-size: 0.55rem;
            color: var(--accent-blue);
            text-transform: uppercase;
            font-weight: 600;
        }

        .match-time { font-size: 0.65rem; color: var(--text-secondary); }

        .match-teams {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 8px;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
        }

        .team-info.away { flex-direction: row-reverse; text-align: right; }

        .team-logo {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            object-fit: contain;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .team-name {
            font-weight: 600;
            font-size: 0.75rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .match-score {
            font-size: 1rem;
            font-weight: bold;
            padding: 0 8px;
            flex-shrink: 0;
        }

        /* Odds Buttons */
        .odds-row {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .odd-btn {
            flex: 1;
            min-width: 55px;
            padding: 6px 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .odd-btn:hover { border-color: var(--accent-green); background: rgba(0, 212, 170, 0.1); }
        .odd-btn.selected { background: var(--accent-green); color: var(--bg-primary); border-color: var(--accent-green); }
        .odd-btn.in-betslip { background: var(--accent-orange); color: var(--bg-primary); border-color: var(--accent-orange); }

        .odd-label { font-size: 0.5rem; color: var(--text-secondary); margin-bottom: 2px; }
        .odd-btn.selected .odd-label, .odd-btn.in-betslip .odd-label { color: var(--bg-primary); }
        .odd-value { font-weight: bold; font-size: 0.8rem; }
        .odd-value.loading { color: var(--text-secondary); }

        /* Betslip */
        .betslip {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 2px solid var(--accent-green);
            padding: 12px;
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            max-height: 60vh;
            overflow-y: auto;
        }

        .betslip.open { transform: translateY(0); }

        .betslip-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white;
            border: none;
            border-radius: 50px;
            padding: 12px 20px;
            font-weight: bold;
            cursor: pointer;
            z-index: 101;
            box-shadow: 0 4px 15px rgba(0, 212, 170, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .betslip-toggle .count {
            background: white;
            color: var(--bg-primary);
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .betslip-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .betslip-title { font-weight: 600; font-size: 0.95rem; }
        .betslip-clear { color: var(--accent-red); cursor: pointer; font-size: 0.75rem; }

        .betslip-leg {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            position: relative;
        }

        .betslip-leg-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--accent-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .betslip-leg-match { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 3px; }
        .betslip-leg-selection { font-weight: 600; font-size: 0.8rem; margin-bottom: 2px; }
        .betslip-leg-odds { color: var(--accent-green); font-size: 0.75rem; }

        .betslip-summary {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .betslip-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .betslip-row.total { font-weight: bold; font-size: 0.9rem; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); }

        .betslip-input {
            width: 100px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            text-align: right;
            font-size: 0.85rem;
        }

        .betslip-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 12px;
        }

        .betslip-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Form Elements */
        .form-group { margin-bottom: 10px; }
        .form-label { display: block; margin-bottom: 4px; font-size: 0.75rem; color: var(--text-secondary); }

        .form-input, .form-select {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        /* Buttons */
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary { background: linear-gradient(135deg, var(--accent-green), var(--accent-blue)); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-success { background: var(--accent-green); color: var(--bg-primary); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-warning { background: var(--accent-orange); color: var(--bg-primary); }
        .btn-sm { padding: 4px 8px; font-size: 0.7rem; }

        .btn-group { display: flex; gap: 6px; margin-top: 10px; }
        .btn-group .btn { flex: 1; }

        /* Tables */
        .table-container { overflow-x: auto; max-height: 300px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 6px 5px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.7rem; }
        th { background: var(--bg-tertiary); font-weight: 600; font-size: 0.6rem; text-transform: uppercase; color: var(--text-secondary); position: sticky; top: 0; z-index: 5; }

        /* Status Badges */
        .badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.55rem;
            font-weight: 600;
        }

        .badge-won { background: rgba(0, 212, 170, 0.2); color: var(--accent-green); }
        .badge-lost { background: rgba(255, 107, 107, 0.2); color: var(--accent-red); }
        .badge-pending { background: rgba(255, 159, 67, 0.2); color: var(--accent-orange); }
        .badge-void { background: rgba(176, 176, 192, 0.2); color: var(--text-secondary); }
        .badge-live { background: rgba(255, 107, 107, 0.3); color: var(--accent-red); animation: pulse 1.5s infinite; }

        /* Progress */
        .progress-bar {
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            min-width: 35px;
            transition: width 0.5s ease;
        }

        /* Streak Display */
        .streak-display { display: flex; gap: 3px; flex-wrap: wrap; margin: 10px 0; }

        .streak-day {
            width: 22px;
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            font-weight: bold;
        }

        .streak-won { background: var(--accent-green); color: var(--bg-primary); }
        .streak-lost { background: var(--accent-red); color: white; }
        .streak-void { background: var(--text-secondary); color: var(--bg-primary); }
        .streak-pending { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px dashed var(--border-color); }
        .streak-current { border: 2px solid white !important; }

        /* Metrics Grid */
        .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .metric-box {
            background: var(--bg-tertiary);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .metric-value { font-size: 1.1rem; font-weight: bold; }
        .metric-label { font-size: 0.55rem; color: var(--text-secondary); text-transform: uppercase; }

        /* Colors */
        .green { color: var(--accent-green); }
        .red { color: var(--accent-red); }
        .orange { color: var(--accent-orange); }
        .blue { color: var(--accent-blue); }
        .purple { color: var(--accent-purple); }
        .yellow { color: var(--accent-yellow); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            max-width: 400px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.3rem;
            cursor: pointer;
        }

        /* Loading & Empty States */
        .loading { display: flex; justify-content: center; align-items: center; padding: 25px; }

        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.8rem; }
        .empty-state-icon { font-size: 2rem; margin-bottom: 8px; }

        /* Notifications */
        .notification {
            position: fixed;
            top: 15px;
            left: 15px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            animation: slideDown 0.3s ease;
            font-size: 0.8rem;
            text-align: center;
        }

        .notification-success { background: var(--accent-green); }
        .notification-error { background: var(--accent-red); }
        .notification-warning { background: var(--accent-orange); }
        .notification-info { background: var(--accent-blue); }

        /* Animations */
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Chart */
        .chart-container { position: relative; height: 180px; }

        /* Full Width */
        .full-width { grid-column: 1 / -1; }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 8px; padding-bottom: 100px; }
            .dashboard-header { flex-direction: column; text-align: center; }
            .grid-container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .betslip { max-height: 70vh; }
            .filter-bar { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-select { width: 100%; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }

        /* API Status */
        .api-status { display: flex; align-items: center; gap: 5px; font-size: 0.65rem; }
        .api-dot { width: 7px; height: 7px; border-radius: 50%; }
        .api-dot.online { background: var(--accent-green); }
        .api-dot.offline { background: var(--accent-red); }
        .api-dot.loading { background: var(--accent-orange); animation: pulse 1s infinite; }

        /* Cache Info */
        .cache-info {
            font-size: 0.6rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="dashboard-header">
        <h1>üéØ 21-Day Challenge</h1>
        <div class="sync-status" id="syncStatus">
            <div class="sync-dot offline" id="syncDot"></div>
            <span id="syncText">Local Only</span>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="currentDay">Day 1</div>
                <div class="header-stat-label">Day</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="currentBalance">¬£200</div>
                <div class="header-stat-label">Balance</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value green" id="winRate">0%</div>
                <div class="header-stat-label">Win Rate</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="challengeStatus">üü¢</div>
                <div class="header-stat-label">Status</div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-value green" id="totalProfit">¬£0</div>
            <div class="quick-stat-label">Profit</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value blue" id="targetToday">¬£240</div>
            <div class="quick-stat-label">Target</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value orange" id="daysAhead">0</div>
            <div class="quick-stat-label">Days +/-</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value purple" id="avgOdds">1.20</div>
            <div class="quick-stat-label">Avg Odds</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value" id="remainingDays">21</div>
            <div class="quick-stat-label">Left</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value yellow" id="roiDisplay">0%</div>
            <div class="quick-stat-label">ROI</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid-container">
        <!-- Fixtures Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">‚öΩ Fixtures</span>
                <div class="card-actions">
                    <div class="api-status">
                        <div class="api-dot loading" id="apiDot"></div>
                        <span id="apiText">Loading</span>
                    </div>
                    <div class="cache-info" id="cacheInfo"></div>
                    <button class="btn btn-sm btn-secondary" onclick="refreshFixtures(true)">üîÑ</button>
                </div>
            </div>

            <!-- Filters -->
            <div class="filter-bar">
                <div class="filter-group">
                    <span class="filter-label">Date</span>
                    <input type="date" class="filter-input" id="filterDate" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Odds Min</span>
                    <input type="number" class="filter-input" id="filterOddsMin" placeholder="1.01" step="0.01" min="1.01" style="width:70px" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Odds Max</span>
                    <input type="number" class="filter-input" id="filterOddsMax" placeholder="10.00" step="0.01" min="1.01" style="width:70px" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <span class="filter-label">Sort By</span>
                    <select class="filter-select" id="filterSort" onchange="applyFilters()">
                        <option value="time">Kickoff Time</option>
                        <option value="odds-low">Odds: Low ‚Üí High</option>
                        <option value="odds-high">Odds: High ‚Üí Low</option>
                        <option value="league">League</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <select class="filter-select" id="filterStatus" onchange="applyFilters()">
                        <option value="all">All</option>
                        <option value="upcoming">Upcoming</option>
                        <option value="live">Live</option>
                        <option value="finished">Finished</option>
                    </select>
                </div>
            </div>

            <!-- League Tabs -->
            <div class="tabs-container">
                <div class="tabs" id="leagueTabs"></div>
            </div>

            <!-- Fixtures List -->
            <div class="fixtures-container" id="fixturesContainer">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìà Progress</span>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 2.2%">2.2%</div>
            </div>

            <div class="streak-display" id="streakDisplay"></div>

            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-value green" id="winCount">0</div>
                    <div class="metric-label">Wins</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value red" id="lossCount">0</div>
                    <div class="metric-label">Losses</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value blue" id="bestDay">-</div>
                    <div class="metric-label">Best Day</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value orange" id="currentStreak">0</div>
                    <div class="metric-label">Streak</div>
                </div>
            </div>
        </div>

        <!-- Pending Bets Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">‚è≥ Pending Bets</span>
            </div>
            <div id="pendingBets">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No pending bets</p>
                </div>
            </div>
        </div>

        <!-- Chart Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìä Balance Chart</span>
            </div>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <!-- History Card -->
        <div class="card full-width">
            <div class="card-header">
                <span class="card-title">üìú History</span>
                <div class="card-actions">
                    <button class="btn btn-sm btn-secondary" onclick="exportData()">üì§ Export</button>
                    <button class="btn btn-sm btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                    <button class="btn btn-sm btn-danger" onclick="confirmReset()">üóëÔ∏è</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Day</th>
                            <th>Date</th>
                            <th>Selection</th>
                            <th>Type</th>
                            <th>Odds</th>
                            <th>Stake</th>
                            <th>Result</th>
                            <th>Returns</th>
                            <th>Balance</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Betslip Toggle Button -->
    <button class="betslip-toggle" id="betslipToggle" onclick="toggleBetslip()">
        üé´ Betslip
        <span class="count" id="betslipCount">0</span>
    </button>

    <!-- Betslip Panel -->
    <div class="betslip" id="betslip">
        <div class="betslip-header">
            <span class="betslip-title">üé´ Betslip</span>
            <span class="betslip-clear" onclick="clearBetslip()">Clear All</span>
        </div>
        
        <div id="betslipLegs"></div>
        
        <div class="betslip-summary">
            <div class="betslip-row">
                <span>Bet Type</span>
                <span id="betslipType">Single</span>
            </div>
            <div class="betslip-row">
                <span>Selections</span>
                <span id="betslipSelections">0</span>
            </div>
            <div class="betslip-row">
                <span>Combined Odds</span>
                <span class="green" id="betslipOdds">1.00</span>
            </div>
            <div class="betslip-row">
                <span>Stake ¬£</span>
                <input type="number" class="betslip-input" id="betslipStake" step="0.01" min="0" oninput="updateBetslipReturns()">
            </div>
            <div class="betslip-row total">
                <span>Potential Returns</span>
                <span class="green" id="betslipReturns">¬£0.00</span>
            </div>
        </div>
        
        <div class="form-group" style="margin-top:10px">
            <label class="form-label">Notes (Optional)</label>
            <input type="text" class="form-input" id="betslipNotes" placeholder="Why this bet?">
        </div>
        
        <button class="betslip-submit" id="betslipSubmit" onclick="placeBet()" disabled>
            üìù Place Bet
        </button>
    </div>

    <!-- Result Modal -->
    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div class="modal-header">
                <h3 style="font-size:1rem">Record Result</h3>
                <button class="modal-close" onclick="closeModal('resultModal')">&times;</button>
            </div>
            <div id="modalBetDetails"></div>
            <div class="form-group">
                <label class="form-label">Final Score(s)</label>
                <input type="text" class="form-input" id="finalScore" placeholder="e.g., 2-1, 3-0">
            </div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="recordResult('won')">‚úÖ WON</button>
                <button class="btn btn-danger" onclick="recordResult('lost')">‚ùå LOST</button>
            </div>
            <button class="btn btn-secondary" onclick="recordResult('void')" style="width:100%;margin-top:8px">‚ö™ VOID</button>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        
        // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD-MH_oSRLM53UHe2sPB4bXRjsEcXEm9IM",
  authDomain: "bet-tracker-d819b.firebaseapp.com",
  databaseURL: "https://bet-tracker-d819b-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "bet-tracker-d819b",
  storageBucket: "bet-tracker-d819b.firebasestorage.app",
  messagingSenderId: "556598232550",
  appId: "1:556598232550:web:2921e82966b16bf7520227"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        
        // API-Football Config
        const API_KEY = '89d2f65b7dc64f8d0fce8468e2a8af2b';
        const API_BASE = 'https://v3.football.api-sports.io';
        
        // Challenge Config
        const INITIAL_BALANCE = 200;
        const DAILY_MULTIPLIER = 1.20;
        const TARGET_DAYS = 21;
        const FINAL_TARGET = INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, TARGET_DAYS);
        
        // Cache Config
        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes
        const ODDS_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes for odds
        
        // Leagues Configuration
        const LEAGUES = {
            // Top 5 Leagues
            39: { name: 'Premier League', short: 'EPL', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', priority: 1 },
            140: { name: 'La Liga', short: 'Liga', flag: 'üá™üá∏', priority: 2 },
            78: { name: 'Bundesliga', short: 'Bund', flag: 'üá©üá™', priority: 3 },
            135: { name: 'Serie A', short: 'Serie', flag: 'üáÆüáπ', priority: 4 },
            61: { name: 'Ligue 1', short: 'L1', flag: 'üá´üá∑', priority: 5 },
            
            // Second Tier
            40: { name: 'Championship', short: 'Champ', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', priority: 6 },
            141: { name: 'La Liga 2', short: 'Liga2', flag: 'üá™üá∏', priority: 7 },
            79: { name: '2. Bundesliga', short: 'Bund2', flag: 'üá©üá™', priority: 8 },
            136: { name: 'Serie B', short: 'SerieB', flag: 'üáÆüáπ', priority: 9 },
            62: { name: 'Ligue 2', short: 'L2', flag: 'üá´üá∑', priority: 10 },
            
            // Other Top Leagues
            94: { name: 'Primeira Liga', short: 'PT Liga', flag: 'üáµüáπ', priority: 11 },
            88: { name: 'Eredivisie', short: 'Ere', flag: 'üá≥üá±', priority: 12 },
            144: { name: 'Jupiler Pro', short: 'BEL', flag: 'üáßüá™', priority: 13 },
            203: { name: 'S√ºper Lig', short: 'TSL', flag: 'üáπüá∑', priority: 14 },
            179: { name: 'Premiership', short: 'SPFL', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', priority: 15 },
            218: { name: 'Bundesliga AT', short: 'AUT', flag: 'üá¶üáπ', priority: 16 },
            207: { name: 'Super League', short: 'SUI', flag: 'üá®üá≠', priority: 17 },
            119: { name: 'Superliga', short: 'DEN', flag: 'üá©üá∞', priority: 18 },
            197: { name: 'Super League', short: 'GRE', flag: 'üá¨üá∑', priority: 19 },
            307: { name: 'Saudi Pro', short: 'SPL', flag: 'üá∏üá¶', priority: 20 },
            
            // Cups
            45: { name: 'FA Cup', short: 'FA', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', priority: 21, cup: true },
            48: { name: 'EFL Cup', short: 'EFL', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', priority: 22, cup: true },
            143: { name: 'Copa del Rey', short: 'Copa', flag: 'üá™üá∏', priority: 23, cup: true },
            81: { name: 'DFB Pokal', short: 'DFB', flag: 'üá©üá™', priority: 24, cup: true },
            137: { name: 'Coppa Italia', short: 'CoppaIT', flag: 'üáÆüáπ', priority: 25, cup: true },
            66: { name: 'Coupe de France', short: 'CdF', flag: 'üá´üá∑', priority: 26, cup: true },
            96: { name: 'Ta√ßa de Portugal', short: 'Taca', flag: 'üáµüáπ', priority: 27, cup: true },
            
            // European
            2: { name: 'Champions League', short: 'UCL', flag: 'üèÜ', priority: 28 },
            3: { name: 'Europa League', short: 'UEL', flag: 'üèÜ', priority: 29 },
            848: { name: 'Conference League', short: 'UECL', flag: 'üèÜ', priority: 30 },
            
            // Friendlies
            667: { name: 'Club Friendlies', short: 'Friendly', flag: '‚öΩ', priority: 100 }
        };
        
        const LEAGUE_IDS = Object.keys(LEAGUES).map(Number);
        
        // ==================== STATE ====================
        
        let db = null;
        let userId = null;
        let isOnline = false;
        
        let challengeData = {
            startDate: null,
            currentBalance: INITIAL_BALANCE,
            bets: [],
            pendingBets: [],
            settings: { initialBalance: INITIAL_BALANCE, dailyTarget: DAILY_MULTIPLIER, targetDays: TARGET_DAYS }
        };
        
        let fixturesCache = {
            data: [],
            timestamp: 0,
            oddsLoaded: false
        };
        
        let oddsCache = {};
        
        let betslip = [];
        let allFixtures = [];
        let filteredFixtures = [];
        let currentLeagueFilter = 'all';
        
        // ==================== UTILITIES ====================
        
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
        
        function showNotification(msg, type = 'info') {
            document.querySelectorAll('.notification').forEach(n => n.remove());
            const n = document.createElement('div');
            n.className = `notification notification-${type}`;
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 4000);
        }
        
        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        }
        
        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        }
        
        // ==================== FIREBASE ====================
        
        function initFirebase() {
            try {
                // Check if config is set
                if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.log('Firebase not configured - using local storage only');
                    updateSyncStatus('offline', 'Local Only');
                    return;
                }
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                // Generate/get user ID
                userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('userId', userId);
                }
                
                // Listen for data changes
                db.ref(`challenges/${userId}`).on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        challengeData = data;
                        updateUI();
                        console.log('Data synced from cloud');
                    }
                    updateSyncStatus('synced', 'Synced');
                    isOnline = true;
                });
                
                // Connection state
                db.ref('.info/connected').on('value', (snap) => {
                    if (snap.val() === true) {
                        updateSyncStatus('synced', 'Synced');
                        isOnline = true;
                    } else {
                        updateSyncStatus('offline', 'Offline');
                        isOnline = false;
                    }
                });
                
                console.log('Firebase initialized');
                
            } catch (e) {
                console.error('Firebase init error:', e);
                updateSyncStatus('offline', 'Local Only');
            }
        }
        
        function updateSyncStatus(status, text) {
            const dot = document.getElementById('syncDot');
            const txt = document.getElementById('syncText');
            dot.className = `sync-dot ${status}`;
            txt.textContent = text;
        }
        
        function saveToCloud() {
            if (db && userId && isOnline) {
                db.ref(`challenges/${userId}`).set(challengeData)
                    .then(() => {
                        updateSyncStatus('synced', 'Synced');
                    })
                    .catch(e => {
                        console.error('Save error:', e);
                        updateSyncStatus('offline', 'Sync Error');
                    });
            }
        }
        
        // ==================== DATA MANAGEMENT ====================
        
        function loadData() {
            const saved = localStorage.getItem('bettingChallenge');
            if (saved) {
                try {
                    challengeData = JSON.parse(saved);
                } catch(e) {
                    initData();
                }
            } else {
                initData();
            }
            updateUI();
        }
        
        function initData() {
            challengeData = {
                startDate: new Date().toISOString().split('T')[0],
                currentBalance: INITIAL_BALANCE,
                bets: [],
                pendingBets: [],
                settings: { initialBalance: INITIAL_BALANCE, dailyTarget: DAILY_MULTIPLIER, targetDays: TARGET_DAYS }
            };
            saveData();
        }
        
        function saveData() {
            localStorage.setItem('bettingChallenge', JSON.stringify(challengeData));
            saveToCloud();
        }
        
        function exportData() {
            const blob = new Blob([JSON.stringify(challengeData, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `bet-tracker-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showNotification('Data exported!', 'success');
        }
        
        function importData(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        challengeData = JSON.parse(ev.target.result);
                        saveData();
                        updateUI();
                        showNotification('Data imported!', 'success');
                    } catch(err) {
                        showNotification('Import failed!', 'error');
                    }
                };
                reader.readAsText(file);
            }
            e.target.value = '';
        }
        
        function confirmReset() {
            if (confirm('Reset all data? This cannot be undone!')) {
                localStorage.removeItem('bettingChallenge');
                initData();
                updateUI();
                showNotification('Data reset!', 'success');
            }
        }
        
        // ==================== API & CACHING ====================
        
        async function fetchFixtures(forceRefresh = false) {
            const apiDot = document.getElementById('apiDot');
            const apiText = document.getElementById('apiText');
            const cacheInfo = document.getElementById('cacheInfo');
            const container = document.getElementById('fixturesContainer');
            
            // Check cache
            const now = Date.now();
            if (!forceRefresh && fixturesCache.data.length > 0 && (now - fixturesCache.timestamp) < CACHE_DURATION) {
                const cacheAge = Math.round((now - fixturesCache.timestamp) / 60000);
                cacheInfo.textContent = `Cached ${cacheAge}m ago`;
                apiDot.className = 'api-dot online';
                apiText.textContent = `${fixturesCache.data.length}`;
                allFixtures = fixturesCache.data;
                applyFilters();
                return;
            }
            
            apiDot.className = 'api-dot loading';
            apiText.textContent = 'Loading...';
            cacheInfo.textContent = '';
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            allFixtures = [];
            
            // Get dates range (today + 3 days)
            const dates = [];
            const filterDate = document.getElementById('filterDate').value;
            
            if (filterDate) {
                dates.push(filterDate);
            } else {
                for (let i = 0; i < 4; i++) {
                    const d = new Date();
                    d.setDate(d.getDate() + i);
                    dates.push(d.toISOString().split('T')[0]);
                }
            }
            
            try {
                // Prioritized league fetching
                const priorityLeagues = [39, 140, 78, 135, 61, 40, 48, 45, 143, 81, 137, 2, 3, 848, 307, 94, 88, 203, 179, 667];
                
                for (const lid of priorityLeagues) {
                    for (const date of dates) {
                        try {
                            const res = await fetch(`${API_BASE}/fixtures?league=${lid}&date=${date}`, {
                                headers: { 'x-apisports-key': API_KEY }
                            });
                            
                            if (res.ok) {
                                const data = await res.json();
                                if (data.response && data.response.length > 0) {
                                    // Fetch odds for these fixtures
                                    const fixturesWithOdds = await enrichWithOdds(data.response);
                                    allFixtures.push(...fixturesWithOdds);
                                }
                            }
                        } catch(e) {
                            console.warn(`Error fetching league ${lid}:`, e);
                        }
                        await sleep(100);
                    }
                }
                
                // Update cache
                fixturesCache = {
                    data: allFixtures,
                    timestamp: Date.now(),
                    oddsLoaded: true
                };
                
                apiDot.className = 'api-dot online';
                apiText.textContent = `${allFixtures.length}`;
                cacheInfo.textContent = 'Just updated';
                
                buildLeagueTabs();
                applyFilters();
                
                if (forceRefresh) {
                    showNotification(`Loaded ${allFixtures.length} fixtures`, 'success');
                }
                
            } catch(e) {
                console.error('Fetch error:', e);
                apiDot.className = 'api-dot offline';
                apiText.textContent = 'Error';
                showNotification('Failed to load fixtures', 'error');
            }
        }
        
        async function enrichWithOdds(fixtures) {
            // For each fixture, try to get odds from cache or API
            const enriched = [];
            
            for (const fix of fixtures) {
                const fixtureId = fix.fixture.id;
                
                // Check odds cache
                if (oddsCache[fixtureId] && (Date.now() - oddsCache[fixtureId].timestamp) < ODDS_CACHE_DURATION) {
                    fix.odds = oddsCache[fixtureId].data;
                } else {
                    // We'll load odds on demand to save API calls
                    fix.odds = null;
                }
                
                enriched.push(fix);
            }
            
            return enriched;
        }
        
        async function loadOddsForFixture(fixtureId) {
            // Check cache first
            if (oddsCache[fixtureId] && (Date.now() - oddsCache[fixtureId].timestamp) < ODDS_CACHE_DURATION) {
                return oddsCache[fixtureId].data;
            }
            
            try {
                const res = await fetch(`${API_BASE}/odds?fixture=${fixtureId}`, {
                    headers: { 'x-apisports-key': API_KEY }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.response && data.response.length > 0) {
                        const odds = parseOddsResponse(data.response[0]);
                        oddsCache[fixtureId] = { data: odds, timestamp: Date.now() };
                        return odds;
                    }
                }
            } catch(e) {
                console.warn('Odds fetch error:', e);
            }
            
            return null;
        }
        
        function parseOddsResponse(oddsData) {
            const parsed = {
                home: null,
                draw: null,
                away: null,
                over15: null,
                over25: null,
                under25: null,
                bttsYes: null,
                bttsNo: null
            };
            
            if (!oddsData || !oddsData.bookmakers) return parsed;
            
            // Find best bookmaker (prefer Bet365, Pinnacle, or first available)
            const bookmaker = oddsData.bookmakers.find(b => b.name === 'Bet365') 
                || oddsData.bookmakers.find(b => b.name === 'Pinnacle')
                || oddsData.bookmakers[0];
            
            if (!bookmaker || !bookmaker.bets) return parsed;
            
            for (const bet of bookmaker.bets) {
                if (bet.name === 'Match Winner') {
                    for (const val of bet.values) {
                        if (val.value === 'Home') parsed.home = parseFloat(val.odd);
                        if (val.value === 'Draw') parsed.draw = parseFloat(val.odd);
                        if (val.value === 'Away') parsed.away = parseFloat(val.odd);
                    }
                }
                if (bet.name === 'Goals Over/Under') {
                    for (const val of bet.values) {
                        if (val.value === 'Over 1.5') parsed.over15 = parseFloat(val.odd);
                        if (val.value === 'Over 2.5') parsed.over25 = parseFloat(val.odd);
                        if (val.value === 'Under 2.5') parsed.under25 = parseFloat(val.odd);
                    }
                }
                if (bet.name === 'Both Teams Score') {
                    for (const val of bet.values) {
                        if (val.value === 'Yes') parsed.bttsYes = parseFloat(val.odd);
                        if (val.value === 'No') parsed.bttsNo = parseFloat(val.odd);
                    }
                }
            }
            
            return parsed;
        }
        
        function refreshFixtures(force = false) {
            fetchFixtures(force);
        }
        
        // ==================== FIXTURES DISPLAY ====================
        
        function buildLeagueTabs() {
            const container = document.getElementById('leagueTabs');
            
            // Get unique leagues from fixtures
            const leaguesInFixtures = new Set();
            allFixtures.forEach(f => leaguesInFixtures.add(f.league.id));
            
            let html = `<button class="tab active" onclick="filterByLeague('all', this)">All (${allFixtures.length})</button>`;
            
            // Sort leagues by priority
            const sortedLeagues = Array.from(leaguesInFixtures)
                .filter(id => LEAGUES[id])
                .sort((a, b) => (LEAGUES[a]?.priority || 999) - (LEAGUES[b]?.priority || 999));
            
            for (const lid of sortedLeagues) {
                const league = LEAGUES[lid];
                const count = allFixtures.filter(f => f.league.id === lid).length;
                if (count > 0) {
                    html += `<button class="tab" onclick="filterByLeague(${lid}, this)">${league.flag} ${league.short} (${count})</button>`;
                }
            }
            
            container.innerHTML = html;
        }
        
        function filterByLeague(leagueId, btn) {
            document.querySelectorAll('#leagueTabs .tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            currentLeagueFilter = leagueId;
            applyFilters();
        }
        
        function applyFilters() {
            let fixtures = [...allFixtures];
            
            // League filter
            if (currentLeagueFilter !== 'all') {
                fixtures = fixtures.filter(f => f.league.id === currentLeagueFilter);
            }
            
            // Date filter
            const filterDate = document.getElementById('filterDate').value;
            if (filterDate) {
                fixtures = fixtures.filter(f => f.fixture.date.startsWith(filterDate));
            }
            
            // Status filter
            const status = document.getElementById('filterStatus').value;
            if (status !== 'all') {
                fixtures = fixtures.filter(f => {
                    const s = f.fixture.status.short;
                    if (status === 'upcoming') return ['NS', 'TBD', 'PST'].includes(s);
                    if (status === 'live') return ['1H', '2H', 'HT', 'ET', 'P', 'BT'].includes(s);
                    if (status === 'finished') return ['FT', 'AET', 'PEN'].includes(s);
                    return true;
                });
            }
            
            // Odds filter
            const minOdds = parseFloat(document.getElementById('filterOddsMin').value) || 0;
            const maxOdds = parseFloat(document.getElementById('filterOddsMax').value) || 999;
            
            if (minOdds > 0 || maxOdds < 999) {
                fixtures = fixtures.filter(f => {
                    if (!f.odds) return true; // Keep fixtures without odds loaded
                    const odds = f.odds.home || f.odds.away || 1;
                    return odds >= minOdds && odds <= maxOdds;
                });
            }
            
            // Sort
            const sortBy = document.getElementById('filterSort').value;
            fixtures.sort((a, b) => {
                switch(sortBy) {
                    case 'time':
                        return new Date(a.fixture.date) - new Date(b.fixture.date);
                    case 'odds-low':
                        return (a.odds?.home || 99) - (b.odds?.home || 99);
                    case 'odds-high':
                        return (b.odds?.home || 0) - (a.odds?.home || 0);
                    case 'league':
                        return (LEAGUES[a.league.id]?.priority || 999) - (LEAGUES[b.league.id]?.priority || 999);
                    default:
                        return 0;
                }
            });
            
            filteredFixtures = fixtures;
            displayFixtures(fixtures);
        }
        
        function displayFixtures(fixtures) {
            const container = document.getElementById('fixturesContainer');
            
            if (!fixtures || fixtures.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No fixtures found</p>
                        <button class="btn btn-primary" onclick="refreshFixtures(true)" style="margin-top:10px">Refresh</button>
                    </div>`;
                return;
            }
            
            container.innerHTML = fixtures.map(f => {
                const fix = f.fixture;
                const teams = f.teams;
                const league = LEAGUES[f.league.id] || { name: f.league.name, short: f.league.name.substring(0,4), flag: '‚öΩ' };
                const goals = f.goals;
                const odds = f.odds || {};
                
                const date = new Date(fix.date);
                const dateStr = formatDate(fix.date);
                const timeStr = formatTime(fix.date);
                
                const status = fix.status.short;
                const isLive = ['1H', '2H', 'HT', 'ET', 'P', 'BT'].includes(status);
                const isFinished = ['FT', 'AET', 'PEN'].includes(status);
                
                const home = teams.home.name.replace(/'/g, "\\'");
                const away = teams.away.name.replace(/'/g, "\\'");
                const fixtureId = fix.id;
                
                // Check if any selection from this fixture is in betslip
                const inBetslip = betslip.some(b => b.fixtureId === fixtureId);
                const cardClass = inBetslip ? 'match-card in-betslip' : 'match-card';
                
                let statusBadge = '';
                if (isLive) statusBadge = `<span class="badge badge-live">üî¥ ${status} ${goals.home}-${goals.away}</span>`;
                else if (isFinished) statusBadge = `<span class="badge">FT ${goals.home}-${goals.away}</span>`;
                
                return `
                    <div class="${cardClass}" data-fixture="${fixtureId}">
                        <div class="match-header">
                            <span class="match-league">${league.flag} ${league.short}</span>
                            <span class="match-time">${statusBadge || dateStr + ' ' + timeStr}</span>
                        </div>
                        <div class="match-teams">
                            <div class="team-info">
                                ${teams.home.logo ? `<img src="${teams.home.logo}" class="team-logo" onerror="this.style.display='none'">` : ''}
                                <span class="team-name">${teams.home.name}</span>
                            </div>
                            <div class="match-score">${isLive || isFinished ? `${goals.home}-${goals.away}` : 'vs'}</div>
                            <div class="team-info away">
                                ${teams.away.logo ? `<img src="${teams.away.logo}" class="team-logo" onerror="this.style.display='none'">` : ''}
                                <span class="team-name">${teams.away.name}</span>
                            </div>
                        </div>
                        <div class="odds-row">
                            <div class="odd-btn ${isOddSelected(fixtureId, 'home') ? 'in-betslip' : ''}" onclick="addToBetslip(${fixtureId}, 'home', '${home}', '${away}', ${odds.home || 0}, '${league.name}', '${fix.date}')">
                                <div class="odd-label">1</div>
                                <div class="odd-value ${odds.home ? '' : 'loading'}">${odds.home ? odds.home.toFixed(2) : '-'}</div>
                            </div>
                            <div class="odd-btn ${isOddSelected(fixtureId, 'draw') ? 'in-betslip' : ''}" onclick="addToBetslip(${fixtureId}, 'draw', '${home}', '${away}', ${odds.draw || 0}, '${league.name}', '${fix.date}')">
                                <div class="odd-label">X</div>
                                <div class="odd-value ${odds.draw ? '' : 'loading'}">${odds.draw ? odds.draw.toFixed(2) : '-'}</div>
                            </div>
                            <div class="odd-btn ${isOddSelected(fixtureId, 'away') ? 'in-betslip' : ''}" onclick="addToBetslip(${fixtureId}, 'away', '${home}', '${away}', ${odds.away || 0}, '${league.name}', '${fix.date}')">
                                <div class="odd-label">2</div>
                                <div class="odd-value ${odds.away ? '' : 'loading'}">${odds.away ? odds.away.toFixed(2) : '-'}</div>
                            </div>
                            <div class="odd-btn ${isOddSelected(fixtureId, 'over25') ? 'in-betslip' : ''}" onclick="addToBetslip(${fixtureId}, 'over25', '${home}', '${away}', ${odds.over25 || 0}, '${league.name}', '${fix.date}')">
                                <div class="odd-label">O2.5</div>
                                <div class="odd-value ${odds.over25 ? '' : 'loading'}">${odds.over25 ? odds.over25.toFixed(2) : '-'}</div>
                            </div>
                            <div class="odd-btn ${isOddSelected(fixtureId, 'under25') ? 'in-betslip' : ''}" onclick="addToBetslip(${fixtureId}, 'under25', '${home}', '${away}', ${odds.under25 || 0}, '${league.name}', '${fix.date}')">
                                <div class="odd-label">U2.5</div>
                                <div class="odd-value ${odds.under25 ? '' : 'loading'}">${odds.under25 ? odds.under25.toFixed(2) : '-'}</div>
                            </div>
                        </div>
                        ${!odds.home ? `<button class="btn btn-sm btn-secondary" style="width:100%;margin-top:6px" onclick="event.stopPropagation(); loadOdds(${fixtureId})">Load Odds</button>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        async function loadOdds(fixtureId) {
            showNotification('Loading odds...', 'info');
            const odds = await loadOddsForFixture(fixtureId);
            
            if (odds) {
                // Update the fixture in cache
                const fixture = allFixtures.find(f => f.fixture.id === fixtureId);
                if (fixture) {
                    fixture.odds = odds;
                }
                applyFilters();
                showNotification('Odds loaded', 'success');
            } else {
                showNotification('Odds not available', 'warning');
            }
        }
        
        // ==================== BETSLIP ====================
        
        function isOddSelected(fixtureId, market) {
            return betslip.some(b => b.fixtureId === fixtureId && b.market === market);
        }
        
        function addToBetslip(fixtureId, market, home, away, odds, league, date) {
            if (!odds || odds <= 0) {
                showNotification('Odds not available - load odds first', 'warning');
                return;
            }
            
            // Check if already in betslip
            const existingIndex = betslip.findIndex(b => b.fixtureId === fixtureId && b.market === market);
            
            if (existingIndex >= 0) {
                // Remove from betslip
                betslip.splice(existingIndex, 1);
            } else {
                // Add to betslip
                const marketLabels = {
                    home: `${home} to Win`,
                    draw: 'Draw',
                    away: `${away} to Win`,
                    over25: 'Over 2.5 Goals',
                    under25: 'Under 2.5 Goals',
                    over15: 'Over 1.5 Goals',
                    bttsYes: 'BTTS Yes',
                    bttsNo: 'BTTS No'
                };
                
                betslip.push({
                    fixtureId,
                    market,
                    home,
                    away,
                    odds,
                    league,
                    date,
                    selection: marketLabels[market] || market,
                    match: `${home} vs ${away}`
                });
            }
            
            updateBetslip();
            applyFilters(); // Refresh display to show selection state
        }
        
        function removeBetslipLeg(index) {
            betslip.splice(index, 1);
            updateBetslip();
            applyFilters();
        }
        
        function clearBetslip() {
            betslip = [];
            updateBetslip();
            applyFilters();
        }
        
        function updateBetslip() {
            const countEl = document.getElementById('betslipCount');
            const legsEl = document.getElementById('betslipLegs');
            const typeEl = document.getElementById('betslipType');
            const selectionsEl = document.getElementById('betslipSelections');
            const oddsEl = document.getElementById('betslipOdds');
            const stakeEl = document.getElementById('betslipStake');
            const submitBtn = document.getElementById('betslipSubmit');
            
            countEl.textContent = betslip.length;
            selectionsEl.textContent = betslip.length;
            
            // Bet type
            const types = ['None', 'Single', 'Double', 'Treble', '4-Fold', '5-Fold', '6-Fold', '7-Fold', '8-Fold'];
            typeEl.textContent = types[Math.min(betslip.length, types.length - 1)] || `${betslip.length}-Fold`;
            
            // Combined odds
            const combinedOdds = betslip.reduce((acc, b) => acc * b.odds, 1);
            oddsEl.textContent = combinedOdds.toFixed(2);
            
            // Set default stake
            if (!stakeEl.value || stakeEl.value === '0') {
                stakeEl.value = challengeData.currentBalance.toFixed(2);
            }
            
            // Legs display
            if (betslip.length === 0) {
                legsEl.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Click on odds to add selections</p></div>`;
            } else {
                legsEl.innerHTML = betslip.map((b, i) => `
                    <div class="betslip-leg">
                        <button class="betslip-leg-remove" onclick="removeBetslipLeg(${i})">√ó</button>
                        <div class="betslip-leg-match">${b.match} ‚Ä¢ ${b.league}</div>
                        <div class="betslip-leg-selection">${b.selection}</div>
                        <div class="betslip-leg-odds">@ ${b.odds.toFixed(2)}</div>
                    </div>
                `).join('');
            }
            
            // Submit button
            submitBtn.disabled = betslip.length === 0;
            
            updateBetslipReturns();
        }
        
        function updateBetslipReturns() {
            const stake = parseFloat(document.getElementById('betslipStake').value) || 0;
            const combinedOdds = betslip.reduce((acc, b) => acc * b.odds, 1);
            const returns = stake * combinedOdds;
            document.getElementById('betslipReturns').textContent = `¬£${returns.toFixed(2)}`;
        }
        
        function toggleBetslip() {
            const betslipEl = document.getElementById('betslip');
            betslipEl.classList.toggle('open');
        }
        
        function placeBet() {
            if (betslip.length === 0) return;
            
            const stake = parseFloat(document.getElementById('betslipStake').value);
            const notes = document.getElementById('betslipNotes').value;
            
            if (!stake || stake <= 0) {
                showNotification('Enter a valid stake', 'error');
                return;
            }
            
            if (stake > challengeData.currentBalance) {
                showNotification('Stake exceeds balance!', 'error');
                return;
            }
            
            const combinedOdds = betslip.reduce((acc, b) => acc * b.odds, 1);
            const types = ['', 'single', 'double', 'treble', 'accumulator'];
            
            const bet = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                type: types[Math.min(betslip.length, 4)] || 'accumulator',
                legs: betslip.map(b => ({
                    match: b.match,
                    selection: b.selection,
                    odds: b.odds,
                    league: b.league,
                    fixtureDate: b.date
                })),
                selection: betslip.map(b => `${b.selection} (${b.match})`).join(' + '),
                competition: betslip.map(b => b.league).join(' / '),
                market: betslip.map(b => b.selection).join(' + '),
                odds: parseFloat(combinedOdds.toFixed(2)),
                stake: stake,
                confidence: 'medium',
                notes: notes,
                status: 'pending'
            };
            
            challengeData.pendingBets.push(bet);
            saveData();
            
            // Clear betslip
            betslip = [];
            document.getElementById('betslipNotes').value = '';
            updateBetslip();
            toggleBetslip();
            updateUI();
            applyFilters();
            
            showNotification(`${bet.type.charAt(0).toUpperCase() + bet.type.slice(1)} bet placed!`, 'success');
        }
        
        // ==================== BET MANAGEMENT ====================
        
        let selectedBetId = null;
        
        function openResultModal(id) {
            selectedBetId = id;
            const bet = challengeData.pendingBets.find(b => b.id === id);
            if (!bet) return;
            
            let legsHtml = '';
            if (bet.legs && bet.legs.length > 0) {
                legsHtml = bet.legs.map(l => `
                    <div style="background:var(--bg-tertiary);padding:6px;border-radius:4px;margin-bottom:4px">
                        <div style="font-size:0.7rem;color:var(--text-secondary)">${l.match}</div>
                        <div style="font-size:0.8rem;font-weight:600">${l.selection} @ ${l.odds.toFixed(2)}</div>
                    </div>
                `).join('');
            } else {
                legsHtml = `<div style="font-size:0.85rem;font-weight:600">${bet.selection}</div>`;
            }
            
            document.getElementById('modalBetDetails').innerHTML = `
                <div style="margin-bottom:12px">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px">
                        <span class="badge badge-pending">${bet.type}</span>
                        <span style="font-size:0.75rem;color:var(--text-secondary)">${bet.date}</span>
                    </div>
                    ${legsHtml}
                    <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.8rem">
                        <span>Combined Odds: <strong class="green">${bet.odds.toFixed(2)}</strong></span>
                        <span>Stake: <strong>¬£${bet.stake.toFixed(2)}</strong></span>
                    </div>
                    <div style="text-align:right;margin-top:4px;font-size:0.85rem">
                        Returns: <strong class="green">¬£${(bet.stake * bet.odds).toFixed(2)}</strong>
                    </div>
                </div>
            `;
            
            document.getElementById('finalScore').value = '';
            document.getElementById('resultModal').classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            selectedBetId = null;
        }
        
        function recordResult(result) {
            const idx = challengeData.pendingBets.findIndex(b => b.id === selectedBetId);
            if (idx === -1) return;
            
            const bet = challengeData.pendingBets[idx];
            bet.status = result;
            bet.finalScore = document.getElementById('finalScore').value;
            bet.day = challengeData.bets.length + 1;
            
            if (result === 'won') {
                bet.returns = bet.stake * bet.odds;
                challengeData.currentBalance = bet.returns;
            } else if (result === 'void') {
                bet.returns = bet.stake;
            } else {
                bet.returns = 0;
                challengeData.currentBalance = 0;
            }
            
            bet.balanceAfter = challengeData.currentBalance;
            bet.targetForDay = INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, bet.day);
            bet.vsTarget = bet.balanceAfter - bet.targetForDay;
            
            challengeData.bets.push(bet);
            challengeData.pendingBets.splice(idx, 1);
            
            saveData();
            closeModal('resultModal');
            updateUI();
            
            if (result === 'won') {
                showNotification(`üéâ Won! Balance: ¬£${challengeData.currentBalance.toFixed(2)}`, 'success');
            } else if (result === 'void') {
                showNotification('Bet voided', 'info');
            } else {
                showNotification('‚ùå Challenge ended', 'error');
            }
        }
        
        function cancelPendingBet(id) {
            if (confirm('Cancel?')) {
                challengeData.pendingBets = challengeData.pendingBets.filter(b => b.id !== id);
                saveData();
                updateUI();
            }
        }
        
        // ==================== UI UPDATES ====================
        
        function updateUI() {
            updateHeader();
            updateQuickStats();
            updateProgress();
            updatePendingBets();
            updateHistory();
            updateChart();
            updateBetslip();
        }
        
        function updateHeader() {
            document.getElementById('currentDay').textContent = `Day ${Math.min(challengeData.bets.length + 1, TARGET_DAYS)}`;
            document.getElementById('currentBalance').textContent = `¬£${challengeData.currentBalance.toFixed(0)}`;
            
            const wins = challengeData.bets.filter(b => b.status === 'won').length;
            const total = challengeData.bets.filter(b => b.status !== 'void').length;
            document.getElementById('winRate').textContent = `${total ? ((wins / total) * 100).toFixed(0) : 0}%`;
            
            const active = challengeData.currentBalance > 0 && challengeData.bets.length < TARGET_DAYS;
            const complete = challengeData.currentBalance >= FINAL_TARGET;
            document.getElementById('challengeStatus').textContent = complete ? 'üèÜ' : active ? 'üü¢' : 'üî¥';
        }
        
        function updateQuickStats() {
            const profit = challengeData.currentBalance - INITIAL_BALANCE;
            document.getElementById('totalProfit').textContent = `¬£${profit.toFixed(0)}`;
            document.getElementById('totalProfit').className = `quick-stat-value ${profit >= 0 ? 'green' : 'red'}`;
            
            const nextTarget = INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, challengeData.bets.length + 1);
            document.getElementById('targetToday').textContent = `¬£${nextTarget.toFixed(0)}`;
            
            const currentTarget = INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, Math.max(challengeData.bets.length, 1));
            const ahead = challengeData.bets.length && challengeData.currentBalance > 0 
                ? Math.log(challengeData.currentBalance / currentTarget) / Math.log(DAILY_MULTIPLIER) 
                : 0;
            document.getElementById('daysAhead').textContent = ahead.toFixed(1);
            document.getElementById('daysAhead').className = `quick-stat-value ${ahead >= 0 ? 'green' : 'red'}`;
            
            const avgOdds = challengeData.bets.length 
                ? (challengeData.bets.reduce((s, b) => s + b.odds, 0) / challengeData.bets.length).toFixed(2) 
                : '1.20';
            document.getElementById('avgOdds').textContent = avgOdds;
            
            document.getElementById('remainingDays').textContent = Math.max(0, TARGET_DAYS - challengeData.bets.length);
            
            const roi = ((challengeData.currentBalance - INITIAL_BALANCE) / INITIAL_BALANCE * 100).toFixed(1);
            document.getElementById('roiDisplay').textContent = `${roi}%`;
        }
        
        function updateProgress() {
            const pct = (challengeData.currentBalance / FINAL_TARGET) * 100;
            document.getElementById('progressFill').style.width = `${Math.max(pct, 2)}%`;
            document.getElementById('progressFill').textContent = `${pct.toFixed(1)}%`;
            
            let streak = '';
            for (let i = 1; i <= TARGET_DAYS; i++) {
                const bet = challengeData.bets.find(b => b.day === i);
                let cls = 'streak-day streak-pending';
                if (bet) cls = `streak-day streak-${bet.status === 'won' ? 'won' : bet.status === 'void' ? 'void' : 'lost'}`;
                if (i === challengeData.bets.length + 1) cls += ' streak-current';
                streak += `<div class="${cls}">${i}</div>`;
            }
            document.getElementById('streakDisplay').innerHTML = streak;
            
            document.getElementById('winCount').textContent = challengeData.bets.filter(b => b.status === 'won').length;
            document.getElementById('lossCount').textContent = challengeData.bets.filter(b => b.status === 'lost').length;
            
            const won = challengeData.bets.filter(b => b.status === 'won');
            document.getElementById('bestDay').textContent = won.length ? `Day ${won.reduce((b, c) => (c.returns - c.stake) > (b.returns - b.stake) ? c : b).day}` : '-';
            
            let winStreak = 0;
            for (let i = challengeData.bets.length - 1; i >= 0; i--) {
                if (challengeData.bets[i].status === 'won') winStreak++;
                else break;
            }
            document.getElementById('currentStreak').textContent = winStreak;
        }
        
        function updatePendingBets() {
            const c = document.getElementById('pendingBets');
            
            if (!challengeData.pendingBets.length) {
                c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No pending bets</p></div>';
                return;
            }
            
            c.innerHTML = challengeData.pendingBets.map(b => {
                let legsHtml = '';
                if (b.legs && b.legs.length > 0) {
                    legsHtml = b.legs.map(l => `
                        <div style="font-size:0.7rem;padding:3px 0;border-bottom:1px solid var(--border-color)">
                            ${l.selection} <span style="color:var(--accent-green)">@ ${l.odds.toFixed(2)}</span>
                            <span style="color:var(--text-secondary);display:block;font-size:0.6rem">${l.match}</span>
                        </div>
                    `).join('');
                }
                
                return `
                    <div style="background:var(--bg-tertiary);border-radius:8px;padding:10px;margin-bottom:8px">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                            <span class="badge badge-pending">${b.type}</span>
                            <span style="font-size:0.7rem;color:var(--text-secondary)">${b.date}</span>
                        </div>
                        ${legsHtml || `<div style="font-size:0.8rem;font-weight:600;margin-bottom:6px">${b.selection}</div>`}
                        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.75rem">
                            <span>@ <strong class="green">${b.odds.toFixed(2)}</strong></span>
                            <span>¬£${b.stake.toFixed(2)} ‚Üí <strong class="green">¬£${(b.stake * b.odds).toFixed(2)}</strong></span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="openResultModal(${b.id})">Result</button>
                            <button class="btn btn-sm btn-secondary" onclick="cancelPendingBet(${b.id})">Cancel</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateHistory() {
            const tb = document.getElementById('historyTable');
            
            if (!challengeData.bets.length) {
                tb.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--text-secondary)">No bets yet</td></tr>';
                return;
            }
            
            tb.innerHTML = challengeData.bets.map(b => `
                <tr>
                    <td>${b.day}</td>
                    <td>${b.date}</td>
                    <td title="${b.selection}">${b.selection.substring(0, 20)}...</td>
                    <td>${b.type}</td>
                    <td>${b.odds.toFixed(2)}</td>
                    <td>¬£${b.stake.toFixed(0)}</td>
                    <td><span class="badge badge-${b.status}">${b.status === 'won' ? '‚úÖ' : b.status === 'void' ? '‚ö™' : '‚ùå'}</span></td>
                    <td class="${b.returns > b.stake ? 'green' : 'red'}">¬£${b.returns.toFixed(0)}</td>
                    <td>¬£${b.balanceAfter.toFixed(0)}</td>
                </tr>
            `).join('');
        }
        
        function updateChart() {
            const ctx = document.getElementById('balanceChart');
            if (!ctx) return;
            if (window.chartInstance) window.chartInstance.destroy();
            
            const actual = [{ x: 0, y: INITIAL_BALANCE }];
            challengeData.bets.forEach(b => actual.push({ x: b.day, y: b.balanceAfter }));
            
            const target = [];
            for (let i = 0; i <= TARGET_DAYS; i++) {
                target.push({ x: i, y: INITIAL_BALANCE * Math.pow(DAILY_MULTIPLIER, i) });
            }
            
            window.chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'Actual', data: actual, borderColor: '#00d4aa', backgroundColor: 'rgba(0,212,170,0.1)', fill: true, tension: 0.4, pointRadius: 3 },
                        { label: 'Target', data: target, borderColor: '#54a0ff', borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#b0b0c0', font: { size: 9 } } } },
                    scales: {
                        x: { type: 'linear', ticks: { color: '#b0b0c0', font: { size: 8 } }, grid: { color: '#333355' }, min: 0, max: TARGET_DAYS },
                        y: { ticks: { color: '#b0b0c0', font: { size: 8 }, callback: v => v >= 1000 ? (v/1000).toFixed(1) + 'k' : v }, grid: { color: '#333355' }, min: 0 }
                    }
                }
            });
        }
        
        // ==================== INIT ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date filter to today
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
            
            // Load local data first
            loadData();
            
            // Initialize Firebase
            initFirebase();
            
            // Fetch fixtures
            fetchFixtures();
            
            // Set default stake
            document.getElementById('betslipStake').value = challengeData.currentBalance.toFixed(2);
        });
    </script>
</body>
</html>
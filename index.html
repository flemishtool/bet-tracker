<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bet Tracker">
    <meta name="theme-color" content="#0f0f1a">
    <meta name="description" content="21-Day Betting Challenge Tracker">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>21-Day Betting Challenge Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent-green: #00d4aa;
            --accent-orange: #ff9f43;
            --accent-red: #ff6b6b;
            --accent-blue: #54a0ff;
            --accent-purple: #a55eea;
            --accent-yellow: #feca57;
            --accent-cyan: #00d2d3;
            --text-primary: #ffffff;
            --text-secondary: #b0b0c0;
            --border-color: #333355;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 15px;
            padding-bottom: 80px;
            line-height: 1.4;
        }

        /* Install Banner */
        .install-banner {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            padding: 12px 20px;
            z-index: 1001;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .install-banner.show { display: flex; }
        .install-banner-text { font-weight: 600; color: white; font-size: 0.85rem; }
        .install-banner-buttons { display: flex; gap: 10px; }
        .install-banner .btn { padding: 8px 16px; font-size: 0.8rem; }

        /* Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-stats { display: flex; gap: 15px; flex-wrap: wrap; }
        .header-stat { text-align: center; min-width: 70px; }
        .header-stat-value { font-size: 1.15rem; font-weight: bold; color: var(--accent-green); }
        .header-stat-label { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; }

        /* Grid */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title { font-size: 0.95rem; font-weight: 600; }

        .card-icon {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .icon-green { background: rgba(0, 212, 170, 0.2); }
        .icon-orange { background: rgba(255, 159, 67, 0.2); }
        .icon-blue { background: rgba(84, 160, 255, 0.2); }
        .icon-purple { background: rgba(165, 94, 234, 0.2); }
        .icon-red { background: rgba(255, 107, 107, 0.2); }
        .icon-yellow { background: rgba(254, 202, 87, 0.2); }
        .icon-cyan { background: rgba(0, 210, 211, 0.2); }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .metric-box {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-value { font-size: 1.25rem; font-weight: bold; margin-bottom: 3px; }
        .metric-label { font-size: 0.65rem; color: var(--text-secondary); text-transform: uppercase; }

        /* Colors */
        .green { color: var(--accent-green); }
        .orange { color: var(--accent-orange); }
        .red { color: var(--accent-red); }
        .blue { color: var(--accent-blue); }
        .purple { color: var(--accent-purple); }
        .yellow { color: var(--accent-yellow); }
        .cyan { color: var(--accent-cyan); }

        /* Progress Bar */
        .progress-container { margin: 15px 0; }
        .progress-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.8rem; }

        .progress-bar {
            height: 22px;
            background: var(--bg-tertiary);
            border-radius: 11px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
            border-radius: 11px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 40px;
        }

        .progress-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        /* Forms */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-secondary); }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-green);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 170, 0.3);
        }

        .btn-success { background: var(--accent-green); color: var(--bg-primary); }
        .btn-danger { background: var(--accent-red); color: white; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-warning { background: var(--accent-orange); color: var(--bg-primary); }
        .btn-info { background: var(--accent-blue); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-group { display: flex; gap: 8px; margin-top: 12px; }
        .btn-group .btn { flex: 1; }

        /* Tables */
        .table-container { overflow-x: auto; max-height: 350px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px 6px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.75rem; }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover { background: var(--bg-tertiary); }

        /* Badges */
        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.6rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-won { background: rgba(0, 212, 170, 0.2); color: var(--accent-green); }
        .badge-lost { background: rgba(255, 107, 107, 0.2); color: var(--accent-red); }
        .badge-pending { background: rgba(255, 159, 67, 0.2); color: var(--accent-orange); }
        .badge-void { background: rgba(176, 176, 192, 0.2); color: var(--text-secondary); }
        .badge-live { background: rgba(255, 107, 107, 0.3); color: var(--accent-red); animation: pulse 1.5s infinite; }
        .badge-ft { background: rgba(84, 160, 255, 0.2); color: var(--accent-blue); }

        /* Chart */
        .chart-container { position: relative; height: 220px; }

        /* Milestones */
        .milestone-list { list-style: none; }

        .milestone-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .milestone-item:last-child { border-bottom: none; }

        .milestone-check {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .milestone-reached { background: var(--accent-green); color: var(--bg-primary); }
        .milestone-pending { background: var(--bg-tertiary); border: 2px solid var(--border-color); color: var(--text-secondary); }
        .milestone-info { flex: 1; }
        .milestone-amount { font-weight: 600; font-size: 0.9rem; }
        .milestone-day { font-size: 0.7rem; color: var(--text-secondary); }

        /* Risk Meter */
        .risk-meter { margin: 15px 0; }

        .risk-bar {
            height: 12px;
            background: linear-gradient(90deg, var(--accent-green), var(--accent-orange), var(--accent-red));
            border-radius: 6px;
            position: relative;
        }

        .risk-indicator {
            position: absolute;
            top: -4px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
        }

        .risk-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        /* Match Cards */
        .match-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .match-card:hover { border-color: var(--accent-green); }
        .match-card.selected { border-color: var(--accent-green); background: rgba(0, 212, 170, 0.1); }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .match-league {
            font-size: 0.6rem;
            color: var(--accent-blue);
            text-transform: uppercase;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .match-time { font-size: 0.7rem; color: var(--text-secondary); }

        .match-teams-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 8px;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 0;
        }

        .team-info.away { flex-direction: row-reverse; text-align: right; }

        .team-logo {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: contain;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .team-name {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .match-score {
            font-size: 1.1rem;
            font-weight: bold;
            padding: 0 10px;
            color: var(--text-primary);
            flex-shrink: 0;
        }

        .match-odds { display: flex; gap: 6px; }

        .odd-btn {
            flex: 1;
            padding: 6px 4px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .odd-btn:hover { border-color: var(--accent-green); background: rgba(0, 212, 170, 0.1); }
        .odd-btn.selected { background: var(--accent-green); color: var(--bg-primary); border-color: var(--accent-green); }
        .odd-label { font-size: 0.55rem; color: var(--text-secondary); }
        .odd-value { font-weight: bold; font-size: 0.85rem; }

        .match-prediction {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .prediction-bar {
            display: flex;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .pred-home { background: var(--accent-green); }
        .pred-draw { background: var(--accent-orange); }
        .pred-away { background: var(--accent-blue); }

        .prediction-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.55rem;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 4px;
        }

        .tab {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab.active { background: var(--accent-green); color: var(--bg-primary); }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            left: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-size: 0.85rem;
            text-align: center;
        }

        .notification-success { background: var(--accent-green); }
        .notification-error { background: var(--accent-red); }
        .notification-warning { background: var(--accent-orange); }
        .notification-info { background: var(--accent-blue); }

        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 { font-size: 1rem; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        /* Analysis */
        .analysis-grid { display: grid; gap: 8px; }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            align-items: center;
        }

        .analysis-label { color: var(--text-secondary); font-size: 0.75rem; }
        .analysis-value { font-weight: 600; font-size: 0.8rem; }

        /* Probability Display */
        .prob-display {
            text-align: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin: 12px 0;
        }

        .prob-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .prob-label { color: var(--text-secondary); margin-top: 6px; font-size: 0.75rem; }

        /* Full Width */
        .full-width { grid-column: 1 / -1; }

        /* Pills */
        .selection-pills { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }

        .pill {
            padding: 5px 10px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            font-size: 0.7rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pill:hover, .pill.active {
            background: var(--accent-green);
            color: var(--bg-primary);
            border-color: var(--accent-green);
        }

        /* Quick Stats */
        .quick-stats {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 8px;
            -webkit-overflow-scrolling: touch;
        }

        .quick-stat {
            background: var(--bg-secondary);
            padding: 10px 14px;
            border-radius: 8px;
            text-align: center;
            min-width: 90px;
            flex-shrink: 0;
            border: 1px solid var(--border-color);
        }

        .quick-stat-value { font-size: 1.1rem; font-weight: bold; }
        .quick-stat-label { font-size: 0.6rem; color: var(--text-secondary); margin-top: 2px; text-transform: uppercase; }

        /* Data Actions */
        .data-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
        .data-actions .btn { flex: 1; font-size: 0.7rem; padding: 8px 10px; min-width: 70px; }

        /* Streak */
        .streak-display { display: flex; gap: 3px; margin: 12px 0; flex-wrap: wrap; }

        .streak-day {
            width: 24px;
            height: 24px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .streak-won { background: var(--accent-green); color: var(--bg-primary); }
        .streak-lost { background: var(--accent-red); color: white; }
        .streak-void { background: var(--text-secondary); color: var(--bg-primary); }
        .streak-pending { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px dashed var(--border-color); }
        .streak-current { border: 2px solid white !important; }

        /* Loading */
        .loading { display: flex; justify-content: center; align-items: center; padding: 30px; }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 25px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 10px; }

        /* API Status */
        .api-status { display: flex; align-items: center; gap: 6px; font-size: 0.65rem; color: var(--text-secondary); }
        .api-dot { width: 8px; height: 8px; border-radius: 50%; }
        .api-dot.online { background: var(--accent-green); }
        .api-dot.offline { background: var(--accent-red); }
        .api-dot.loading { background: var(--accent-orange); animation: pulse 1s infinite; }

        /* Stats Row */
        .stats-row { display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }

        .stat-card {
            flex: 1;
            min-width: 85px;
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card-value { font-size: 1.1rem; font-weight: bold; }
        .stat-card-label { font-size: 0.6rem; color: var(--text-secondary); margin-top: 3px; text-transform: uppercase; }

        /* Day Performance */
        .day-performance { display: flex; justify-content: space-between; margin-top: 12px; gap: 3px; }
        .day-bar { flex: 1; text-align: center; }

        .day-bar-fill {
            height: 45px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            margin-bottom: 3px;
        }

        .day-bar-value {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            transition: height 0.3s ease;
        }

        .day-bar-label { font-size: 0.55rem; color: var(--text-secondary); }

        /* API Quota */
        .api-quota {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
        }

        .quota-bar {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }

        .quota-fill {
            height: 100%;
            background: var(--accent-green);
            transition: width 0.3s ease;
        }

        .quota-fill.warning { background: var(--accent-orange); }
        .quota-fill.danger { background: var(--accent-red); }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; padding-bottom: 90px; }
            .dashboard-header { flex-direction: column; text-align: center; }
            .dashboard-header h1 { font-size: 1.3rem; }
            .header-stats { justify-content: center; gap: 10px; }
            .header-stat { min-width: 60px; }
            .header-stat-value { font-size: 1rem; }
            .grid-container { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .quick-stat { padding: 8px 10px; min-width: 80px; }
            .quick-stat-value { font-size: 1rem; }
            .card { padding: 12px; }
            .btn-group { flex-direction: column; }
            .data-actions { flex-direction: column; }
            .data-actions .btn { width: 100%; }
            th, td { padding: 6px 4px; font-size: 0.65rem; }
            .modal { padding: 15px; }
            .notification { left: 10px; right: 10px; }
        }

        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-green); }
    </style>
</head>
<body>
    <!-- Install Banner -->
    <div class="install-banner" id="installBanner">
        <span class="install-banner-text">üì± Install for quick access</span>
        <div class="install-banner-buttons">
            <button class="btn btn-secondary" onclick="dismissInstallBanner()">Later</button>
            <button class="btn btn-success" onclick="installApp()">Install</button>
        </div>
    </div>

    <!-- Header -->
    <div class="dashboard-header">
        <h1>üéØ 21-Day Betting Challenge</h1>
        <div class="header-stats">
            <div class="header-stat">
                <div class="header-stat-value" id="currentDay">Day 1</div>
                <div class="header-stat-label">Current Day</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="currentBalance">¬£200.00</div>
                <div class="header-stat-label">Balance</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value green" id="winRate">0%</div>
                <div class="header-stat-label">Win Rate</div>
            </div>
            <div class="header-stat">
                <div class="header-stat-value" id="challengeStatus">üü¢ Active</div>
                <div class="header-stat-label">Status</div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="quick-stat">
            <div class="quick-stat-value green" id="totalProfit">¬£0.00</div>
            <div class="quick-stat-label">Profit</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value blue" id="targetToday">¬£240.00</div>
            <div class="quick-stat-label">Target</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value orange" id="daysAhead">0</div>
            <div class="quick-stat-label">Days +/-</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value purple" id="avgOdds">1.20</div>
            <div class="quick-stat-label">Avg Odds</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value" id="remainingDays">21</div>
            <div class="quick-stat-label">Days Left</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-value yellow" id="roiDisplay">0%</div>
            <div class="quick-stat-label">ROI</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="grid-container">
        <!-- Fixtures Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">‚öΩ Today's Fixtures</span>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div class="api-status">
                        <div class="api-dot loading" id="apiStatusDot"></div>
                        <span id="apiStatusText">Loading...</span>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshFixtures()" style="padding: 4px 8px; font-size: 0.65rem;">üîÑ</button>
                </div>
            </div>
            
            <!-- API Quota Display -->
            <div class="api-quota" id="apiQuotaContainer" style="display: none;">
                <div style="display: flex; justify-content: space-between; font-size: 0.7rem;">
                    <span>API Quota</span>
                    <span id="apiQuotaText">0/0</span>
                </div>
                <div class="quota-bar">
                    <div class="quota-fill" id="apiQuotaFill" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- League Tabs -->
<div class="tabs" id="fixtureTabs">
    <button class="tab active" onclick="filterFixtures('all', this)">All</button>
    <button class="tab" onclick="filterFixtures(39, this)">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø EPL</button>
    <button class="tab" onclick="filterFixtures(40, this)">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Champ</button>
    <button class="tab" onclick="filterFixtures(140, this)">üá™üá∏ Liga</button>
    <button class="tab" onclick="filterFixtures(78, this)">üá©üá™ Bund</button>
    <button class="tab" onclick="filterFixtures(135, this)">üáÆüáπ Serie</button>
    <button class="tab" onclick="filterFixtures(61, this)">üá´üá∑ L1</button>
    <button class="tab" onclick="filterFixtures(94, this)">üáµüáπ Liga</button>
    <button class="tab" onclick="filterFixtures(88, this)">üá≥üá± Ere</button>
    <button class="tab" onclick="filterFixtures(144, this)">üáßüá™ JPL</button>
    <button class="tab" onclick="filterFixtures(203, this)">üáπüá∑ TSL</button>
    <button class="tab" onclick="filterFixtures(179, this)">üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø SPFL</button>
    <button class="tab" onclick="filterFixtures(307, this)">üá∏üá¶ SPL</button>
    <button class="tab" onclick="filterFixtures(2, this)">üèÜ UCL</button>
    <button class="tab" onclick="filterFixtures(3, this)">üèÜ UEL</button>
    <button class="tab" onclick="filterFixtures(848, this)">üèÜ UECL</button>
    <button class="tab" onclick="filterFixtures(667, this)">‚öΩ Friendly</button>
</div>
            
            <div id="fixturesContainer" style="max-height: 400px; overflow-y: auto;">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Progress Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìà Challenge Progress</span>
                <span class="card-icon icon-green">üìä</span>
            </div>
            
            <div class="progress-container">
                <div class="progress-header">
                    <span>Progress to ¬£9,201</span>
                    <span id="progressPercent">2.2%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 2.2%">2.2%</div>
                </div>
                <div class="progress-markers">
                    <span>¬£200</span>
                    <span>¬£2.3k</span>
                    <span>¬£4.6k</span>
                    <span>¬£6.9k</span>
                    <span>¬£9.2k</span>
                </div>
            </div>

            <div class="streak-display" id="streakDisplay"></div>

            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-value green" id="winCount">0</div>
                    <div class="metric-label">Wins</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value red" id="lossCount">0</div>
                    <div class="metric-label">Losses</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value blue" id="bestDay">-</div>
                    <div class="metric-label">Best Day</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value orange" id="currentStreak">0</div>
                    <div class="metric-label">Streak</div>
                </div>
            </div>
        </div>

        <!-- Place Bet Card -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üí∞ Place Bet</span>
                <span class="card-icon icon-orange">üé≤</span>
            </div>

            <form id="betForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="betDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Bet Type</label>
                        <select class="form-select" id="betType">
                            <option value="single">Single</option>
                            <option value="double">Double</option>
                            <option value="treble">Treble</option>
                            <option value="accumulator">Acca 4+</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Competition</label>
                    <select class="form-select" id="competition">
                        <option value="Premier League">Premier League</option>
                        <option value="La Liga">La Liga</option>
                        <option value="Bundesliga">Bundesliga</option>
                        <option value="Serie A">Serie A</option>
                        <option value="Ligue 1">Ligue 1</option>
                        <option value="Champions League">Champions League</option>
                        <option value="Europa League">Europa League</option>
                        <option value="Conference League">Conference League</option>
                        <option value="EFL Cup">EFL Cup</option>
                        <option value="FA Cup">FA Cup</option>
                        <option value="Copa del Rey">Copa del Rey</option>
                        <option value="DFB Pokal">DFB Pokal</option>
                        <option value="Coppa Italia">Coppa Italia</option>
                        <option value="Turkish Super Lig">Turkish S√ºper Lig</option>
                        <option value="Eredivisie">Eredivisie</option>
                        <option value="Portuguese Liga">Portuguese Liga</option>
                        <option value="Championship">Championship</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Market</label>
                    <select class="form-select" id="marketType">
                        <optgroup label="Result">
                            <option value="Home Win">Home Win</option>
                            <option value="Away Win">Away Win</option>
                            <option value="Draw">Draw</option>
                        </optgroup>
                        <optgroup label="Double Chance">
                            <option value="1X">1X (Home/Draw)</option>
                            <option value="X2">X2 (Draw/Away)</option>
                            <option value="12">12 (Home/Away)</option>
                        </optgroup>
                        <optgroup label="Over Goals">
                            <option value="Over 0.5">Over 0.5</option>
                            <option value="Over 1.5">Over 1.5</option>
                            <option value="Over 2.5">Over 2.5</option>
                            <option value="Over 3.5">Over 3.5</option>
                        </optgroup>
                        <optgroup label="Under Goals">
                            <option value="Under 2.5">Under 2.5</option>
                            <option value="Under 3.5">Under 3.5</option>
                            <option value="Under 4.5">Under 4.5</option>
                            <option value="Under 5.5">Under 5.5</option>
                        </optgroup>
                        <optgroup label="BTTS">
                            <option value="BTTS Yes">BTTS Yes</option>
                            <option value="BTTS No">BTTS No</option>
                        </optgroup>
                        <optgroup label="Team">
                            <option value="Team to Score">Team to Score</option>
                            <option value="Team Over 1.5">Team Over 1.5</option>
                            <option value="Clean Sheet">Clean Sheet</option>
                        </optgroup>
                        <optgroup label="Half Goals">
                            <option value="Over 0.5 1H">O0.5 1st Half</option>
                            <option value="Over 0.5 2H">O0.5 2nd Half</option>
                            <option value="Under 1.5 2H">U1.5 2nd Half</option>
                            <option value="Under 2.5 2H">U2.5 2nd Half</option>
                        </optgroup>
                        <optgroup label="Handicap">
                            <option value="AH -0.5">AH -0.5</option>
                            <option value="AH -1">AH -1</option>
                            <option value="AH -1.5">AH -1.5</option>
                        </optgroup>
                        <optgroup label="Combo">
                            <option value="Win + O1.5">Win + O1.5</option>
                            <option value="Win + O2.5">Win + O2.5</option>
                            <option value="Win + BTTS">Win + BTTS</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Selection</label>
                    <input type="text" class="form-input" id="selection" placeholder="e.g., Man City to Win vs Everton" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Odds</label>
                        <input type="number" class="form-input" id="odds" step="0.01" min="1.01" placeholder="1.20" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stake ¬£</label>
                        <input type="number" class="form-input" id="stake" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Returns: <strong class="green" id="potentialReturns">¬£0.00</strong></label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Confidence</label>
                        <select class="form-select" id="confidence">
                            <option value="high">üü¢ High</option>
                            <option value="medium" selected>üü° Medium</option>
                            <option value="low">üî¥ Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-input" id="notes" placeholder="Optional">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%;">üìù Record Bet</button>
            </form>
        </div>

        <!-- Pending Bets -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">‚è≥ Pending Bets</span>
                <span class="card-icon icon-orange">üéüÔ∏è</span>
            </div>
            <div id="pendingBets">
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No pending bets</p>
                </div>
            </div>
        </div>

        <!-- Probability -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üé≤ Success Probability</span>
                <span class="card-icon icon-purple">üìê</span>
            </div>
            <div class="prob-display">
                <div class="prob-value" id="successProb">2.1%</div>
                <div class="prob-label">Chance of completing all 21 days</div>
            </div>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <span class="analysis-label">Bets Left</span>
                    <span class="analysis-value" id="betsRemaining">21</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Required Win Rate</span>
                    <span class="analysis-value">83.3%</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Implied Prob</span>
                    <span class="analysis-value" id="impliedProb">83.3%</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Kelly</span>
                    <span class="analysis-value" id="kellyStake">-</span>
                </div>
            </div>
            <div class="risk-meter">
                <p style="font-size: 0.75rem; margin-bottom: 6px; color: var(--text-secondary);">Risk Level</p>
                <div class="risk-bar">
                    <div class="risk-indicator" id="riskIndicator" style="left: 70%;"></div>
                </div>
                <div class="risk-labels">
                    <span>Low</span>
                    <span>Medium</span>
                    <span>High</span>
                    <span>Extreme</span>
                </div>
            </div>
        </div>

        <!-- Milestones -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üèÜ Milestones</span>
                <span class="card-icon icon-green">üéØ</span>
            </div>
            <ul class="milestone-list" id="milestoneList"></ul>
        </div>

        <!-- Analytics -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìà Analytics</span>
                <span class="card-icon icon-purple">üî¨</span>
            </div>
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-card-value green" id="statROI">0%</div>
                    <div class="stat-card-label">ROI</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value blue" id="statAvgStake">¬£0</div>
                    <div class="stat-card-label">Avg Stake</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value orange" id="statBestMarket">-</div>
                    <div class="stat-card-label">Best Mkt</div>
                </div>
            </div>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <span class="analysis-label">Best League</span>
                    <span class="analysis-value" id="statBestComp">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Confidence Hit</span>
                    <span class="analysis-value" id="statConfAcc">-</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Best Odds</span>
                    <span class="analysis-value" id="statOptOdds">-</span>
                </div>
            </div>
            <p style="font-size: 0.75rem; margin: 10px 0 6px; color: var(--text-secondary);">Day Performance</p>
            <div class="day-performance" id="dayPerformance"></div>
        </div>

        <!-- Market Performance -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìä Market Stats</span>
                <span class="card-icon icon-blue">üìà</span>
            </div>
            <div class="table-container" style="max-height: 220px;">
                <table>
                    <thead><tr><th>Market</th><th>Bets</th><th>Won</th><th>%</th></tr></thead>
                    <tbody id="marketTableBody">
                        <tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Chart -->
        <div class="card full-width">
            <div class="card-header">
                <span class="card-title">üìà Balance Chart</span>
                <span class="card-icon icon-green">üíπ</span>
            </div>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>

        <!-- History -->
        <div class="card full-width">
            <div class="card-header">
                <span class="card-title">üìú History</span>
                <span class="card-icon icon-blue">üìã</span>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Day</th><th>Date</th><th>Selection</th><th>Market</th>
                            <th>Odds</th><th>Stake</th><th>Result</th><th>Return</th>
                            <th>Balance</th><th>+/-</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="10" style="text-align: center; color: var(--text-secondary);">No bets yet</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="data-actions">
                <button class="btn btn-secondary" onclick="exportData()">üì§ Export</button>
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì• Import</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-info" onclick="requestNotificationPermission()">üîî</button>
                <button class="btn btn-warning" onclick="checkAPIStatus()">üìä API</button>
                <button class="btn btn-danger" onclick="confirmReset()">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Targets -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìÖ Targets</span>
                <span class="card-icon icon-purple">üìã</span>
            </div>
            <div class="table-container" style="max-height: 280px;">
                <table>
                    <thead><tr><th>Day</th><th>Target</th><th>+</th></tr></thead>
                    <tbody id="targetsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Tips -->
        <div class="card">
            <div class="card-header">
                <span class="card-title">üí° Strategy</span>
                <span class="card-icon icon-orange">üî•</span>
            </div>
            <div class="analysis-grid">
                <div class="analysis-item">
                    <span class="analysis-label">Safe Markets</span>
                    <span class="analysis-value green">U5.5, O0.5</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Rec. Odds</span>
                    <span class="analysis-value" id="recommendedOdds">1.18-1.25</span>
                </div>
                <div class="analysis-item">
                    <span class="analysis-label">Today</span>
                    <span class="analysis-value" id="strategyTip">Build buffer</span>
                </div>
            </div>
            <div style="margin-top: 10px;">
                <p class="form-label">Quick Markets</p>
                <div class="selection-pills">
                    <span class="pill" onclick="selectMarket('Over 0.5')">O0.5</span>
                    <span class="pill" onclick="selectMarket('Under 5.5')">U5.5</span>
                    <span class="pill" onclick="selectMarket('Home Win')">Home</span>
                    <span class="pill" onclick="selectMarket('Over 1.5')">O1.5</span>
                    <span class="pill" onclick="selectMarket('Team to Score')">Team</span>
                    <span class="pill" onclick="selectMarket('1X')">1X</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Record Result</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBetDetails"></div>
            <div class="form-group">
                <label class="form-label">Score (optional)</label>
                <input type="text" class="form-input" id="finalScore" placeholder="e.g., 2-1">
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <div class="btn-group" style="margin: 0;">
                    <button class="btn btn-success" onclick="recordResult('won')">‚úÖ WON</button>
                    <button class="btn btn-danger" onclick="recordResult('lost')">‚ùå LOST</button>
                </div>
                <button class="btn btn-secondary" onclick="recordResult('void')">‚ö™ VOID</button>
            </div>
        </div>
    </div>

    <script>
    // ==================== API CONFIGURATION ====================
    const API_FOOTBALL_KEY = '89d2f65b7dc64f8d0fce8468e2a8af2b';
    const API_FOOTBALL_BASE = 'https://v3.football.api-sports.io';
    const ODDS_API_KEY = '08a37ce2bc2d91fd117896ba39e62f1a';
    
    // League Configuration - Top 20 European + Saudi + Cups
const LEAGUES = {
    // England
    39: { name: 'Premier League', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', short: 'EPL', country: 'England' },
    40: { name: 'Championship', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', short: 'Champ', country: 'England' },
    41: { name: 'League One', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', short: 'L1', country: 'England' },
    42: { name: 'League Two', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', short: 'L2', country: 'England' },
    45: { name: 'FA Cup', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', short: 'FA', country: 'England' },
    48: { name: 'EFL Cup', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø', short: 'EFL', country: 'England' },
    
    // Spain
    140: { name: 'La Liga', flag: 'üá™üá∏', short: 'Liga', country: 'Spain' },
    141: { name: 'La Liga 2', flag: 'üá™üá∏', short: 'Liga2', country: 'Spain' },
    143: { name: 'Copa del Rey', flag: 'üá™üá∏', short: 'Copa', country: 'Spain' },
    
    // Germany
    78: { name: 'Bundesliga', flag: 'üá©üá™', short: 'Bund', country: 'Germany' },
    79: { name: '2. Bundesliga', flag: 'üá©üá™', short: 'Bund2', country: 'Germany' },
    81: { name: 'DFB Pokal', flag: 'üá©üá™', short: 'DFB', country: 'Germany' },
    
    // Italy
    135: { name: 'Serie A', flag: 'üáÆüáπ', short: 'SerieA', country: 'Italy' },
    136: { name: 'Serie B', flag: 'üáÆüáπ', short: 'SerieB', country: 'Italy' },
    137: { name: 'Coppa Italia', flag: 'üáÆüáπ', short: 'Coppa', country: 'Italy' },
    
    // France
    61: { name: 'Ligue 1', flag: 'üá´üá∑', short: 'L1', country: 'France' },
    62: { name: 'Ligue 2', flag: 'üá´üá∑', short: 'L2', country: 'France' },
    66: { name: 'Coupe de France', flag: 'üá´üá∑', short: 'CdF', country: 'France' },
    
    // Portugal
    94: { name: 'Primeira Liga', flag: 'üáµüáπ', short: 'Liga', country: 'Portugal' },
    95: { name: 'Liga Portugal 2', flag: 'üáµüáπ', short: 'LP2', country: 'Portugal' },
    96: { name: 'Ta√ßa de Portugal', flag: 'üáµüáπ', short: 'Taca', country: 'Portugal' },
    
    // Netherlands
    88: { name: 'Eredivisie', flag: 'üá≥üá±', short: 'Ere', country: 'Netherlands' },
    89: { name: 'Eerste Divisie', flag: 'üá≥üá±', short: 'Eerste', country: 'Netherlands' },
    90: { name: 'KNVB Beker', flag: 'üá≥üá±', short: 'KNVB', country: 'Netherlands' },
    
    // Belgium
    144: { name: 'Jupiler Pro', flag: 'üáßüá™', short: 'JPL', country: 'Belgium' },
    145: { name: 'Challenger Pro', flag: 'üáßüá™', short: 'B1B', country: 'Belgium' },
    147: { name: 'Belgian Cup', flag: 'üáßüá™', short: 'BeCup', country: 'Belgium' },
    
    // Turkey
    203: { name: 'S√ºper Lig', flag: 'üáπüá∑', short: 'TSL', country: 'Turkey' },
    204: { name: '1. Lig', flag: 'üáπüá∑', short: 'T1L', country: 'Turkey' },
    206: { name: 'Turkish Cup', flag: 'üáπüá∑', short: 'TrCup', country: 'Turkey' },
    
    // Scotland
    179: { name: 'Premiership', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', short: 'SPFL', country: 'Scotland' },
    180: { name: 'Championship', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', short: 'SCh', country: 'Scotland' },
    183: { name: 'Scottish Cup', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø', short: 'SCup', country: 'Scotland' },
    
    // Austria
    218: { name: 'Bundesliga', flag: 'üá¶üáπ', short: 'ABL', country: 'Austria' },
    220: { name: '√ñFB Cup', flag: 'üá¶üáπ', short: 'OFB', country: 'Austria' },
    
    // Switzerland
    207: { name: 'Super League', flag: 'üá®üá≠', short: 'SUI', country: 'Switzerland' },
    209: { name: 'Swiss Cup', flag: 'üá®üá≠', short: 'SwCup', country: 'Switzerland' },
    
    // Greece
    197: { name: 'Super League', flag: 'üá¨üá∑', short: 'GRE', country: 'Greece' },
    199: { name: 'Greek Cup', flag: 'üá¨üá∑', short: 'GrCup', country: 'Greece' },
    
    // Russia
    235: { name: 'Premier League', flag: 'üá∑üá∫', short: 'RPL', country: 'Russia' },
    237: { name: 'Russian Cup', flag: 'üá∑üá∫', short: 'RuCup', country: 'Russia' },
    
    // Ukraine
    333: { name: 'Premier League', flag: 'üá∫üá¶', short: 'UPL', country: 'Ukraine' },
    
    // Denmark
    119: { name: 'Superliga', flag: 'üá©üá∞', short: 'DEN', country: 'Denmark' },
    121: { name: 'DBU Pokalen', flag: 'üá©üá∞', short: 'DBU', country: 'Denmark' },
    
    // Norway
    103: { name: 'Eliteserien', flag: 'üá≥üá¥', short: 'NOR', country: 'Norway' },
    105: { name: 'Norwegian Cup', flag: 'üá≥üá¥', short: 'NoCup', country: 'Norway' },
    
    // Sweden
    113: { name: 'Allsvenskan', flag: 'üá∏üá™', short: 'SWE', country: 'Sweden' },
    115: { name: 'Svenska Cupen', flag: 'üá∏üá™', short: 'SwCup', country: 'Sweden' },
    
    // Czech Republic
    345: { name: 'First League', flag: 'üá®üáø', short: 'CZE', country: 'Czech' },
    347: { name: 'Czech Cup', flag: 'üá®üáø', short: 'CzCup', country: 'Czech' },
    
    // Poland
    106: { name: 'Ekstraklasa', flag: 'üáµüá±', short: 'POL', country: 'Poland' },
    108: { name: 'Polish Cup', flag: 'üáµüá±', short: 'PlCup', country: 'Poland' },
    
    // Croatia
    210: { name: 'HNL', flag: 'üá≠üá∑', short: 'CRO', country: 'Croatia' },
    212: { name: 'Croatian Cup', flag: 'üá≠üá∑', short: 'CrCup', country: 'Croatia' },
    
    // Serbia
    286: { name: 'Super Liga', flag: 'üá∑üá∏', short: 'SRB', country: 'Serbia' },
    
    // Romania
    283: { name: 'Liga I', flag: 'üá∑üá¥', short: 'ROM', country: 'Romania' },
    285: { name: 'Cupa Rom√¢niei', flag: 'üá∑üá¥', short: 'RoCup', country: 'Romania' },
    
    // Cyprus
    318: { name: 'First Division', flag: 'üá®üáæ', short: 'CYP', country: 'Cyprus' },
    
    // Saudi Arabia
    307: { name: 'Saudi Pro League', flag: 'üá∏üá¶', short: 'SPL', country: 'Saudi' },
    308: { name: 'Division 1', flag: 'üá∏üá¶', short: 'SD1', country: 'Saudi' },
    309: { name: 'Kings Cup', flag: 'üá∏üá¶', short: 'SAcup', country: 'Saudi' },
    
    // European Competitions
    2: { name: 'Champions League', flag: 'üèÜ', short: 'UCL', country: 'Europe' },
    3: { name: 'Europa League', flag: 'üèÜ', short: 'UEL', country: 'Europe' },
    848: { name: 'Conference League', flag: 'üèÜ', short: 'UECL', country: 'Europe' },
    531: { name: 'UEFA Super Cup', flag: 'üèÜ', short: 'USC', country: 'Europe' },
    
    // International
    4: { name: 'Euro Championship', flag: 'üá™üá∫', short: 'EURO', country: 'Europe' },
    5: { name: 'UEFA Nations League', flag: 'üá™üá∫', short: 'UNL', country: 'Europe' },
    1: { name: 'World Cup', flag: 'üåç', short: 'WC', country: 'World' },
    15: { name: 'Club World Cup', flag: 'üåç', short: 'CWC', country: 'World' },
    
    // Club Friendlies
    667: { name: 'Club Friendlies', flag: '‚öΩ', short: 'Friend', country: 'World' }
};

    // ==================== CONSTANTS ====================
    const STORAGE_KEY = 'bettingChallenge';
    let INITIAL_BALANCE = 200;
    let TARGET_MULTIPLIER = 1.20;
    let TARGET_DAYS = 21;
    let FINAL_TARGET = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, TARGET_DAYS);

    // ==================== STATE ====================
    let challengeData = {
        startDate: null,
        currentBalance: INITIAL_BALANCE,
        bets: [],
        pendingBets: [],
        settings: { initialBalance: INITIAL_BALANCE, dailyTarget: TARGET_MULTIPLIER, targetDays: TARGET_DAYS }
    };

    let allFixtures = [];
    let deferredPrompt = null;
    let apiQuota = { used: 0, limit: 7500 };

    // ==================== UTILITY ====================
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    function showNotification(msg, type) {
        document.querySelectorAll('.notification').forEach(n => n.remove());
        const n = document.createElement('div');
        n.className = `notification notification-${type}`;
        n.textContent = msg;
        document.body.appendChild(n);
        setTimeout(() => n.remove(), 5000);
    }

    function log(msg, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        if (data) {
            console.log(`[${timestamp}] ${msg}`, data);
        } else {
            console.log(`[${timestamp}] ${msg}`);
        }
    }

    // ==================== PWA ====================
    window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('installBanner').classList.add('show');
    });

    function installApp() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(() => {
                deferredPrompt = null;
                document.getElementById('installBanner').classList.remove('show');
            });
        }
    }

    function dismissInstallBanner() {
        document.getElementById('installBanner').classList.remove('show');
    }

    // ==================== DATA ====================
    function loadData() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            try {
                challengeData = JSON.parse(saved);
                if (challengeData.settings) {
                    INITIAL_BALANCE = challengeData.settings.initialBalance || 200;
                    TARGET_MULTIPLIER = challengeData.settings.dailyTarget || 1.20;
                    TARGET_DAYS = challengeData.settings.targetDays || 21;
                    FINAL_TARGET = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, TARGET_DAYS);
                }
            } catch(e) { initData(); }
        } else { initData(); }
        updateUI();
    }

    function initData() {
        challengeData = {
            startDate: new Date().toISOString().split('T')[0],
            currentBalance: INITIAL_BALANCE,
            bets: [],
            pendingBets: [],
            settings: { initialBalance: INITIAL_BALANCE, dailyTarget: TARGET_MULTIPLIER, targetDays: TARGET_DAYS }
        };
        saveData();
    }

    function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(challengeData)); }

    function exportData() {
        const blob = new Blob([JSON.stringify(challengeData, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `bet-tracker-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showNotification('Exported!', 'success');
    }

    function importData(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    challengeData = JSON.parse(ev.target.result);
                    saveData();
                    updateUI();
                    showNotification('Imported!', 'success');
                } catch(err) { showNotification('Import failed!', 'error'); }
            };
            reader.readAsText(file);
        }
        e.target.value = '';
    }

    function confirmReset() {
        if (confirm('Reset all data? This cannot be undone!')) {
            localStorage.removeItem(STORAGE_KEY);
            initData();
            updateUI();
            showNotification('Reset complete!', 'success');
        }
    }

    // ==================== API-FOOTBALL ====================
    async function fetchTodaysFixtures() {
        const container = document.getElementById('fixturesContainer');
        const dot = document.getElementById('apiStatusDot');
        const text = document.getElementById('apiStatusText');
        
        dot.className = 'api-dot loading';
        text.textContent = 'Loading...';
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

        // Get today and next 3 days
        const today = new Date();
        const dates = [];
        for (let i = 0; i < 4; i++) {
            const d = new Date(today);
            d.setDate(d.getDate() + i);
            dates.push(d.toISOString().split('T')[0]);
        }
        
        log(`Fetching fixtures for dates: ${dates.join(', ')}`);
        
        allFixtures = [];
        
        // Expanded league list - Top 20 European + Saudi + Cups
    const leagueIds = [
        // Top 5 Leagues
        39, 140, 78, 135, 61,
        // Second Tiers
        40, 141, 79, 136, 62,
        // Other Top Leagues
        94, 88, 144, 203, 179, 307,
        // European Cups
        2, 3, 848,
        // Domestic Cups
        45, 48, 143, 81, 137, 66, 96,
        // Friendlies
        667
    ];
        
        let successCount = 0;
        let totalFixtures = 0;
        
        try {
            // First, try today's date
            log(`Trying today: ${dates[0]}`);
            
            for (const lid of leagueIds) {
                try {
                    const url = `${API_FOOTBALL_BASE}/fixtures?league=${lid}&date=${dates[0]}`;
                    log(`Fetching: League ${lid} (${LEAGUES[lid]?.name || 'Unknown'})`);
                    
                    const res = await fetch(url, {
                        method: 'GET',
                        headers: { 'x-apisports-key': API_FOOTBALL_KEY }
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        
                        if (data.errors && Object.keys(data.errors).length > 0) {
                            log(`‚ö†Ô∏è API Error for league ${lid}:`, data.errors);
                            continue;
                        }
                        
                        if (data.response && data.response.length > 0) {
                            allFixtures.push(...data.response);
                            totalFixtures += data.response.length;
                            log(`‚úÖ League ${lid}: ${data.response.length} fixtures`);
                            successCount++;
                        } else {
                            log(`‚ÑπÔ∏è League ${lid}: 0 fixtures today`);
                        }
                        
                        // Track API usage
                        const remaining = res.headers.get('x-ratelimit-requests-remaining');
                        if (remaining) {
                            apiQuota.used = 7500 - parseInt(remaining);
                            updateQuotaDisplay();
                        }
                    } else {
                        log(`‚ùå HTTP ${res.status} for league ${lid}`);
                    }
                } catch(e) {
                    log(`‚ùå Error fetching league ${lid}: ${e.message}`);
                }
                
                await sleep(150); // Rate limit: Pro plan allows more requests
            }
            
            log(`Today's results: ${allFixtures.length} fixtures from ${successCount} leagues`);

            // If no fixtures today, check tomorrow
            if (allFixtures.length === 0 && dates.length > 1) {
                log(`No fixtures today, trying tomorrow: ${dates[1]}`);
                showNotification('No matches today, checking tomorrow...', 'info');
                
                for (const lid of leagueIds.slice(0, 10)) { // Check fewer leagues for tomorrow
                    try {
                        const url = `${API_FOOTBALL_BASE}/fixtures?league=${lid}&date=${dates[1]}`;
                        const res = await fetch(url, {
                            method: 'GET',
                            headers: { 'x-apisports-key': API_FOOTBALL_KEY }
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            if (data.response && data.response.length > 0) {
                                allFixtures.push(...data.response);
                                log(`‚úÖ Tomorrow - League ${lid}: ${data.response.length} fixtures`);
                            }
                        }
                    } catch(e) {}
                    await sleep(150);
                }
            }
            
            // If still no fixtures, check next 2 days
            if (allFixtures.length === 0) {
                log('No fixtures tomorrow either, checking next few days...');
                
                for (let dateIdx = 2; dateIdx < dates.length; dateIdx++) {
                    for (const lid of [39, 140, 78, 135, 61]) { // Major leagues only
                        try {
                            const url = `${API_FOOTBALL_BASE}/fixtures?league=${lid}&date=${dates[dateIdx]}`;
                            const res = await fetch(url, {
                                method: 'GET',
                                headers: { 'x-apisports-key': API_FOOTBALL_KEY }
                            });
                            
                            if (res.ok) {
                                const data = await res.json();
                                if (data.response && data.response.length > 0) {
                                    allFixtures.push(...data.response);
                                }
                            }
                        } catch(e) {}
                        await sleep(150);
                    }
                    
                    if (allFixtures.length > 0) break;
                }
            }

            // Final result
            if (allFixtures.length > 0) {
                dot.className = 'api-dot online';
                
                // Check if fixtures are from today or future
                const todayStr = dates[0];
                const todayFixtures = allFixtures.filter(f => f.fixture.date.startsWith(todayStr));
                
                if (todayFixtures.length > 0) {
                    text.textContent = `${allFixtures.length} live`;
                } else {
                    text.textContent = `${allFixtures.length} upcoming`;
                }
                
                displayFixtures(allFixtures);
                showNotification(`‚úÖ Loaded ${allFixtures.length} fixtures from API`, 'success');
                log(`SUCCESS: Displaying ${allFixtures.length} fixtures`);
            } else {
                // Truly no fixtures found
                log('No fixtures found in any league for the next few days');
                dot.className = 'api-dot online';
                text.textContent = 'No matches';
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No upcoming fixtures found</p>
                        <p style="font-size: 0.7rem; margin-top: 8px; color: var(--text-secondary);">
                            This might be during an international break or off-season.
                        </p>
                        <button class="btn btn-secondary" onclick="loadDemoFixtures()" style="margin-top: 12px;">Load Demo Data</button>
                    </div>
                `;
            }
        } catch(e) {
            log(`FATAL ERROR: ${e.message}`, e);
            dot.className = 'api-dot offline';
            text.textContent = 'Error';
            showNotification(`API Error: ${e.message}`, 'error');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <p>API Error</p>
                    <p style="font-size: 0.7rem; margin-top: 8px;">${e.message}</p>
                    <button class="btn btn-primary" onclick="refreshFixtures()" style="margin-top: 12px;">Retry</button>
                    <button class="btn btn-secondary" onclick="loadDemoFixtures()" style="margin-top: 8px;">Use Demo</button>
                </div>
            `;
        }
    }

    async function checkAPIStatus() {
        log('Checking API status...');
        try {
            const res = await fetch(`${API_FOOTBALL_BASE}/status`, {
                method: 'GET',
                headers: { 'x-apisports-key': API_FOOTBALL_KEY }
            });
            
            if (res.ok) {
                const data = await res.json();
                log('API Status Response:', data);
                
                const r = data.response;
                if (r) {
                    apiQuota.used = r.requests?.current || 0;
                    apiQuota.limit = r.requests?.limit_day || 7500;
                    updateQuotaDisplay();
                    
                    const info = `API: ${apiQuota.used}/${apiQuota.limit} calls | Account: ${r.account?.firstname || 'Unknown'} | Plan: ${r.subscription?.plan || 'Unknown'}`;
                    showNotification(info, 'info');
                    log(info);
                }
            } else {
                log(`API Status check failed: HTTP ${res.status}`);
                showNotification(`API check failed: HTTP ${res.status}`, 'error');
            }
        } catch(e) {
            log(`API Status error: ${e.message}`);
            showNotification(`API error: ${e.message}`, 'error');
        }
    }

    // Test API with a simple call
    async function testAPI() {
        log('Testing API connection...');
        showNotification('Testing API...', 'info');
        
        try {
            // Test 1: Status endpoint
            const statusRes = await fetch(`${API_FOOTBALL_BASE}/status`, {
                method: 'GET',
                headers: { 'x-apisports-key': API_FOOTBALL_KEY }
            });
            
            if (!statusRes.ok) {
                throw new Error(`Status endpoint returned ${statusRes.status}`);
            }
            
            const statusData = await statusRes.json();
            log('Status test passed:', statusData);
            
            // Test 2: Get today's Premier League fixtures
            const today = new Date().toISOString().split('T')[0];
            const plRes = await fetch(`${API_FOOTBALL_BASE}/fixtures?league=39&date=${today}`, {
                method: 'GET',
                headers: { 'x-apisports-key': API_FOOTBALL_KEY }
            });
            
            if (!plRes.ok) {
                throw new Error(`Fixtures endpoint returned ${plRes.status}`);
            }
            
            const plData = await plRes.json();
            log(`Premier League fixtures for ${today}:`, plData);
            
            // Test 3: Try getting fixtures for next 7 days
            const weekRes = await fetch(`${API_FOOTBALL_BASE}/fixtures?league=39&next=10`, {
                method: 'GET',
                headers: { 'x-apisports-key': API_FOOTBALL_KEY }
            });
            
            if (weekRes.ok) {
                const weekData = await weekRes.json();
                log('Next 10 PL fixtures:', weekData);
                
                if (weekData.response && weekData.response.length > 0) {
                    showNotification(`API OK! Found ${weekData.response.length} upcoming PL fixtures`, 'success');
                } else {
                    showNotification('API OK but no upcoming PL fixtures found', 'warning');
                }
            }
            
        } catch(e) {
            log(`API Test failed: ${e.message}`);
            showNotification(`API Test failed: ${e.message}`, 'error');
        }
    }

    // Fetch using "next" parameter instead of date
    async function fetchUpcomingFixtures() {
        const container = document.getElementById('fixturesContainer');
        const dot = document.getElementById('apiStatusDot');
        const text = document.getElementById('apiStatusText');
        
        dot.className = 'api-dot loading';
        text.textContent = 'Loading...';
        container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        
        log('Fetching upcoming fixtures using "next" parameter...');
        
        allFixtures = [];
        // Expanded league list - Top 20 European + Saudi + Cups
    const leagueIds = [
        // Top 5 Leagues
        39, 140, 78, 135, 61,
        // Second Tiers
        40, 141, 79, 136, 62,
        // Other Top Leagues
        94, 88, 144, 203, 179, 307,
        // European Cups
        2, 3, 848,
        // Domestic Cups
        45, 48, 143, 81, 137, 66, 96,
        // Friendlies
        667
    ];
        
        try {
            for (const lid of leagueIds) {
                try {
                    // Use "next" parameter to get upcoming fixtures regardless of date
                    const url = `${API_FOOTBALL_BASE}/fixtures?league=${lid}&next=5`;
                    log(`Fetching next 5 fixtures for league ${lid}`);
                    
                    const res = await fetch(url, {
                        method: 'GET',
                        headers: { 'x-apisports-key': API_FOOTBALL_KEY }
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        
                        if (data.response && data.response.length > 0) {
                            allFixtures.push(...data.response);
                            log(`‚úÖ League ${lid}: ${data.response.length} upcoming fixtures`);
                        }
                        
                        const remaining = res.headers.get('x-ratelimit-requests-remaining');
                        if (remaining) {
                            apiQuota.used = 7500 - parseInt(remaining);
                            updateQuotaDisplay();
                        }
                    }
                } catch(e) {
                    log(`Error for league ${lid}: ${e.message}`);
                }
                
                await sleep(150);
            }
            
            if (allFixtures.length > 0) {
                // Sort by date
                allFixtures.sort((a, b) => new Date(a.fixture.date) - new Date(b.fixture.date));
                
                dot.className = 'api-dot online';
                text.textContent = `${allFixtures.length} upcoming`;
                displayFixtures(allFixtures);
                showNotification(`‚úÖ Loaded ${allFixtures.length} upcoming fixtures`, 'success');
            } else {
                dot.className = 'api-dot online';
                text.textContent = 'No fixtures';
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÖ</div>
                        <p>No upcoming fixtures found</p>
                        <button class="btn btn-secondary" onclick="loadDemoFixtures()" style="margin-top: 12px;">Load Demo</button>
                    </div>
                `;
            }
        } catch(e) {
            log(`Error: ${e.message}`);
            dot.className = 'api-dot offline';
            text.textContent = 'Error';
        }
    }

    function updateQuotaDisplay() {
        const container = document.getElementById('apiQuotaContainer');
        const text = document.getElementById('apiQuotaText');
        const fill = document.getElementById('apiQuotaFill');
        
        container.style.display = 'block';
        text.textContent = `${apiQuota.used}/${apiQuota.limit}`;
        const pct = (apiQuota.used / apiQuota.limit) * 100;
        fill.style.width = `${pct}%`;
        fill.className = 'quota-fill' + (pct > 90 ? ' danger' : pct > 70 ? ' warning' : '');
    }

    function displayFixtures(fixtures) {
        const container = document.getElementById('fixturesContainer');
        
        if (!fixtures || fixtures.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No fixtures</p></div>';
            return;
        }
        
        // Sort by date
        const sorted = [...fixtures].sort((a, b) => new Date(a.fixture.date) - new Date(b.fixture.date));
        
        container.innerHTML = sorted.map(m => {
            const f = m.fixture;
            const t = m.teams;
            const l = m.league;
            const g = m.goals;
            
            const date = new Date(f.date);
            const time = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            const dateStr = date.toLocaleDateString('en-GB', { weekday: 'short', day: '2-digit', month: 'short' });
            
            const status = f.status?.short || 'NS';
            const isLive = ['1H', '2H', 'HT', 'ET', 'P', 'BT', 'LIVE'].includes(status);
            const isFinished = ['FT', 'AET', 'PEN'].includes(status);
            
            const league = LEAGUES[l.id] || { name: l.name || 'Unknown', flag: '‚öΩ', short: (l.name || 'UNK').substring(0, 4) };
            
            const home = (t.home?.name || 'Home').replace(/'/g, "\\'");
            const away = (t.away?.name || 'Away').replace(/'/g, "\\'");
            
            let badge = '';
            if (isLive) badge = `<span class="status-badge badge-live">üî¥ ${status} ${g?.home ?? 0}-${g?.away ?? 0}</span>`;
            else if (isFinished) badge = `<span class="status-badge badge-ft">FT ${g?.home ?? 0}-${g?.away ?? 0}</span>`;
            
            return `
                <div class="match-card" data-league="${l.id}" onclick="selectFixture('${home}', '${away}', '${league.name}')">
                    <div class="match-header">
                        <span class="match-league">${league.flag} ${league.short}</span>
                        <span class="match-time">${badge || dateStr + ' ' + time}</span>
                    </div>
                    <div class="match-teams-row">
                        <div class="team-info">
                            ${t.home?.logo ? `<img src="${t.home.logo}" class="team-logo" onerror="this.style.display='none'" alt="">` : ''}
                            <span class="team-name">${t.home?.name || 'Home'}</span>
                        </div>
                        <div class="match-score">${isLive || isFinished ? `${g?.home ?? 0}-${g?.away ?? 0}` : 'vs'}</div>
                        <div class="team-info away">
                            ${t.away?.logo ? `<img src="${t.away.logo}" class="team-logo" onerror="this.style.display='none'" alt="">` : ''}
                            <span class="team-name">${t.away?.name || 'Away'}</span>
                        </div>
                    </div>
                    <div class="match-odds">
                        <div class="odd-btn" onclick="event.stopPropagation(); quickBet('${home}', 'Home Win', '${home} vs ${away}', '${league.name}')">
                            <div class="odd-label">1</div>
                            <div class="odd-value">-</div>
                        </div>
                        <div class="odd-btn" onclick="event.stopPropagation(); quickBet('Draw', 'Draw', '${home} vs ${away}', '${league.name}')">
                            <div class="odd-label">X</div>
                            <div class="odd-value">-</div>
                        </div>
                        <div class="odd-btn" onclick="event.stopPropagation(); quickBet('${away}', 'Away Win', '${home} vs ${away}', '${league.name}')">
                            <div class="odd-label">2</div>
                            <div class="odd-value">-</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function filterFixtures(lid, btn) {
        document.querySelectorAll('#fixtureTabs .tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        
        if (lid === 'all') {
            displayFixtures(allFixtures);
        } else {
            displayFixtures(allFixtures.filter(f => f.league.id === lid));
        }
    }

    function selectFixture(home, away, comp) {
        document.getElementById('selection').value = `${home} vs ${away}`;
        document.getElementById('competition').value = mapComp(comp);
        document.getElementById('odds').focus();
        document.getElementById('betForm').scrollIntoView({ behavior: 'smooth' });
    }

    function quickBet(team, market, match, comp) {
        document.getElementById('selection').value = `${team} - ${match}`;
        document.getElementById('marketType').value = market;
        document.getElementById('competition').value = mapComp(comp);
        document.getElementById('odds').focus();
        document.getElementById('betForm').scrollIntoView({ behavior: 'smooth' });
        showNotification(`${team} selected`, 'info');
    }

    function mapComp(name) {
        const map = {
            'Premier League': 'Premier League',
            'La Liga': 'La Liga',
            'Bundesliga': 'Bundesliga',
            'Serie A': 'Serie A',
            'Ligue 1': 'Ligue 1',
            'Champions League': 'Champions League',
            'Europa League': 'Europa League',
            'Conference League': 'Conference League',
            'Championship': 'Championship',
            'FA Cup': 'FA Cup',
            'EFL Cup': 'EFL Cup',
            'Eredivisie': 'Eredivisie'
        };
        for (const [k, v] of Object.entries(map)) if (name?.includes(k)) return v;
        return 'Other';
    }

    function refreshFixtures() { 
        log('Manual refresh triggered');
        fetchUpcomingFixtures(); // Use the "next" method instead
    }

    function loadDemoFixtures() {
        const dot = document.getElementById('apiStatusDot');
        const text = document.getElementById('apiStatusText');
        const now = new Date();
        
        allFixtures = [
            { fixture: { id: 1, date: new Date(now.getTime() + 2*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 39, name: 'Premier League' },
              teams: { home: { name: 'Manchester City', logo: 'https://media.api-sports.io/football/teams/50.png' }, away: { name: 'Everton', logo: 'https://media.api-sports.io/football/teams/45.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 2, date: new Date(now.getTime() + 4*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 39, name: 'Premier League' },
              teams: { home: { name: 'Liverpool', logo: 'https://media.api-sports.io/football/teams/40.png' }, away: { name: 'Brighton', logo: 'https://media.api-sports.io/football/teams/51.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 3, date: new Date(now.getTime() + 28*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 39, name: 'Premier League' },
              teams: { home: { name: 'Arsenal', logo: 'https://media.api-sports.io/football/teams/42.png' }, away: { name: 'Newcastle', logo: 'https://media.api-sports.io/football/teams/34.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 4, date: new Date(now.getTime() + 6*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 140, name: 'La Liga' },
              teams: { home: { name: 'Real Madrid', logo: 'https://media.api-sports.io/football/teams/541.png' }, away: { name: 'Getafe', logo: 'https://media.api-sports.io/football/teams/546.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 5, date: new Date(now.getTime() + 30*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 140, name: 'La Liga' },
              teams: { home: { name: 'Barcelona', logo: 'https://media.api-sports.io/football/teams/529.png' }, away: { name: 'Athletic Bilbao', logo: 'https://media.api-sports.io/football/teams/531.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 6, date: new Date(now.getTime() + 3*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 78, name: 'Bundesliga' },
              teams: { home: { name: 'Bayern Munich', logo: 'https://media.api-sports.io/football/teams/157.png' }, away: { name: 'Dortmund', logo: 'https://media.api-sports.io/football/teams/165.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 7, date: new Date(now.getTime() + 5*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 135, name: 'Serie A' },
              teams: { home: { name: 'Inter Milan', logo: 'https://media.api-sports.io/football/teams/505.png' }, away: { name: 'AC Milan', logo: 'https://media.api-sports.io/football/teams/489.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 8, date: new Date(now.getTime() + 8*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 61, name: 'Ligue 1' },
              teams: { home: { name: 'PSG', logo: 'https://media.api-sports.io/football/teams/85.png' }, away: { name: 'Monaco', logo: 'https://media.api-sports.io/football/teams/91.png' } },
              goals: { home: null, away: null } },
            { fixture: { id: 9, date: new Date(now.getTime() + 26*3600000).toISOString(), status: { short: 'NS' } },
              league: { id: 2, name: 'Champions League' },
              teams: { home: { name: 'Chelsea', logo: 'https://media.api-sports.io/football/teams/49.png' }, away: { name: 'Benfica', logo: 'https://media.api-sports.io/football/teams/211.png' } },
              goals: { home: null, away: null } }
        ];
        
        dot.className = 'api-dot online';
        text.textContent = `${allFixtures.length} (demo)`;
        displayFixtures(allFixtures);
        showNotification('Demo data loaded', 'info');
    }

    // ==================== BET MANAGEMENT ====================
    document.getElementById('betForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (challengeData.currentBalance <= 0) {
            showNotification('Challenge ended! Reset to start again.', 'error');
            return;
        }

        const bet = {
            id: Date.now(),
            date: document.getElementById('betDate').value,
            type: document.getElementById('betType').value,
            competition: document.getElementById('competition').value,
            market: document.getElementById('marketType').value,
            selection: document.getElementById('selection').value,
            odds: parseFloat(document.getElementById('odds').value),
            stake: parseFloat(document.getElementById('stake').value),
            confidence: document.getElementById('confidence').value,
            notes: document.getElementById('notes').value,
            status: 'pending'
        };

        if (isNaN(bet.odds) || bet.odds < 1.01) { 
            showNotification('Invalid odds! Must be at least 1.01', 'error'); 
            return; 
        }
        if (isNaN(bet.stake) || bet.stake <= 0) { 
            showNotification('Invalid stake!', 'error'); 
            return; 
        }
        if (bet.stake > challengeData.currentBalance) {
            showNotification('Stake exceeds balance!', 'error');
            return;
        }

        challengeData.pendingBets.push(bet);
        saveData();
        updateUI();
        this.reset();
        setDefaultDate();
        updateStakeField();
        showNotification('Bet recorded!', 'success');
    });

    document.getElementById('odds').addEventListener('input', updateReturns);
    document.getElementById('stake').addEventListener('input', updateReturns);

    function updateReturns() {
        const odds = parseFloat(document.getElementById('odds').value) || 0;
        const stake = parseFloat(document.getElementById('stake').value) || 0;
        document.getElementById('potentialReturns').textContent = `¬£${(odds * stake).toFixed(2)}`;
    }

    let selectedBetId = null;

    function openResultModal(id) {
        selectedBetId = id;
        const bet = challengeData.pendingBets.find(b => b.id === id);
        if (!bet) return;
        
        document.getElementById('modalBetDetails').innerHTML = `
            <div class="analysis-grid" style="margin-bottom: 12px;">
                <div class="analysis-item"><span class="analysis-label">Selection</span><span class="analysis-value">${bet.selection}</span></div>
                <div class="analysis-item"><span class="analysis-label">Market</span><span class="analysis-value">${bet.market}</span></div>
                <div class="analysis-item"><span class="analysis-label">Odds</span><span class="analysis-value">${bet.odds.toFixed(2)}</span></div>
                <div class="analysis-item"><span class="analysis-label">Stake</span><span class="analysis-value">¬£${bet.stake.toFixed(2)}</span></div>
                <div class="analysis-item"><span class="analysis-label">Returns</span><span class="analysis-value green">¬£${(bet.stake * bet.odds).toFixed(2)}</span></div>
            </div>
        `;
        document.getElementById('finalScore').value = '';
        document.getElementById('resultModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('resultModal').classList.remove('active');
        selectedBetId = null;
    }

    function recordResult(result) {
        const idx = challengeData.pendingBets.findIndex(b => b.id === selectedBetId);
        if (idx === -1) return;

        const bet = challengeData.pendingBets[idx];
        bet.status = result;
        bet.finalScore = document.getElementById('finalScore').value;
        bet.day = challengeData.bets.length + 1;

        if (result === 'won') {
            bet.returns = bet.stake * bet.odds;
            challengeData.currentBalance = bet.returns;
        } else if (result === 'void') {
            bet.returns = bet.stake;
            // Balance stays the same for void
        } else {
            bet.returns = 0;
            challengeData.currentBalance = 0;
        }

        bet.balanceAfter = challengeData.currentBalance;
        bet.targetForDay = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, bet.day);
        bet.vsTarget = bet.balanceAfter - bet.targetForDay;

        challengeData.bets.push(bet);
        challengeData.pendingBets.splice(idx, 1);
        saveData();
        closeModal();
        updateUI();

        if (result === 'won') {
            showNotification(`üéâ Won! New balance: ¬£${challengeData.currentBalance.toFixed(2)}`, 'success');
            if (challengeData.currentBalance >= FINAL_TARGET) {
                setTimeout(() => showNotification('üèÜ CHALLENGE COMPLETE! You did it!', 'success'), 1500);
            }
        } else if (result === 'void') {
            showNotification('‚ö™ Bet voided - stake returned', 'info');
        } else {
            showNotification('‚ùå Challenge failed. Better luck next time!', 'error');
        }
    }

    function cancelPendingBet(id) {
        if (confirm('Cancel this bet?')) {
            challengeData.pendingBets = challengeData.pendingBets.filter(b => b.id !== id);
            saveData();
            updateUI();
            showNotification('Bet cancelled', 'success');
        }
    }

    // ==================== ANALYTICS ====================
    function calcStats() {
        const bets = challengeData.bets;
        if (!bets.length) return { roi: 0, avgStake: 0, bestMarket: { k: '-' }, bestComp: { k: '-' }, conf: { high: 0, medium: 0, low: 0 }, odds: { d: '-' }, days: {} };
        
        return {
            roi: ((challengeData.currentBalance - INITIAL_BALANCE) / INITIAL_BALANCE * 100),
            avgStake: bets.reduce((s, b) => s + b.stake, 0) / bets.length,
            bestMarket: findBest(bets, 'market'),
            bestComp: findBest(bets, 'competition'),
            conf: calcConf(bets),
            odds: calcOdds(bets),
            days: calcDays(bets)
        };
    }

    function findBest(bets, key) {
        const map = {};
        bets.forEach(b => {
            if (!map[b[key]]) map[b[key]] = { w: 0, t: 0 };
            map[b[key]].t++;
            if (b.status === 'won') map[b[key]].w++;
        });
        let best = { k: '-', r: 0 };
        Object.entries(map).forEach(([k, v]) => { 
            const r = v.t ? v.w / v.t : 0; 
            if (r > best.r) best = { k, r }; 
        });
        return best;
    }

    function calcConf(bets) {
        const c = { high: { w: 0, t: 0 }, medium: { w: 0, t: 0 }, low: { w: 0, t: 0 } };
        bets.forEach(b => { 
            if (c[b.confidence]) { 
                c[b.confidence].t++; 
                if (b.status === 'won') c[b.confidence].w++; 
            } 
        });
        return {
            high: c.high.t ? Math.round(c.high.w / c.high.t * 100) : 0,
            medium: c.medium.t ? Math.round(c.medium.w / c.medium.t * 100) : 0,
            low: c.low.t ? Math.round(c.low.w / c.low.t * 100) : 0
        };
    }

    function calcOdds(bets) {
        const won = bets.filter(b => b.status === 'won');
        if (!won.length) return { d: '-' };
        const o = won.map(b => b.odds).sort((a, b) => a - b);
        return { d: `${o[0].toFixed(2)}-${o[o.length - 1].toFixed(2)}` };
    }

    function calcDays(bets) {
        const d = { Sun: { w: 0, t: 0 }, Mon: { w: 0, t: 0 }, Tue: { w: 0, t: 0 }, Wed: { w: 0, t: 0 }, Thu: { w: 0, t: 0 }, Fri: { w: 0, t: 0 }, Sat: { w: 0, t: 0 } };
        const n = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        bets.forEach(b => { 
            if (b.date) { 
                const day = n[new Date(b.date).getDay()]; 
                d[day].t++; 
                if (b.status === 'won') d[day].w++; 
            } 
        });
        return d;
    }

    function updateAnalytics() {
        const s = calcStats();
        document.getElementById('statROI').textContent = `${s.roi.toFixed(1)}%`;
        document.getElementById('statROI').className = `stat-card-value ${s.roi >= 0 ? 'green' : 'red'}`;
        document.getElementById('statAvgStake').textContent = `¬£${s.avgStake.toFixed(0)}`;
        document.getElementById('statBestMarket').textContent = (s.bestMarket.k || '-').substring(0, 8);
        document.getElementById('statBestComp').textContent = (s.bestComp.k || '-').substring(0, 10);
        document.getElementById('statConfAcc').textContent = `H${s.conf.high}% M${s.conf.medium}%`;
        document.getElementById('statOptOdds').textContent = s.odds.d;
        
        const dp = s.days;
        document.getElementById('dayPerformance').innerHTML = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(d => {
            const data = dp[d] || { w: 0, t: 0 };
            const pct = data.t ? (data.w / data.t * 100) : 0;
            return `<div class="day-bar"><div class="day-bar-fill"><div class="day-bar-value" style="height: ${Math.max(pct, 5)}%; background: ${pct >= 50 ? 'var(--accent-green)' : 'var(--accent-red)'}"></div></div><div class="day-bar-label">${d}</div></div>`;
        }).join('');
        
        document.getElementById('roiDisplay').textContent = `${s.roi.toFixed(1)}%`;
    }

    function requestNotificationPermission() {
        if (!('Notification' in window)) { 
            showNotification('Notifications not supported in this browser', 'warning'); 
            return; 
        }
        Notification.requestPermission().then(p => {
            if (p === 'granted') showNotification('Notifications enabled!', 'success');
            else showNotification('Notification permission denied', 'warning');
        });
    }

    // ==================== UI UPDATES ====================
    function updateUI() {
        updateHeader();
        updateQuickStats();
        updateProgress();
        updatePendingBets();
        updateHistory();
        updateMilestones();
        updateMarkets();
        updateChart();
        updateTargets();
        updateProb();
        updateStakeField();
        updateAnalytics();
        updateStrategy();
    }

    function updateHeader() {
        document.getElementById('currentDay').textContent = `Day ${Math.min(challengeData.bets.length + 1, TARGET_DAYS)}`;
        document.getElementById('currentBalance').textContent = `¬£${challengeData.currentBalance.toFixed(2)}`;
        
        const wins = challengeData.bets.filter(b => b.status === 'won').length;
        const total = challengeData.bets.filter(b => b.status !== 'void').length;
        const winRate = total ? ((wins / total) * 100).toFixed(1) : 0;
        document.getElementById('winRate').textContent = `${winRate}%`;
        
        const active = challengeData.currentBalance > 0 && challengeData.bets.length < TARGET_DAYS;
        const complete = challengeData.currentBalance >= FINAL_TARGET;
        
        document.getElementById('challengeStatus').textContent = complete ? 'üèÜ Win!' : active ? 'üü¢ Active' : 'üî¥ Failed';
    }

    function updateQuickStats() {
        const profit = challengeData.currentBalance - INITIAL_BALANCE;
        document.getElementById('totalProfit').textContent = `¬£${profit.toFixed(2)}`;
        document.getElementById('totalProfit').className = `quick-stat-value ${profit >= 0 ? 'green' : 'red'}`;
        
        const nextTarget = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, challengeData.bets.length + 1);
        document.getElementById('targetToday').textContent = `¬£${nextTarget.toFixed(0)}`;
        
        const currentTarget = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, Math.max(challengeData.bets.length, 1));
        const ahead = challengeData.bets.length && challengeData.currentBalance > 0 
            ? Math.log(challengeData.currentBalance / currentTarget) / Math.log(TARGET_MULTIPLIER) 
            : 0;
        document.getElementById('daysAhead').textContent = ahead.toFixed(1);
        document.getElementById('daysAhead').className = `quick-stat-value ${ahead >= 0 ? 'green' : 'red'}`;
        
        const avgOdds = challengeData.bets.length 
            ? (challengeData.bets.reduce((s, b) => s + b.odds, 0) / challengeData.bets.length).toFixed(2) 
            : '1.20';
        document.getElementById('avgOdds').textContent = avgOdds;
        
        document.getElementById('remainingDays').textContent = Math.max(0, TARGET_DAYS - challengeData.bets.length);
    }

    function updateProgress() {
        const pct = (challengeData.currentBalance / FINAL_TARGET) * 100;
        document.getElementById('progressPercent').textContent = `${Math.min(pct, 100).toFixed(1)}%`;
        document.getElementById('progressFill').style.width = `${Math.max(pct, 2)}%`;
        document.getElementById('progressFill').textContent = `${pct.toFixed(1)}%`;
        
        let streak = '';
        for (let i = 1; i <= TARGET_DAYS; i++) {
            const bet = challengeData.bets.find(b => b.day === i);
            let cls = 'streak-day streak-pending';
            if (bet) {
                cls = `streak-day streak-${bet.status === 'won' ? 'won' : bet.status === 'void' ? 'void' : 'lost'}`;
            }
            if (i === challengeData.bets.length + 1) cls += ' streak-current';
            streak += `<div class="${cls}">${i}</div>`;
        }
        document.getElementById('streakDisplay').innerHTML = streak;
        
        document.getElementById('winCount').textContent = challengeData.bets.filter(b => b.status === 'won').length;
        document.getElementById('lossCount').textContent = challengeData.bets.filter(b => b.status === 'lost').length;
        
        const won = challengeData.bets.filter(b => b.status === 'won');
        document.getElementById('bestDay').textContent = won.length 
            ? `Day ${won.reduce((b, c) => (c.returns - c.stake) > (b.returns - b.stake) ? c : b).day}` 
            : '-';
        
        let winStreak = 0;
        for (let i = challengeData.bets.length - 1; i >= 0; i--) {
            if (challengeData.bets[i].status === 'won') winStreak++;
            else break;
        }
        document.getElementById('currentStreak').textContent = winStreak;
    }

    function updatePendingBets() {
        const c = document.getElementById('pendingBets');
        if (!challengeData.pendingBets.length) {
            c.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No pending bets</p></div>';
            return;
        }
        c.innerHTML = challengeData.pendingBets.map(b => `
            <div class="match-card">
                <div class="match-header">
                    <span class="match-league">${b.competition}</span>
                    <span class="match-time">${b.date}</span>
                </div>
                <div style="font-weight: 600; font-size: 0.85rem; margin-bottom: 6px;">${b.selection}</div>
                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 6px;">
                    <span style="color: var(--text-secondary);">${b.market}</span>
                    <span class="green">@ ${b.odds.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.7rem; margin-bottom: 10px;">
                    <span style="color: var(--text-secondary);">¬£${b.stake.toFixed(2)}</span>
                    <span class="blue">‚Üí ¬£${(b.stake * b.odds).toFixed(2)}</span>
                </div>
                <div class="btn-group" style="margin: 0;">
                    <button class="btn btn-success" onclick="openResultModal(${b.id})">Result</button>
                    <button class="btn btn-secondary" onclick="cancelPendingBet(${b.id})">Cancel</button>
                </div>
            </div>
        `).join('');
    }

    function updateHistory() {
        const tb = document.getElementById('historyTableBody');
        if (!challengeData.bets.length) {
            tb.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-secondary);">No bets recorded yet</td></tr>';
            return;
        }
        tb.innerHTML = challengeData.bets.map(b => `
            <tr>
                <td>${b.day}</td>
                <td>${b.date}</td>
                <td title="${b.selection}">${b.selection.substring(0, 15)}...</td>
                <td>${b.market.substring(0, 8)}</td>
                <td>${b.odds.toFixed(2)}</td>
                <td>¬£${b.stake.toFixed(0)}</td>
                <td><span class="status-badge badge-${b.status === 'won' ? 'won' : b.status === 'void' ? 'void' : 'lost'}">${b.status === 'won' ? '‚úÖ' : b.status === 'void' ? '‚ö™' : '‚ùå'}</span></td>
                <td class="${b.returns > b.stake ? 'green' : b.returns < b.stake ? 'red' : ''}">¬£${b.returns.toFixed(0)}</td>
                <td>¬£${b.balanceAfter.toFixed(0)}</td>
                <td class="${b.vsTarget >= 0 ? 'green' : 'red'}">${b.vsTarget >= 0 ? '+' : ''}${b.vsTarget.toFixed(0)}</td>
            </tr>
        `).join('');
    }

    function updateMilestones() {
        const ms = [
            { a: 500, d: 5, l: 'Safe Exit' },
            { a: 1000, d: 9, l: 'Strong Start' },
            { a: 2500, d: 14, l: 'Halfway' },
            { a: 4500, d: 17, l: 'Your Goal' },
            { a: 6500, d: 19, l: 'Excellent' },
            { a: Math.round(FINAL_TARGET), d: 21, l: 'Complete!' }
        ];
        document.getElementById('milestoneList').innerHTML = ms.map(m => {
            const reached = challengeData.currentBalance >= m.a;
            return `<li class="milestone-item">
                <div class="milestone-check ${reached ? 'milestone-reached' : 'milestone-pending'}">${reached ? '‚úì' : m.d}</div>
                <div class="milestone-info">
                    <div class="milestone-amount ${reached ? 'green' : ''}">¬£${m.a.toLocaleString()}</div>
                    <div class="milestone-day">${m.l}</div>
                </div>
            </li>`;
        }).join('');
    }

    function updateMarkets() {
        const tb = document.getElementById('marketTableBody');
        const stats = {};
        challengeData.bets.filter(b => b.status !== 'void').forEach(b => {
            if (!stats[b.market]) stats[b.market] = { t: 0, w: 0 };
            stats[b.market].t++;
            if (b.status === 'won') stats[b.market].w++;
        });
        
        if (!Object.keys(stats).length) {
            tb.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No data yet</td></tr>';
            return;
        }
        
        tb.innerHTML = Object.entries(stats).sort((a, b) => b[1].t - a[1].t).map(([m, s]) => {
            const pct = s.t ? Math.round(s.w / s.t * 100) : 0;
            return `<tr>
                <td>${m.substring(0, 12)}</td>
                <td>${s.t}</td>
                <td>${s.w}</td>
                <td class="${pct >= 50 ? 'green' : 'red'}">${pct}%</td>
            </tr>`;
        }).join('');
    }

    function updateChart() {
        const ctx = document.getElementById('balanceChart');
        if (!ctx) return;
        if (window.chartInstance) window.chartInstance.destroy();
        
        const actual = [{ x: 0, y: INITIAL_BALANCE }];
        challengeData.bets.forEach(b => actual.push({ x: b.day, y: b.balanceAfter }));
        
        const target = [];
        for (let i = 0; i <= TARGET_DAYS; i++) {
            target.push({ x: i, y: INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, i) });
        }

        window.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    { label: 'Actual', data: actual, borderColor: '#00d4aa', backgroundColor: 'rgba(0,212,170,0.1)', fill: true, tension: 0.4, pointRadius: 4 },
                    { label: 'Target', data: target, borderColor: '#54a0ff', borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: '#b0b0c0', font: { size: 10 } } } },
                scales: {
                    x: { type: 'linear', ticks: { color: '#b0b0c0', stepSize: 3, font: { size: 9 } }, grid: { color: '#333355' }, min: 0, max: TARGET_DAYS },
                    y: { ticks: { color: '#b0b0c0', font: { size: 9 }, callback: v => v >= 1000 ? (v/1000).toFixed(1) + 'k' : v }, grid: { color: '#333355' }, min: 0 }
                }
            }
        });
    }

    function updateTargets() {
        let html = '';
        for (let i = 1; i <= TARGET_DAYS; i++) {
            const t = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, i);
            const p = t - INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, i - 1);
            const bet = challengeData.bets.find(b => b.day === i);
            let style = '';
            if (bet) style = bet.status === 'won' ? 'background: rgba(0,212,170,0.1);' : 'background: rgba(255,107,107,0.1);';
            else if (i === challengeData.bets.length + 1) style = 'background: rgba(255,159,67,0.15);';
            html += `<tr style="${style}"><td>${i}</td><td>¬£${t.toFixed(0)}</td><td class="green">+¬£${p.toFixed(0)}</td></tr>`;
        }
        document.getElementById('targetsTableBody').innerHTML = html;
    }

    function updateProb() {
        const rem = TARGET_DAYS - challengeData.bets.length;
        const prob = Math.pow(0.833, rem) * 100;
        document.getElementById('successProb').textContent = `${prob.toFixed(1)}%`;
        document.getElementById('betsRemaining').textContent = rem;
        
        if (challengeData.bets.length) {
            const avg = challengeData.bets.reduce((s, b) => s + b.odds, 0) / challengeData.bets.length;
            document.getElementById('impliedProb').textContent = `${((1 / avg) * 100).toFixed(1)}%`;
        }
        
        document.getElementById('riskIndicator').style.left = `${Math.min(70 + (TARGET_DAYS - rem) * 1.5, 95)}%`;
    }

    function updateStakeField() {
        document.getElementById('stake').value = challengeData.currentBalance.toFixed(2);
        updateReturns();
    }

    function updateStrategy() {
        const day = challengeData.bets.length;
        const target = INITIAL_BALANCE * Math.pow(TARGET_MULTIPLIER, day);
        const ahead = day && challengeData.currentBalance > 0 
            ? Math.log(challengeData.currentBalance / target) / Math.log(TARGET_MULTIPLIER) 
            : 0;
        
        let strat = 'Build buffer', odds = '1.18-1.25';
        if (ahead >= 1) { strat = 'Protect lead'; odds = '1.15-1.20'; }
        else if (ahead < -0.5) { strat = 'Catch up carefully'; odds = '1.25-1.35'; }
        if (day >= 15) { strat = 'Stay conservative'; odds = '1.15-1.22'; }
        
        document.getElementById('strategyTip').textContent = strat;
        document.getElementById('recommendedOdds').textContent = odds;
    }

    function setDefaultDate() {
        document.getElementById('betDate').value = new Date().toISOString().split('T')[0];
    }

    function selectMarket(m) {
        const sel = document.getElementById('marketType');
        for (let o of sel.options) {
            if (o.value.includes(m)) {
                sel.value = o.value;
                break;
            }
        }
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        log('App initializing...');
        log(`Date: ${new Date().toISOString()}`);
        log(`API Key: ${API_FOOTBALL_KEY.substring(0, 8)}...`);
        
        loadData();
        setDefaultDate();
        updateStakeField();
        
        // Use fetchUpcomingFixtures instead of fetchTodaysFixtures
        // This uses the "next" parameter which is more reliable
        fetchUpcomingFixtures();
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(() => {});
    }
</script>
</body>
</html>